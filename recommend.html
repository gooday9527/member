<div class="recommend-wrapper">

    <div class="position-relative d-flex align-items-center mb-2" style="min-height: 38px;">

        <div class="d-flex align-items-center gap-2 recommend-controls">
            <label for="recommendSheet" class="form-label mb-0 text-nowrap">é¸æ“‡åˆ†é¡ï¼š</label>
            <select id="recommendSheet" class="form-select form-select-sm" style="max-width: 200px;">
                <option>åˆ†é¡è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <h3 class="mb-0 position-absolute top-50 start-50 translate-middle">ğŸŒŸ æ¨è–¦æ¸…å–®</h3>

    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="recommendTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script type="module">
    // 1. å¾ app.js å°å…¥æˆ‘å€‘é›†ä¸­ç®¡ç†çš„ç¶²å€ï¼Œä¸å†åœ¨é€™è£¡é‡è¤‡å®£å‘Š
    import { APP_URLS } from './app.js';

    // --- å…¨åŸŸè®Šæ•¸ ---
    let isRecommendInitialized = false;

    // --- å‡½æ•¸å®šç¾© ---

    // å‡½æ•¸ï¼šæ¸²æŸ“è¡¨æ ¼ (ä¿æŒä¸è®Šï¼Œä½†æ›´å¥å£¯)
    function renderRecommendTable(data) {
        const tableElement = document.getElementById('recommendTable');
        if (!tableElement) return;

        const thead = tableElement.querySelector('thead');
        const tbody = tableElement.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">é€™å€‹åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>';
            return;
        }

        const headers = Object.keys(data[0]);
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        tbody.innerHTML = data.map(row => `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`).join('');
    }

    // å‡½æ•¸ï¼šé€é fetch è¼‰å…¥è³‡æ–™ (å‡ç´šï¼)
    async function loadRecommendData(sheetName) {
        const tbody = document.querySelector('#recommendTable tbody');
        if (!tbody) return;
        tbody.innerHTML = `<tr><td colspan="100%">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;

        try {
            const params = new URLSearchParams({
                action: 'getRecommendations',
                sheetName: sheetName
            });
            
            // ä½¿ç”¨ fetchï¼Œä¸¦å¾ APP_URLS å–å¾—ç¶²å€
            const response = await fetch(`${APP_URLS.recommend}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${response.status}`);
            }

            const result = await response.json();
            if (result.status === 'error') {
                throw new Error(result.data.message);
            }

            renderRecommendTable(result.data.data);

        } catch (error) {
            console.error('è¼‰å…¥æ¨è–¦è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">è³‡æ–™è¼‰å…¥å¤±æ•—</td></tr>`;
        }
    }
    
    // ä¸»åˆå§‹åŒ–å‡½æ•¸ (ç°¡åŒ–ä¸¦å‡ç´šï¼)
    async function initializeRecommendPage() {
        if (isRecommendInitialized) return;
        isRecommendInitialized = true;

        const selectElement = document.getElementById('recommendSheet');
        if (!selectElement) {
            console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° recommendSheet ä¸‹æ‹‰é¸å–®ã€‚");
            return;
        }

        selectElement.disabled = true;
        selectElement.innerHTML = '<option>åˆ†é¡è¼‰å…¥ä¸­...</option>';

        try {
            const params = new URLSearchParams({ action: 'getRecommendationCategories' });
            const response = await fetch(`${APP_URLS.recommend}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${response.status}`);
            }

            const result = await response.json();
            if (result.status === 'error') {
                throw new Error(result.data.message);
            }

            const categories = result.data.categories;
            selectElement.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            
            selectElement.disabled = false;
            selectElement.addEventListener('change', function () {
                loadRecommendData(this.value);
            });

            if (categories.length > 0) {
                await loadRecommendData(categories[0]); // è¼‰å…¥ç¬¬ä¸€å€‹åˆ†é¡çš„è³‡æ–™
            }

        } catch (error) {
            console.error('è¼‰å…¥åˆ†é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            selectElement.innerHTML = `<option>åˆ†é¡è¼‰å…¥å¤±æ•—</option>`;
        }
    }

    // --- å•Ÿå‹•é‚è¼¯ ---
    // ä½¿ç”¨ module é¡å‹ï¼Œå¯ä»¥ç›´æ¥å‘¼å«ï¼Œä¸éœ€è¦ DOMContentLoaded æª¢æŸ¥
    initializeRecommendPage();
</script>
