<!-- add-account-shares.html (åµéŒ¯ç‰ˆ) -->

<!-- æ‚¨çš„ HTML å’Œ CSS å®Œå…¨ä¸è®Š -->
<div style="max-width: 500px; margin: 2rem auto;">
    <h3 class="text-center">ğŸ“Š æ–°å¢å¸³è™Ÿï¼æŒè‚¡</h3>
    <div class="mb-3">
        <label for="subAccountSelect" class="form-label">é¸æ“‡æˆ–æ–°å¢å­å¸³è™Ÿ</label>
        <div class="input-group">
            <select class="form-select" id="subAccountSelect">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="window.addAccountShares.toggleSubAccountInput(true)">â• æ–°å¢</button>
        </div>
    </div>
    <div id="addSubWrapper" class="mb-3" style="display:none;">
        <label for="newSubAccountInput" class="form-label">æ–°å­å¸³è™Ÿåç¨±</label>
        <input type="text" class="form-control" id="newSubAccountInput" placeholder="è«‹è¼¸å…¥å­å¸³è™Ÿåç¨±">
        <div class="mt-2 d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-sm btn-secondary" onclick="window.addAccountShares.toggleSubAccountInput(false)">å–æ¶ˆ</button>
            <button type="button" class="btn btn-sm btn-primary" onclick="window.addAccountShares.saveNewSubAccount()">å„²å­˜</button>
        </div>
    </div>
    <div class="mb-3">
        <label for="stockInput" class="form-label">è¼¸å…¥è‚¡è™Ÿ (ç”¨é€—è™Ÿåˆ†éš”)</label>
        <textarea id="stockInput" class="form-control" rows="4" placeholder="ä¾‹å¦‚ï¼š1101, 1102, 2330"></textarea>
    </div>
    <div class="mb-3">
        <label class="form-label">é¸æ“‡æ“ä½œé¡å‹</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opAdd" value="add" checked>
            <label class="form-check-label" for="opAdd">æ–°å¢ä¸Šåˆ—æŒè‚¡ (è¿½åŠ )</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opOverwrite" value="overwrite">
            <label class="form-check-label" for="opOverwrite">ä¸Šåˆ—æŒè‚¡è¦†è“‹åŸæœ¬æŒè‚¡ (æ¸…ç©ºå¾Œå¯«å…¥)</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opDelete" value="delete">
            <label class="form-check-label" for="opDelete">åˆªé™¤ä¸Šåˆ—æŒè‚¡ (å¾ç¾æœ‰æ¸…å–®ç§»é™¤)</label>
        </div>
    </div>
    <button class="btn btn-success w-100 mt-3" onclick="window.addAccountShares.executeOperation()">åŸ·è¡Œæ“ä½œ</button>
    <div id="messageBox" class="mt-3"></div>
</div>

<!-- âœ…ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨è…³æœ¬ä¸­åŠ å…¥ console.log ä¾†è¿½è¹¤å•é¡Œ -->
<script>
    window.addAccountShares = (function() {
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzk_RKeBgLtWsVJe79WUIYklyOnLL94nVZ41rb_zG_bV-LOSsi9PtSHQX0H0a2hMId0/exec";

        async function fetchDataFromBackend(action, payload = {}) {
            const userEmail = window.currentUserEmail;
            
            // âœ… ç›£è¦–å™¨ 1: æª¢æŸ¥æˆ‘å€‘æ˜¯ç”¨å“ªå€‹ Email å»è¦è³‡æ–™çš„
            console.log(`[åµéŒ¯] æº–å‚™ç™¼é€è«‹æ±‚... Action: ${action}, Email: ${userEmail}`);

            if (!userEmail) {
                displayMessage("éŒ¯èª¤ï¼šç„¡æ³•ç²å–ç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚", "danger");
                throw new Error("User not logged in");
            }
            
            const fullPayload = { action, userEmail, ...payload };
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(fullPayload),
            });

            // âœ… ç›£è¦–å™¨ 2: çœ‹çœ‹å¾Œç«¯åŸå§‹å›å‚³çš„æ–‡å­—æ˜¯ä»€éº¼
            const rawResponseText = await response.text();
            console.log('[åµéŒ¯] å¾å¾Œç«¯æ”¶åˆ°çš„åŸå§‹å›æ‡‰:', rawResponseText);

            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            
            // âœ… ç›£è¦–å™¨ 3: çœ‹çœ‹è§£æå¾Œçš„ JSON è³‡æ–™é•·ä»€éº¼æ¨£å­
            const result = JSON.parse(rawResponseText);
            console.log('[åµéŒ¯] è§£æå¾Œçš„ JSON è³‡æ–™:', result);

            if (result.status === "error") throw new Error(result.data.message || "å¾Œç«¯è™•ç†éŒ¯èª¤");
            
            // âœ… ç›£è¦–å™¨ 4: çœ‹çœ‹æœ€çµ‚è¦çµ¦å‰ç«¯ç”¨çš„è³‡æ–™æ˜¯ä»€éº¼
            console.log('[åµéŒ¯] æœ€çµ‚æˆåŠŸå–å¾—çš„è³‡æ–™ (result.data):', result.data);
            return result.data;
        }

        function displayMessage(msg, type) { /* ... æ‚¨çš„ displayMessage å‡½æ•¸ ... */ }

        async function loadInitialData(accountToSelect = null) {
            const select = document.getElementById("subAccountSelect");
            try {
                // å‘¼å«å¸¶æœ‰ç›£è¦–å™¨çš„ fetch å‡½æ•¸
                const data = await fetchDataFromBackend("getAccountData");
                
                const accounts = data.accounts || [];
                select.innerHTML = '<option value="">è«‹é¸æ“‡å­å¸³è™Ÿ</option>';
                
                if (accounts.length > 0) {
                    accounts.forEach(name => {
                        const opt = document.createElement("option");
                        opt.value = opt.textContent = name;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">å°šç„¡å­å¸³è™Ÿï¼Œè«‹å…ˆæ–°å¢</option>';
                }
                
                if (accountToSelect && accounts.includes(accountToSelect)) {
                    select.value = accountToSelect;
                }
            } catch (e) {
                console.error("[åµéŒ¯] loadInitialData æ•æ‰åˆ°éŒ¯èª¤:", e);
                select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸»æ§å°</option>';
                displayMessage("è¼‰å…¥å¸³è™Ÿè³‡æ–™å¤±æ•—ï¼š" + e.message, "danger");
            }
        }

        // ç«‹å³åŸ·è¡Œåˆå§‹åŒ–
        setTimeout(loadInitialData, 0);

        // è¿”å›éœ€è¦è¢« HTML onclick å‘¼å«çš„å‡½æ•¸
        return {
            toggleSubAccountInput: function(show) { /* ... æ‚¨çš„ toggle å‡½æ•¸ ... */ },
            saveNewSubAccount: async function() { /* ... æ‚¨çš„ save å‡½æ•¸ ... */ },
            executeOperation: async function() { /* ... æ‚¨çš„ execute å‡½æ•¸ ... */ }
        };
    })();
</script>
