<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

<div class="container-fluid mt-2">
    <h2 class="mb-3">ğŸ“¥ å¯å§”è¨—ä»£é ˜æ¸…å–®</h2>
    <p class="text-muted">å¯ä»¥å§”è¨—ä»£é ˜çš„è‚¡æ±æœƒç´€å¿µå“ã€‚</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>è‚¡è™Ÿ</th>
                            <th>è‚¡å</th>
                            <th>é›»æŠ•é–‹å§‹æ—¥</th>
                            <th>å§”è¨—æˆªæ­¢æ—¥</th>
                            <th>å§”è¨—æ¢ä»¶</th>
                            <th class="text-center">æŒæœ‰å¸³è™Ÿæ•¸</th>
                            <th class="text-center">å·²å§”è¨—æ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>å§“å</th>
                        <th>è­‰ä»¶ç‹€æ…‹</th>
                        <th class="text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>

<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const email = window.currentUserEmail; // å¾ä¸» app.js ç²å–ç•¶å‰ç™»å…¥çš„ç”¨æˆ¶ Email
        if (!email) {
            $('#delegableTable').html('<tr><td colspan="7" class="text-center alert alert-danger">è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ‚¨çš„å§”è¨—æ¸…å–®ã€‚</td></tr>');
            return;
        }

        const table = new DataTable('#delegableTable', {
            ajax: function (data, callback, settings) {
                // åœ¨ DataTables è¼‰å…¥æ•¸æ“šæ™‚é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
                $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center p-4">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>');
                
                // èª¿ç”¨å¾Œç«¯ Apps Script ä¸­çš„ getDelegableListData å‡½æ•¸ä¾†ç²å–æ•¸æ“š
                // æ³¨æ„ï¼šgetDelegableListData(email) æ˜¯ Apps Script Code.gs è£¡çš„ä¸€å€‹é ‚å±¤å‡½æ•¸
                google.script.run
                    .withSuccessHandler(function (response) {
                        // å¾Œç«¯å›å‚³çš„ response æ‡‰è©²æ˜¯ { data: [...], status: "success", appSettings: {...} }
                        if (response.status === "success") {
                            // å°† appSettings å­˜å„²åˆ°ä¸€å€‹å¯è¨ªå•çš„åœ°æ–¹ï¼Œä¾‹å¦‚å…¨å±€è®Šæ•¸æˆ– jQuery data
                            // é€™è£¡æˆ‘å€‘æš«æ™‚æŠŠå®ƒä½œç‚º callback çš„é¡å¤–åƒæ•¸å‚³éçµ¦ DataTables
                            // DataTables çš„ callback åªæœŸæœ› data å±¬æ€§ï¼Œæ‰€ä»¥æˆ‘å€‘é¡å¤–å­˜å„²
                            settings.ajax.appSettings = response.appSettings; // å°‡è¨­å®šå„²å­˜åˆ° settings.ajax ä¸­

                            callback(response); // å°‡æ•¸æ“šå‚³éçµ¦ DataTables é€²è¡Œæ¸²æŸ“ (DataTables æœƒè‡ªå‹•è™•ç† response.data)
                        } else {
                            console.error("å¾Œç«¯å›å‚³éŒ¯èª¤:", response.message);
                            settings.oInstance.api().clear().draw(); // æ¸…ç©ºè¡¨æ ¼
                            $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center alert alert-danger">' + (response.message || 'è³‡æ–™è¼‰å…¥å¤±æ•—') + '</td></tr>');
                        }
                    })
                    .withFailureHandler(function (error) {
                        // è™•ç†å¾Œç«¯èª¿ç”¨å¤±æ•—çš„æƒ…æ³
                        console.error("å‘¼å«å¾Œç«¯å¤±æ•—:", error);
                        settings.oInstance.api().clear().draw(); // æ¸…ç©ºè¡¨æ ¼
                        $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center alert alert-danger">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚</td></tr>');
                    })
                    .getDelegableListData(email); // ç›´æ¥èª¿ç”¨é ‚å±¤å‡½æ•¸ä¸¦å‚³é email
            },
            columns: [
                { data: 'stockCode' },
                { data: 'stockName' },
                { data: 'eVotingStartDate' },
                { data: 'delegationDeadline' },
                { data: 'delegationConditions' },
                {
                    data: 'totalHoldingAccounts',
                    className: 'text-center',
                    // è‡ªè¨‚ã€ŒæŒæœ‰å¸³è™Ÿæ•¸ã€æ¬„ä½çš„é¡¯ç¤ºå…§å®¹ï¼Œå¢åŠ é»æ“ŠæŒ‰éˆ•
                    render: function (data, type, row) {
                        if (data > 0) {
                            // å°‡è©²è¡Œçš„è©³ç´°è³‡æ–™ (holdingsDetail) è½‰æˆ JSON å­—ä¸²å¾Œï¼Œå­˜åœ¨æŒ‰éˆ•çš„ data-details å±¬æ€§ä¸­
                            // åŒæ™‚ä¹Ÿå°‡è©²å…¬å¸çš„å§”è¨—æ¢ä»¶å‚³å…¥ï¼Œä¾› Modal å…§éƒ¨çš„é‚è¼¯ä½¿ç”¨
                            return `<button class="btn btn-sm btn-outline-primary view-details-btn"
                                            data-details='${JSON.stringify(row.holdingsDetail)}'
                                            data-company="${row.stockName} (${row.stockCode})"
                                            data-conditions="${row.delegationConditions}">
                                        ${data}
                                    </button>`;
                        }
                        return data; // å¦‚æœæŒæœ‰å¸³è™Ÿæ•¸ç‚º 0ï¼Œå‰‡åªé¡¯ç¤ºæ•¸å­—
                    }
                },
                { data: 'delegatedAccounts', className: 'text-center' }
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/zh-HANT.json' // DataTables ä¸­æ–‡åŒ–
            },
            responsive: true, // å•Ÿç”¨éŸ¿æ‡‰å¼è¨­è¨ˆ
            order: [[3, 'asc']] // é è¨­ä½¿ç”¨ç¬¬ 4 æ¬„ (å§”è¨—æˆªæ­¢æ—¥) é€²è¡Œå‡å†ªæ’åº
        });

        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        // ä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œç›£è½è¡¨æ ¼ tbody ä¸­é»æ“Šã€ŒæŒæœ‰å¸³è™Ÿæ•¸ã€æŒ‰éˆ•çš„äº‹ä»¶
        $('#delegableTable tbody').on('click', '.view-details-btn', function () {
            const details = JSON.parse($(this).attr('data-details')); // ç²å–æŒæœ‰å¸³è™Ÿçš„è©³ç´°è³‡è¨Š
            const companyName = $(this).attr('data-company'); // ç²å–å…¬å¸åç¨±å’Œè‚¡è™Ÿ
            const delegationConditions = $(this).attr('data-conditions'); // ç²å–è©²å…¬å¸çš„å§”è¨—æ¢ä»¶

            // âœ… ç²å– DataTables å¯¦ä¾‹ä¸­å„²å­˜çš„ appSettings
            const appSettings = table.ajax.appSettings || { isDelegationAcquisitionEnabled: true }; // å¦‚æœæ²’æœ‰ç²å–åˆ°ï¼Œé è¨­å•Ÿç”¨

            $('#modalCompanyName').text(companyName); // è¨­å®š Modal æ¨™é¡Œä¸­çš„å…¬å¸åç¨±
            const modalTableBody = $('#modalTableBody');
            modalTableBody.empty(); // æ¸…ç©º Modal è¡¨æ ¼èˆŠçš„æ˜ç´°å…§å®¹

            details.forEach(account => {
                let actionHtml = ''; // ç”¨æ–¼å­˜æ”¾æ“ä½œæŒ‰éˆ•æˆ–ç‹€æ…‹å¾½ç« çš„ HTML
                
                // 1. æœ€é«˜å„ªå…ˆç´šï¼šåˆ¤æ–·æ˜¯å¦å·²å§”è¨—
                if (account.isDelegated) {
                    actionHtml = '<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate" data-account-name="${account.accountName}">å–æ¶ˆå§”è¨—</button>'; // "å–æ¶ˆå§”è¨—" æŒ‰éˆ•
                } else {
                    // 2. åˆ¤æ–·è­‰ä»¶æ˜¯å¦ç¬¦åˆå§”è¨—æ¢ä»¶
                    let isDocumentMatch = true; // é è¨­ç¬¦åˆ
                    const docType = String(account.documentType || '').trim(); // ç¢ºä¿è­‰ä»¶é¡å‹æ˜¯å­—ä¸²ä¸”å»é™¤ç©ºæ ¼

                    // åˆ¤æ–·å§”è¨—æ¢ä»¶æ˜¯å¦åŒ…å«ç‰¹å®šè­‰ä»¶è¦æ±‚
                    const requiresIDSpecific = delegationConditions.includes("èº«åˆ†è­‰æ­£æœ¬");
                    const requiresCertSpecific = delegationConditions.includes("è­‰ä»¶æ­£æœ¬"); // åŒ…å«èº«åˆ†è­‰æˆ–å¥ä¿å¡

                    if (requiresIDSpecific) {
                        // å§”è¨—æ¢ä»¶è¦æ±‚ã€Œèº«åˆ†è­‰æ­£æœ¬ã€
                        if (docType !== "èº«åˆ†è­‰") {
                            isDocumentMatch = false;
                        }
                    } else if (requiresCertSpecific) {
                        // å§”è¨—æ¢ä»¶è¦æ±‚ã€Œè­‰ä»¶æ­£æœ¬ã€ï¼ˆèº«åˆ†è­‰æˆ–å¥ä¿å¡ï¼‰
                        if (docType !== "èº«åˆ†è­‰" && docType !== "å¥ä¿å¡") {
                            isDocumentMatch = false;
                        }
                    }
                    // å¦å‰‡ï¼Œå¦‚æœå§”è¨—æ¢ä»¶ä¸åŒ…å«é€™å…©ç¨®ç‰¹å®šæ–‡å­—ï¼ŒisDocumentMatch ä¿æŒ true (ä¸€å¾‹ç¬¦åˆ)

                    if (isDocumentMatch) {
                        // è­‰ä»¶ç¬¦åˆå§”è¨—æ¢ä»¶
                        // æ ¹æ“šç®¡ç†å“¡è¨­å®šåˆ¤æ–·æ˜¯å¦é¡¯ç¤ºå§”è¨—/æ”¶è³¼åŠŸèƒ½
                        if (appSettings.isDelegationAcquisitionEnabled) { // âœ… æ ¹æ“šå¾Œç«¯è¨­å®šæ§åˆ¶åŠŸèƒ½é¡¯ç¤º
                            const requiresMailNotice = delegationConditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘");
                            let delegateButtonText = 'å§”è¨—'; // ç°¡æ½”æ–‡å­—
                            if (requiresMailNotice) {
                                delegateButtonText = 'å§”è¨— (éœ€å¯„å–®)'; // ç°¡æ½”æ–‡å­— + æç¤º
                            }

                            actionHtml = `
                                <button class="btn btn-primary btn-sm action-btn me-1" data-action="delegate" data-account-name="${account.accountName}" data-company-name="${companyName}" data-is-requires-mail="${requiresMailNotice}">
                                    ${delegateButtonText}
                                </button>
                                <button class="btn btn-info btn-sm action-btn" data-action="acquire" data-account-name="${account.accountName}" data-company-name="${companyName}">
                                    æ”¶è³¼
                                </button>
                            `;
                        } else {
                            // åŠŸèƒ½è¢«ç®¡ç†å“¡ç¦ç”¨
                            actionHtml = '<span class="badge bg-secondary">åŠŸèƒ½ç¶­è­·ä¸­</span>';
                        }
                    } else {
                        // è­‰ä»¶ä¸ç¬¦åˆå§”è¨—æ¢ä»¶
                        actionHtml = '<span class="badge bg-danger" title="è­‰ä»¶ä¸ç¬¦åˆå§”è¨—æ¢ä»¶">X (ä¸å¯æ“ä½œ)</span>';
                    }
                }

                // å°‡ç”Ÿæˆçš„ HTML åŠ å…¥åˆ° Modal è¡¨æ ¼çš„è¡Œä¸­
                const rowHtml = `<tr>
                                    <td>${account.accountName}</td>
                                    <td>${account.documentType || 'æœªæä¾›'}</td>
                                    <td class="text-center">${actionHtml}</td>
                                </tr>`;
                modalTableBody.append(rowHtml);
            });

            detailsModal.show(); // é¡¯ç¤º Modal å½ˆå‡ºè¦–çª—
        });

        // ç›£è½ Modal å…§éƒ¨ã€Œå§”è¨—ã€/ã€Œæ”¶è³¼ã€/ã€Œå–æ¶ˆå§”è¨—ã€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
        $('#modalTableBody').on('click', '.action-btn', function () {
            const actionType = $(this).data('action'); // 'delegate', 'acquire', 'cancel-delegate'
            const accountName = $(this).data('account-name');
            const companyName = $(this).data('company-name');
            const requiresMailNotice = $(this).data('is-requires-mail'); // åƒ…å§”è¨—æŒ‰éˆ•æœ‰æ­¤å±¬æ€§

            // é€™è£¡å°‡è§¸ç™¼å¾Œç«¯çš„å¯¦éš›æ“ä½œ API
            if (actionType === 'delegate') {
                if (requiresMailNotice) {
                    alert(`æ¨¡æ“¬ï¼šé€™æ˜¯ã€Œéœ€å¯„å–®ã€å§”è¨—ã€‚\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
                    // google.script.run.withSuccessHandler(...).withFailureHandler(...).requestMailNoticeDelegate(companyName, accountName, email);
                } else {
                    alert(`æ¨¡æ“¬ï¼šåŸ·è¡Œã€Œå§”è¨—ã€æ“ä½œï¼\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
                    // google.script.run.withSuccessHandler(...).withFailureHandler(...).delegateStock(companyName, accountName, email);
                }
            } else if (actionType === 'acquire') {
                alert(`æ¨¡æ“¬ï¼šåŸ·è¡Œã€Œæ”¶è³¼ã€æ“ä½œï¼\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
                // google.script.run.withSuccessHandler(...).withFailureHandler(...).acquireStock(companyName, accountName, email);
            } else if (actionType === 'cancel-delegate') {
                alert(`æ¨¡æ“¬ï¼šåŸ·è¡Œã€Œå–æ¶ˆå§”è¨—ã€æ“ä½œï¼\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
                // google.script.run.withSuccessHandler(...).withFailureHandler(...).cancelDelegate(companyName, accountName, email);
            }

            detailsModal.hide(); // é»æ“Šå¾Œé—œé–‰ Modal
        });
    });
</script>
