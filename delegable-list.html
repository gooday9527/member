<style>
  /* å›ºå®šè¡¨æ ¼ä½ˆå±€ï¼Œè®“å¯¬åº¦è¨­å®šç”Ÿæ•ˆ */
  #delegableListTable {
    table-layout: fixed; /* âœ… ä¿®æ­£ç‚ºæ­£ç¢ºçš„ 'fixed' */
    word-wrap: break-word;
    width: 100%;
    box-sizing: border-box; 
  }
  #delegableListTable th, 
  #delegableListTable td {
    box-sizing: border-box;
  }
  
  /* ä¿æŒè¡¨é ­ä¸æ›è¡Œ */
  #delegableListTable thead th {
    white-space: nowrap;
  }

  /* è¨­å®šå€‹åˆ¥æ¬„ä½çš„å¯¬åº¦ */
  #delegableListTable th:nth-child(1) { width: 8%; }  /* è‚¡è™Ÿ */
  #delegableListTable th:nth-child(2) { width: 15%; } /* è‚¡å */
  #delegableListTable th:nth-child(3) { width: 13%; } /* é›»æŠ•é–‹å§‹æ—¥ */
  #delegableListTable th:nth-child(4) { width: 13%; } /* å§”è¨—æˆªæ­¢æ—¥ */
  #delegableListTable th:nth-child(5) { width: 30%; } /* å§”è¨—æ¢ä»¶ */
  #delegableListTable th:nth-child(6) { width: 11%; } /* æŒæœ‰å¸³è™Ÿæ•¸ */
  #delegableListTable th:nth-child(7) { width: 10%; } /* å·²å§”è¨—æ•¸ */
</style>

<div class="souvenir-wrapper pt-2 pb-2 pt-md-0 pb-md-0">
    <div class="d-block d-md-flex align-items-center gap-3 mb-2 mb-md-0 px-3" id="delegableControlsContainer">
        </div>
    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="delegableListTable">
            <thead class="table-warning"></thead>
            <tbody><tr><td colspan="7" class="text-center p-4">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            </td></tr></tbody>
        </table>
    </div>
    <div id="delegablePaginationWrapper" class="mt-2">
        <div id="delegablePagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
                <div class="table-responsive">
                    <table class="table table-bordered"><thead class="table-light"><tr><th>å§“å</th><th>è­‰ä»¶ç‹€æ…‹</th><th class="text-center">æ“ä½œ</th></tr></thead><tbody id="modalTableBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxMhYweDStNeqK-y3Rb8eEupmO6H9dX_UQ8wdOz5B605kkTiZgcchIfEZPYNxAgrtCk/exec';

    const email = window.currentUserEmail;
    if (!email) {
        document.querySelector('#delegableListTable tbody').innerHTML = '<tr><td colspan="7" class="text-center text-danger p-4">è«‹å…ˆç™»å…¥</td></tr>';
        return;
    }

    // ç‹€æ…‹è®Šæ•¸
    let rawData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
    let sortKey = 'eVotingStartDate', sortAsc = false; // âœ… æ”¹ç‚ºé è¨­æŒ‰ã€Œé›»æŠ•é–‹å§‹æ—¥ã€æ’åº
    let appSettings = { isDelegationAcquisitionEnabled: true };
    let detailsModal;

    // æ¬„ä½è¨­å®š (å¾Œç«¯key vs å‰ç«¯title)
    const columnConfig = [
        { key: 'stockCode',            title: 'è‚¡è™Ÿ' },
        { key: 'stockName',            title: 'è‚¡å' },
        { key: 'eVotingStartDate',     title: 'é›»æŠ•é–‹å§‹æ—¥' },
        { key: 'delegationDeadline',   title: 'å§”è¨—æˆªæ­¢æ—¥' },
        { key: 'delegationConditions', title: 'å§”è¨—æ¢ä»¶' },
        { key: 'totalHoldingAccounts', title: 'æŒæœ‰å¸³è™Ÿæ•¸' },
        { key: 'delegatedAccounts',    title: 'å·²å§”è¨—æ•¸' }
    ];

    // DOM å…ƒç´ 
    const tblHead = document.querySelector('#delegableListTable thead');
    const tblBody = document.querySelector('#delegableListTable tbody');
    const controlsContainer = document.getElementById('delegableControlsContainer');
    const pagContainer = document.getElementById('delegablePagination');
    const modalTitle = document.getElementById('modalCompanyName');
    const modalBody = document.getElementById('modalTableBody');

    // æ³¨å…¥æ§åˆ¶é …
    if (controlsContainer) {
        controlsContainer.innerHTML = `
        <div class="d-flex flex-column flex-sm-row justify-content-sm-start align-items-sm-center w-100">
            <h3 class="mb-2 mb-sm-0 me-sm-4" style="white-space: nowrap;">ğŸ“¥ å¯å§”è¨—æ¸…å–®</h3>
            <div class="d-flex align-items-center gap-2 flex-nowrap">
                <div class="d-flex align-items-center">
                    <label for="delegRowsPerPage" class="form-label mb-0 me-1">ç­†æ•¸:</label>
                    <select id="delegRowsPerPage" class="form-select form-select-sm" style="width: 80px;"><option>10</option><option>25</option><option>50</option><option>100</option></select>
                </div>
                <div class="d-flex align-items-center">
                    <label for="delegSearchInput" class="form-label mb-0 me-1">æœå°‹:</label>
                    <input type="text" id="delegSearchInput" class="form-control form-control-sm" style="width: 150px;" placeholder="é—œéµå­—...">
                </div>
            </div>
        </div>`;
        document.getElementById('delegRowsPerPage').addEventListener('change', (e)=>{ rowsPerPage = +e.target.value; currentPage = 1; renderTable(); });
        document.getElementById('delegSearchInput').addEventListener('input', ()=>{ currentPage = 1; filterData(); renderTable(); });
    }
    
    // ç²å–è³‡æ–™
    const apiUrl = `${WEB_APP_URL}?view=getDelegableList&email=${encodeURIComponent(email)}`;
    fetch(apiUrl)
        .then(response => response.ok ? response.json() : Promise.reject('ç¶²è·¯å›æ‡‰éŒ¯èª¤'))
        .then(response => {
            if (!response.success || !response.data) throw new Error(response.message || 'å¾Œç«¯å›å‚³è³‡æ–™æ ¼å¼ä¸ç¬¦');
            rawData = response.data || [];
          // âœ… è«‹åœ¨é€™è£¡åŠ ä¸Šä¸‹é¢é€™ä¸€è¡ŒåµéŒ¯ç¢¼
          if (rawData.length > 0) { console.log("ã€åµéŒ¯ã€‘ç¬¬ä¸€ç­†è³‡æ–™çš„æ¨£å­:", rawData[0]); }

            appSettings = response.appSettings || appSettings;
            renderHeader();
            sortTable(sortKey); // åˆå§‹æ’åº
        })
        .catch(err => { 
            console.error('API å‘¼å«å¤±æ•—:', err);
            tblBody.innerHTML=`<tr><td colspan="7" class="text-center text-danger p-4">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</td></tr>`; 
        });

    function sortTable(key) {
        sortAsc = (sortKey === key) ? !sortAsc : true;
        sortKey = key;
        sortData();
        filterData();
        renderTable();
    }
    
    function sortData() {
        const isDate = (s) => /^\d{2,4}[-/]\d{2}[-/]\d{2}$/.test(String(s).trim());
        const isPureNumeric = (s) => /^-?\d+(\.\d+)?$/.test(String(s).trim());
        rawData.sort((a,b) => {
            const valA = a[sortKey] || '', valB = b[sortKey] || '';
            if (isPureNumeric(valA) && isPureNumeric(valB)) return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
            if (isDate(valA) && isDate(valB)) {
                const sortableDateA = String(valA).replace(/[-/]/g, '').slice(-4);
                const sortableDateB = String(valB).replace(/[-/]/g, '').slice(-4);
                return sortAsc ? sortableDateA.localeCompare(sortableDateB) : sortableDateB.localeCompare(sortableDateA);
            }
            return sortAsc ? String(valA).localeCompare(valB, 'zh-Hant') : String(valB).localeCompare(valA, 'zh-Hant');
        });
    }

    function filterData() {
        const keyword = document.getElementById('delegSearchInput').value.trim().toLowerCase();
        filteredData = keyword ? rawData.filter(r => columnConfig.some(c => String(r[c.key]||'').toLowerCase().includes(keyword))) : [...rawData];
    }

    function renderHeader() {
        tblHead.innerHTML = '<tr>' + columnConfig.map(c => `<th class="sortable" data-key="${c.key}" style="cursor:pointer;">${c.title} <i class="fa-solid fa-sort sort-indicator"></i></th>`).join('') + '</tr>';
        tblHead.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => sortTable(th.dataset.key)));
    }
    
    function renderTable() {
        tblHead.querySelectorAll('.sort-indicator').forEach(icon => {
            icon.className = 'fa-solid fa-sort sort-indicator';
            icon.style.color = '#aaa';
        });
        const activeIcon = tblHead.querySelector(`th[data-key="${sortKey}"] .sort-indicator`);
        if (activeIcon) {
            activeIcon.className = sortAsc ? 'fa-solid fa-sort-up sort-indicator' : 'fa-solid fa-sort-down sort-indicator';
            activeIcon.style.color = 'black';
        }
        const start = (currentPage - 1) * rowsPerPage;
        const pageData = filteredData.slice(start, start + rowsPerPage);
        tblBody.innerHTML = pageData.length ? pageData.map(row => {
            const cells = columnConfig.map(c => {
                let value = row[c.key] ?? '';
                let className = ['totalHoldingAccounts', 'delegatedAccounts'].includes(c.key) ? 'text-center' : '';
                if (c.key === 'totalHoldingAccounts' && value > 0) {
                    return `<td class="${className}"><button class="btn btn-sm btn-outline-primary view-details-btn">${value}</button></td>`;
                }
                return `<td class="${className}">${value}</td>`;
            }).join('');
            return `<tr data-row-details='${JSON.stringify(row)}'>${cells}</tr>`;
        }).join('') : `<tr><td colspan="${columnConfig.length}" class="text-center p-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
        tblBody.querySelectorAll('.view-details-btn').forEach(btn => btn.addEventListener('click', e => showDetailsModal(JSON.parse(e.currentTarget.closest('tr').dataset.rowDetails))));
        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
        pagContainer.innerHTML = '';
        if (totalPages <= 1) return;
        let pageButtons = [];
        pageButtons.push(`<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="window.delegableTable.changePage(-1)">ä¸Šé </button>`);
        let startPage = Math.max(1, currentPage - 2), endPage = Math.min(totalPages, currentPage + 2);
        if (startPage > 1) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="window.delegableTable.goToPage(1)">1</button>`);
        if (startPage > 2) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
        for (let i = startPage; i <= endPage; i++) {
            pageButtons.push(`<button class="btn btn-sm me-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}" onclick="window.delegableTable.goToPage(${i})">${i}</button>`);
        }
        if (endPage < totalPages - 1) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
        if (endPage < totalPages) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="window.delegableTable.goToPage(${totalPages})">${totalPages}</button>`);
        pageButtons.push(`<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="window.delegableTable.changePage(1)">ä¸‹é </button>`);
        pagContainer.innerHTML = pageButtons.join('');
    }

    function showDetailsModal(rowData) {
        if (!detailsModal) detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modalTitle.textContent = `${rowData.stockName} (${rowData.stockCode})`;
        modalBody.innerHTML = rowData.holdingsDetail.map(account => {
            let actionHtml;
            if (account.isDelegated) {
                actionHtml = `<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate">å–æ¶ˆå§”è¨—</button>`;
            } else {
                let isMatch = true;
                const docType = account.documentType || '';
                if (rowData.delegationConditions.includes("èº«åˆ†è­‰æ­£æœ¬") && docType !== "èº«åˆ†è­‰") isMatch = false;
                if (rowData.delegationConditions.includes("è­‰ä»¶æ­£æœ¬") && !["èº«åˆ†è­‰", "å¥ä¿å¡"].includes(docType)) isMatch = false;
                if (isMatch && appSettings.isDelegationAcquisitionEnabled) {
                    const btnText = rowData.delegationConditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘") ? 'å§”è¨— (éœ€å¯„å–®)' : 'å§”è¨—';
                    actionHtml = `<button class="btn btn-primary btn-sm me-1 action-btn" data-action="delegate">${btnText}</button><button class="btn btn-info btn-sm action-btn" data-action="acquire">æ”¶è³¼</button>`;
                } else {
                    actionHtml = `<span class="badge bg-${isMatch ? 'secondary' : 'danger'}">${isMatch ? 'åŠŸèƒ½ç¶­è­·ä¸­' : 'è­‰ä»¶ä¸ç¬¦'}</span>`;
                }
            }
            return `<tr><td>${account.accountName}</td><td>${account.documentType||'æœªæä¾›'}</td><td class="text-center" data-company-name="${modalTitle.textContent}" data-account-name="${account.accountName}">${actionHtml}</td></tr>`;
        }).join('');
        detailsModal.show();
    }
    
    document.getElementById('detailsModal').addEventListener('click', e => {
        if(e.target.classList.contains('action-btn')){
            const target = e.target, cell = target.closest('td');
            alert(`æ¨¡æ“¬æ“ä½œï¼š\né¡å‹: ${target.dataset.action}\nå…¬å¸: ${cell.dataset.companyName}\nå¸³è™Ÿ: ${cell.dataset.accountName}`);
            detailsModal.hide();
        }
    });

    window.delegableTable = {
        changePage: offset => { currentPage = Math.min(Math.max(1, currentPage + offset), Math.ceil(filteredData.length / rowsPerPage)); renderTable(); },
        goToPage: page => { currentPage = page; renderTable(); }
    };

})();
</script>
