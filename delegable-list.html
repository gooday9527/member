<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

<div class="container-fluid mt-4">
    <h2 class="mb-3">ğŸ“¥ å¯å§”è¨—ä»£é ˜æ¸…å–®</h2>
    <p class="text-muted">é€™è£¡æœƒåˆ—å‡ºæ‰€æœ‰æ‚¨å¯ä»¥å§”è¨—æˆ‘å€‘ä»£é ˜çš„è‚¡æ±æœƒç´€å¿µå“ã€‚æ‚¨å¯ä»¥åˆ©ç”¨ä¸‹æ–¹çš„æœå°‹åŠŸèƒ½å¿«é€Ÿæ‰¾åˆ°ç›®æ¨™å…¬å¸ã€‚</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>è‚¡è™Ÿ</th>
                            <th>è‚¡å</th>
                            <th>é›»æŠ•é–‹å§‹æ—¥</th>
                            <th>å§”è¨—æˆªæ­¢æ—¥</th>
                            <th>å§”è¨—æ¢ä»¶</th>
                            <th class="text-center">æŒæœ‰å¸³è™Ÿæ•¸</th>
                            <th class="text-center">å·²å§”è¨—æ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>å§“å</th>
                        <th>è­‰ä»¶ç‹€æ…‹</th>
                        <th class="text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    // IIFE (ç«‹å³èª¿ç”¨å‡½å¼è¡¨é”å¼) ä¾†å‰µå»ºä¸€å€‹å±€éƒ¨ä½œç”¨åŸŸï¼Œé¿å…æ±¡æŸ“å…¨å±€
    (function() {
        // --- æ­¥é©Ÿ 1: è¨­å®šæ‚¨çš„å¾Œç«¯ç¶²å€ ---
        // â€¼ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡çš„ç¶²å€æ˜¯æ‚¨å¾ã€Œç®¡ç†éƒ¨ç½²ä½œæ¥­ã€è¤‡è£½å‡ºä¾†çš„æ­£ç¢ºç¶²å€
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec";

        // --- æ­¥é©Ÿ 2: å»ºç«‹èˆ‡å¾Œç«¯æºé€šçš„å…±ç”¨å‡½å¼ ---
        async function fetchDataFromBackend(action, payload = {}) {
            const userEmail = window.currentUserEmail; // å¾ä¸» app.js ç²å–
            if (!userEmail) {
                throw new Error("ç„¡æ³•ç²å–ç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°æ•´ç†æˆ–ç™»å…¥ã€‚");
            }
            const fullPayload = { action, email: userEmail, ...payload };
            
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(fullPayload),
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error(`ç¶²è·¯éŒ¯èª¤: ${response.statusText}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.data.message || "å¾Œç«¯è™•ç†æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤");
            return result.data;
        }

        // --- æ­¥é©Ÿ 3: åˆå§‹åŒ– DataTables ---
        const table = new DataTable('#delegableTable', {
            // âœ… æ”¹ç”¨ fetch ä¾†ç²å–è³‡æ–™
            ajax: async function (data, callback, settings) {
                try {
                    const responseData = await fetchDataFromBackend("getDelegableList");
                    callback({ data: responseData }); // DataTables éœ€è¦çš„æ ¼å¼æ˜¯ { data: [...] }
                } catch (error) {
                    console.error("è¼‰å…¥å¯å§”è¨—æ¸…å–®å¤±æ•—:", error);
                    $('#delegableTable tbody').html(`<tr><td colspan="7" class="text-center alert alert-danger">${error.message}</td></tr>`);
                }
            },
            columns: [
                { data: 'stockCode' },
                { data: 'stockName' },
                { data: 'eVotingStartDate', defaultContent: '-' },
                { data: 'delegationDeadline', defaultContent: '-' },
                { data: 'delegationConditions', defaultContent: '-' },
                {
                    data: 'totalHoldingAccounts',
                    className: 'text-center',
                    render: function (data, type, row) {
                        // é€™æ®µ render é‚è¼¯ä¸è®Šï¼Œå¯«å¾—å¾ˆå¥½
                        return `<button class="btn btn-sm btn-outline-primary view-details-btn"
                                        data-details='${JSON.stringify(row.holdingsDetail)}'
                                        data-company="${row.stockName} (${row.stockCode})"
                                        data-stock-code="${row.stockCode}"
                                        data-conditions="${row.delegationConditions}">
                                    ${data}
                                </button>`;
                    }
                },
                { data: 'delegatedAccounts', className: 'text-center' }
            ],
            language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/zh-HANT.json' },
            responsive: true,
            order: [[3, 'asc']]
        });

        // --- æ­¥é©Ÿ 4: è™•ç†å½ˆå‡ºè¦–çª— (Modal) çš„é‚è¼¯ ---
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        // é»æ“Šã€ŒæŒæœ‰å¸³è™Ÿæ•¸ã€æŒ‰éˆ•ï¼Œæ‰“é–‹ Modal
        $('#delegableTable tbody').on('click', '.view-details-btn', function () {
            const button = $(this);
            const details = JSON.parse(button.attr('data-details'));
            const companyName = button.attr('data-company');
            const stockCode = button.attr('data-stock-code'); // æ–°å¢å–å¾—è‚¡è™Ÿ
            const delegationConditions = button.attr('data-conditions');

            $('#modalCompanyName').text(companyName);
            const modalTableBody = $('#modalTableBody');
            modalTableBody.empty();

            details.forEach(account => {
                let actionHtml = '';
                const docType = String(account.documentType || '').trim();
                const isDocMatch = delegationConditions.includes("èº«åˆ†è­‰") ? docType === "èº«åˆ†è­‰" : true;

                if (account.delegationStatus === 'å·²å§”è¨—') {
                    actionHtml = `<span class="badge bg-success">å·²å§”è¨—</span>`;
                } else if (account.delegationStatus === 'å·²æ”¶è³¼') {
                    actionHtml = `<span class="badge bg-info">å·²æ”¶è³¼</span>`;
                } else if (!isDocMatch) {
                    actionHtml = `<span class="badge bg-danger">è­‰ä»¶ä¸ç¬¦</span>`;
                } else {
                    actionHtml = `
                        <button class="btn btn-primary btn-sm action-btn" data-action="delegate" data-status="å·²å§”è¨—" data-account-name="${account.accountName}" data-stock-code="${stockCode}">æˆ‘è¦å§”è¨—</button>
                        <button class="btn btn-info btn-sm action-btn ms-1" data-action="acquire" data-status="å·²æ”¶è³¼" data-account-name="${account.accountName}" data-stock-code="${stockCode}">æˆ‘è¦æ”¶è³¼</button>
                    `;
                }

                const rowHtml = `<tr>
                                    <td>${account.accountName}</td>
                                    <td>${docType || 'æœªæä¾›'}</td>
                                    <td class="text-center">${actionHtml}</td>
                                 </tr>`;
                modalTableBody.append(rowHtml);
            });

            detailsModal.show();
        });

        // âœ… ç›£è½ Modal å…§éƒ¨æ‰€æœ‰ã€Œæ“ä½œæŒ‰éˆ•ã€çš„é»æ“Šäº‹ä»¶
        $('#modalTableBody').on('click', '.action-btn', async function () {
            const btn = $(this);
            const action = btn.data('action');
            const newStatus = btn.data('status');
            const accountName = btn.data('account-name');
            const stockCode = btn.data('stock-code');

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            try {
                // ä½¿ç”¨ fetch å‘¼å«å¾Œç«¯ updateDelegationStatus
                const result = await fetchDataFromBackend("updateDelegationStatus", {
                    subAccountName: accountName,
                    stockCode: stockCode,
                    newStatus: newStatus
                });

                // æˆåŠŸå¾Œé—œé–‰ Modal ä¸¦é‡è¼‰ DataTables çš„è³‡æ–™
                detailsModal.hide();
                table.ajax.reload(); // é‡è¼‰è¡¨æ ¼ä»¥é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
                alert(result.message); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯

            } catch (error) {
                alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
                btn.prop('disabled', false).text(action === 'delegate' ? 'æˆ‘è¦å§”è¨—' : 'æˆ‘è¦æ”¶è³¼');
            }
        });

    })(); // ç«‹å³åŸ·è¡Œ
</script>
