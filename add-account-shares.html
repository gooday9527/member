<style>
    /* é€™è£¡å¯ä»¥æ”¾é€™å€‹é é¢å°ˆå±¬çš„ CSS */
    .add-account-container {
        width: 100%;
        max-width: 500px;  /* èª¿æ•´ç‚ºæ›´åˆç†çš„å¯¬åº¦ */
        margin: 40px auto;
        padding: 20px;
        background-color: #6E97FF;
        border-radius: <!-- add-account-shares.html -->

<!-- âœ…ã€æ ¸å¿ƒã€‘æ¡ç”¨èˆ‡ç™»å…¥é å®Œå…¨ä¸€è‡´çš„ç½®ä¸­ã€ç°¡æ½”é¢¨æ ¼ -->
<div style="max-width: 500px; margin: 2rem auto;">
    <h3 class="text-center">ğŸ“Š æ–°å¢å¸³è™Ÿï¼æŒè‚¡</h3>
    <p class="text-center text-muted small mb-3">ç™»å…¥è€…: <span id="currentUserName" class="fw-bold">è¼‰å…¥ä¸­...</span></p>

    <!-- âœ…ã€åŠŸèƒ½ã€‘ä¿ç•™æ‚¨æ‰€æœ‰çš„æ ¸å¿ƒåŠŸèƒ½ -->
    <div class="mb-3">
        <label for="subAccountSelect" class="form-label">é¸æ“‡æˆ–æ–°å¢å­å¸³è™Ÿ</label>
        <div class="input-group">
            <select class="form-select" id="subAccountSelect">
                <option value="">è«‹é¸æ“‡...</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="toggleSubAccountInput(true)">â• æ–°å¢</button>
        </div>
    </div>
    
    <div id="addSubWrapper" class="mb-3 p-3 border rounded bg-light" style="display:none;">
        <label for="newSubAccountInput" class="form-label">æ–°å­å¸³è™Ÿåç¨±</label>
        <input type="text" class="form-control" id="newSubAccountInput" placeholder="è«‹è¼¸å…¥å­å¸³è™Ÿåç¨±">
        <div class="mt-2 d-flex gap-2 justify-content-end">
            <button class="btn btn-sm btn-secondary" onclick="toggleSubAccountInput(false)">å–æ¶ˆ</button>
            <button class="btn btn-sm btn-primary" onclick="saveNewSubAccount()">å„²å­˜</button>
        </div>
    </div>

    <div class="mb-3">
        <label for="stockInput" class="form-label">è¼¸å…¥è‚¡è™Ÿ (ç”¨é€—è™Ÿåˆ†éš”)</label>
        <textarea id="stockInput" class="form-control" rows="4" placeholder="ä¾‹å¦‚ï¼š1101, 1102, 2330"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">é¸æ“‡æ“ä½œé¡å‹</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opAdd" value="add" checked>
            <label class="form-check-label" for="opAdd">æ–°å¢ä¸Šåˆ—æŒè‚¡ (è¿½åŠ )</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opOverwrite" value="overwrite">
            <label class="form-check-label" for="opOverwrite">ä¸Šåˆ—æŒè‚¡è¦†è“‹åŸæœ¬æŒè‚¡ (æ¸…ç©ºå¾Œå¯«å…¥)</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opDelete" value="delete">
            <label class="form-check-label" for="opDelete">åˆªé™¤ä¸Šåˆ—æŒè‚¡ (å¾ç¾æœ‰æ¸…å–®ç§»é™¤)</label>
        </div>
    </div>

    <button class="btn btn-success w-100 mt-3" onclick="executeOperation()">åŸ·è¡Œæ“ä½œ</button>

    <div id="messageBox" class="mt-3"></div>
</div>

<!-- âœ…ã€é‚è¼¯ã€‘æ•´åˆæ‚¨åŸæœ¬çš„ JavaScriptï¼Œä¸¦é©é… SPA æ¶æ§‹ -->
<script>
    (function() {
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzk_RKeBgLtWsVJe79WUIYklyOnLL94nVZ41rb_zG_bV-LOSsi9PtSHQX0H0a2hMId0/exec";
        let accountsData = [];

        async function fetchDataFromBackend(action, payload = {}) {
            const userEmail = window.currentUserEmail;
            if (!userEmail) {
                displayMessage("éŒ¯èª¤ï¼šç„¡æ³•ç²å–ç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚", "danger");
                throw new Error("User not logged in");
            }
            const fullPayload = { action, userEmail, ...payload };
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fullPayload),
            });
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            const result = await response.json();
            if (result.status === "error") throw new Error(result.data.message || "å¾Œç«¯è™•ç†éŒ¯èª¤");
            return result.data;
        }

        function displayMessage(msg, type) {
            const box = document.getElementById("messageBox");
            if (!box) return;
            // ä½¿ç”¨ Bootstrap çš„ Alert æ¨£å¼
            box.innerHTML = `<div class="alert alert-${type}" role="alert">${msg}</div>`;
            setTimeout(() => { box.innerHTML = ''; }, 5000);
        }

        window.toggleSubAccountInput = function(show) {
            const wrapper = document.getElementById("addSubWrapper");
            if (wrapper) {
                wrapper.style.display = show ? "block" : "none";
                if (!show) document.getElementById("newSubAccountInput").value = "";
            }
        };

        window.saveNewSubAccount = async function() {
            const name = document.getElementById("newSubAccountInput").value.trim();
            if (!name) return displayMessage("è«‹è¼¸å…¥å­å¸³è™Ÿåç¨±", "danger");
            try {
                const result = await fetchDataFromBackend("addAndSelectSubAccount", { name: name });
                displayMessage(result.message, result.success ? "success" : "danger");
                if (result.success) {
                    toggleSubAccountInput(false);
                    await loadInitialData(name);
                }
            } catch (e) {
                displayMessage("å„²å­˜å¤±æ•—ï¼š" + e.message, "danger");
            }
        };

        window.executeOperation = async function() {
            const subAccount = document.getElementById("subAccountSelect").value;
            const stocks = document.getElementById("stockInput").value.trim();
            const operationType = document.querySelector('input[name="operationType"]:checked').value;

            if (!subAccount) return displayMessage("è«‹é¸æ“‡ä¸€å€‹å­å¸³è™Ÿ", "danger");
            if (!stocks && operationType !== 'overwrite') return displayMessage("è«‹è¼¸å…¥è‚¡è™Ÿ", "danger");

            const btn = document.querySelector('.btn-success');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            try {
                const result = await fetchDataFromBackend("executeStockOperation", { subAccount, stocks, operationType });
                displayMessage(result.message, "success");
                document.getElementById("stockInput").value = "";
            } catch (e) {
                displayMessage("æ“ä½œå¤±æ•—ï¼š" + e.message, "danger");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        async function loadInitialData(accountToSelect = null) {
            try {
                const data = await fetchDataFromBackend("getAccountData");
                document.getElementById("currentUserName").textContent = data.currentUserName;
                accountsData = data.accounts || [];
                const select = document.getElementById("subAccountSelect");
                select.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
                accountsData.forEach(name => {
                    const opt = document.createElement("option");
                    opt.value = opt.textContent = name;
                    select.appendChild(opt);
                });
                if (accountToSelect && accountsData.includes(accountToSelect)) {
                    select.value = accountToSelect;
                }
            } catch (e) {
                displayMessage("è¼‰å…¥å¸³è™Ÿè³‡æ–™å¤±æ•—ï¼š" + e.message, "danger");
            }
        }

        setTimeout(loadInitialData, 0);

    })();
</script>
20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: white; /* ç¢ºä¿å…§éƒ¨æ–‡å­—é¡è‰²å¯è¦‹ */
    }
    .add-account-container h3 {
      color: white; /* æ¨™é¡Œé¡è‰² */
      text-align: center;
      margin-bottom: 20px;
    }
    .add-account-container label {
      color: white; /* æ¨™ç±¤é¡è‰² */
      margin-top: 10px;
    }
    .add-account-container .btn-operate {
      width: 100%;
      background-color: #ffc107;
      border: none;
      border-radius: 8px;
      color: black;
      margin-top: 20px;
    }
    .add-account-container .message-box {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      display: none;
      font-weight: bold;
    }
    .add-account-container .message-box.alert-success {
      background-color: #d1e7dd; /* æ·ºç¶ è‰² */
      color: #0f5132; /* æ·±ç¶ è‰²æ–‡å­— */
    }
    .add-account-container .message-box.alert-danger {
      background-color: #f8d7da; /* æ·ºç´…è‰² */
      color: #842029; /* æ·±ç´…è‰²æ–‡å­— */
    }
    .add-account-container .form-control, .add-account-container .form-select {
      margin-bottom: 10px;
      background-color: rgba(255, 255, 255, 0.2); /* è¼¸å…¥æ¡†åŠé€æ˜èƒŒæ™¯ */
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
    }
    .add-account-container .form-control::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    .add-account-container .form-select option {
        background-color: #6E97FF; /* ä¸‹æ‹‰é¸å–®é¸é …èƒŒæ™¯ */
        color: white;
    }
    .add-account-container .form-check-label {
        color: white;
    }
</style>

<div class="add-account-container">
    <h3>ğŸ“Š æ–°å¢å¸³è™Ÿï¼æŒè‚¡</h3>

    <div class="mb-3 text-white">ç™»å…¥è€…: <span id="currentUserName">è¼‰å…¥ä¸­...</span></div>

    <div class="mb-3">
      <label for="subAccountSelect">é¸æ“‡å­å¸³è™Ÿ</label>
      <select class="form-select" id="subAccountSelect">
        <option value="">è«‹é¸æ“‡å­å¸³è™Ÿ</option>
      </select>
    </div>

    <div id="addSubBtnWrapper" class="mb-3">
      <button type="button" class="btn btn-outline-light" onclick="toggleSubAccountInput(true)">â• æ–°å¢å­å¸³è™Ÿ</button>
    </div>
    <div id="addSubWrapper" class="mb-3" style="display:none;">
      <input type="text" class="form-control" id="newSubAccountInput" placeholder="è«‹è¼¸å…¥å­å¸³è™Ÿåç¨±">
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-secondary" onclick="toggleSubAccountInput(false)">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveNewSubAccount()">å„²å­˜</button>
      </div>
    </div>

    <label for="stockInput">è¼¸å…¥è‚¡è™Ÿ</label>
    <textarea id="stockInput" class="form-control" rows="4" placeholder="ä¾‹ï¼š1101,1102"></textarea>

    <label class="mt-2">é¸æ“‡æ“ä½œé¡å‹ï¼š</label>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="operationType" id="opAdd" value="add" checked>
      <label class="form-check-label text-white" for="opAdd">æ–°å¢ä¸Šåˆ—æŒè‚¡ (è¿½åŠ )</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="operationType" id="opOverwrite" value="overwrite">
      <label class="form-check-label text-white" for="opOverwrite">ä¸Šåˆ—æŒè‚¡è¦†è“‹åŸæœ¬æŒè‚¡ (æ¸…ç©ºå¾Œå¯«å…¥)</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="operationType" id="opDelete" value="delete">
      <label class="form-check-label text-white" for="opDelete">åˆªé™¤ä¸Šåˆ—æŒè‚¡ (å¾ç¾æœ‰æ¸…å–®ç§»é™¤)</label>
    </div>

    <button class="btn btn-operate" onclick="executeOperation()">åŸ·è¡Œæ“ä½œ</button>

    <div id="messageBox" class="message-box"></div>
</div>

<script>
    // âœ… è«‹æ›¿æ›æˆæ‚¨éƒ¨ç½²çš„ Apps Script Web æ‡‰ç”¨ç¨‹å¼ URL
    // é€™å€‹ URL æ˜¯æ‚¨åœ¨ Apps Script å°ˆæ¡ˆä¸­ï¼Œé»æ“Šã€Œéƒ¨ç½²ã€->ã€Œç®¡ç†éƒ¨ç½²ä½œæ¥­ã€å¾Œï¼Œè¤‡è£½ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URLã€å¾—åˆ°çš„
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzk_RKeBgLtWsVJe79WUIYklyOnLL94nVZ41rb_zG_bV-LOSsi9PtSHQX0H0a2hMId0/exec";

    let accountsData = [];

    // å¾å¾Œç«¯ç²å–æ•¸æ“šçš„é€šç”¨å‡½æ•¸
    async function fetchDataFromBackend(action, payload = {}) {
        const fullPayload = { action, ...payload };
        try {
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(fullPayload),
            });

            if (!response.ok) {
                // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 2xxï¼Œæ‹‹å‡ºéŒ¯èª¤
                const errorText = await response.text();
                throw new Error(`HTTP Error ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            if (result.status === "error") {
                throw new Error(result.data.message || "å¾Œç«¯è™•ç†éŒ¯èª¤");
            }
            return result.data; // è¿”å›å¾Œç«¯å›æ‡‰çš„ data éƒ¨åˆ†
        } catch (error) {
            console.error("Fetch Data Error:", error);
            throw error; // é‡æ–°æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“èª¿ç”¨è€…è™•ç†
        }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ•¸æ“š
    document.addEventListener("DOMContentLoaded", async function () {
        // ç²å–ç•¶å‰ç™»å…¥ç”¨æˆ¶çš„ Email
        // åœ¨å‰ç«¯ï¼Œæ‚¨éœ€è¦æœ‰ä¸€ç¨®æ–¹å¼ä¾†ç²å–ç”¨æˆ¶ Emailã€‚
        // å¦‚æœæ‚¨ä½¿ç”¨ Firebase Authenticationï¼Œå¯ä»¥å¾ firebase.auth().currentUser.email å–å¾—ã€‚
        // é€™è£¡æˆ‘å€‘å‡è¨­åœ¨ `window.currentUserEmail` å·²ç¶“è¨­å®šäº†ç™»å…¥è€…çš„ Emailã€‚
        // ğŸš¨ é€™æ˜¯é—œéµï¼æ‚¨å¿…é ˆç¢ºä¿ `window.currentUserEmail` åœ¨é€™å€‹é é¢è¼‰å…¥å‰å·²ç¶“è¢«è¨­å®šã€‚
        // ä¾‹å¦‚ï¼Œåœ¨ index.html çš„ä¸»è…³æœ¬ä¸­ï¼Œç•¶ Firebase ç”¨æˆ¶ç‹€æ…‹æ”¹è®Šæ™‚ï¼Œè¨­å®šé€™å€‹è®Šæ•¸ï¼š
        // onAuthStateChanged(auth, (user) => {
        //     window.currentUserEmail = user ? user.email : null;
        //     // ... è¼‰å…¥ add-account-shares.html æ™‚ï¼Œé€™å€‹å€¼å°±æœƒå­˜åœ¨
        // });
        const userEmail = window.currentUserEmail || "æ¸¬è©¦å¸³è™Ÿ@example.com"; // å¦‚æœæ²’æœ‰å¯¦éš›çš„ç™»å…¥emailï¼Œæä¾›ä¸€å€‹é è¨­å€¼ç”¨æ–¼æ¸¬è©¦

        try {
            const data = await fetchDataFromBackend("getAccountData", { userEmail: userEmail });
            document.getElementById("currentUserName").textContent = data.currentUserName;

            accountsData = data.accounts || [];
            const select = document.getElementById("subAccountSelect");
            select.innerHTML = '<option value="">è«‹é¸æ“‡å­å¸³è™Ÿ</option>'; // æ¸…ç©ºä¸¦æ·»åŠ é è¨­é¸é …
            accountsData.forEach(name => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = name;
                select.appendChild(opt);
            });
            // å¦‚æœå¾Œç«¯æœ‰è¿”å›æ–°å»ºç«‹çš„å­å¸³è™Ÿï¼Œé¸æ“‡å®ƒ
            const newSubAccountToSelect = localStorage.getItem('newSubAccountSelected');
            if (newSubAccountToSelect && accountsData.includes(newSubAccountToSelect)) {
                select.value = newSubAccountToSelect;
                localStorage.removeItem('newSubAccountSelected'); // ç”¨éå°±æ¸…é™¤
            }
        } catch (e) {
            displayMessage("è¼‰å…¥å¸³è™Ÿè³‡æ–™å¤±æ•—ï¼š" + e.message, "danger");
            console.error("åˆå§‹åŒ–å¤±æ•—:", e);
        }
    });

    // é¡¯ç¤ºè¨Šæ¯æ¡†
    function displayMessage(msg, type) {
      const box = document.getElementById("messageBox");
      box.className = `message-box alert-${type}`;
      box.textContent = msg;
      box.style.display = "block";
      // 5ç§’å¾Œè‡ªå‹•éš±è—è¨Šæ¯
      setTimeout(() => {
          box.style.display = "none";
      }, 5000);
    }

    // åˆ‡æ›æ–°å¢å­å¸³è™Ÿçš„è¼¸å…¥æ¡†é¡¯ç¤º
    function toggleSubAccountInput(show) {
      document.getElementById("addSubBtnWrapper").style.display = show ? "none" : "block";
      document.getElementById("addSubWrapper").style.display = show ? "block" : "none";
      if (!show) {
        document.getElementById("newSubAccountInput").value = "";
      }
    }

    // å„²å­˜æ–°å­å¸³è™Ÿ
    async function saveNewSubAccount() {
      const name = document.getElementById("newSubAccountInput").value.trim();
      if (!name) {
        return displayMessage("è«‹è¼¸å…¥å­å¸³è™Ÿåç¨±", "danger");
      }
      const userEmail = window.currentUserEmail || "æ¸¬è©¦å¸³è™Ÿ@example.com";

      try {
        // å‘¼å«å¾Œç«¯ Apps Script å‡½æ•¸
        const result = await fetchDataFromBackend("addAndSelectSubAccount", { name: name, userEmail: userEmail });
        displayMessage(result.message, result.success ? "success" : "danger");

        if (result.success) {
          localStorage.setItem('newSubAccountSelected', name); // å„²å­˜æ–°å»ºç«‹çš„å­å¸³è™Ÿåç¨±ï¼Œç”¨æ–¼é‡æ–°è¼‰å…¥å¾Œé¸ä¸­
          // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°å­å¸³è™Ÿä¸‹æ‹‰é¸å–®
          // ç”±æ–¼é€™æ˜¯å‹•æ…‹è¼‰å…¥çš„é é¢ï¼Œç›´æ¥ reload() æœƒé‡æ–°è¼‰å…¥æ•´å€‹ index.html
          // æ›´å¥½çš„åšæ³•æ˜¯é‡æ–°å‘¼å«åˆå§‹åŒ–å‡½æ•¸ä¾†æ›´æ–°ä¸‹æ‹‰é¸å–®
          toggleSubAccountInput(false); // éš±è—è¼¸å…¥æ¡†
          await document.dispatchEvent(new Event('DOMContentLoaded
