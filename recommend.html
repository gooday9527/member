<div class="recommend-wrapper">

    <div class="position-relative d-flex align-items-center mb-2" style="min-height: 38px;">

        <div class="d-flex align-items-center gap-2 recommend-controls">
            <label for="recommendSheet" class="form-label mb-0 text-nowrap">選擇分類：</label>
            <select id="recommendSheet" class="form-select form-select-sm" style="max-width: 200px;">
                <option>分類載入中...</option>
            </select>
        </div>

        <h3 class="mb-0 position-absolute top-50 start-50 translate-middle">🌟 推薦清單</h3>

    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="recommendTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script type="module">
    // 1. 從 app.js 導入我們集中管理的網址，不再在這裡重複宣告
    import { APP_URLS } from './app.js';

    // --- 全域變數 ---
    let isRecommendInitialized = false;

    // --- 函數定義 ---

    // 函數：渲染表格 (保持不變，但更健壯)
    function renderRecommendTable(data) {
        const tableElement = document.getElementById('recommendTable');
        if (!tableElement) return;

        const thead = tableElement.querySelector('thead');
        const tbody = tableElement.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">這個分類目前沒有資料</td></tr>';
            return;
        }

        const headers = Object.keys(data[0]);
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        tbody.innerHTML = data.map(row => `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`).join('');
    }

    // 函數：透過 fetch 載入資料 (升級！)
    async function loadRecommendData(sheetName) {
        const tbody = document.querySelector('#recommendTable tbody');
        if (!tbody) return;
        tbody.innerHTML = `<tr><td colspan="100%">資料載入中...</td></tr>`;

        try {
            const params = new URLSearchParams({
                action: 'getRecommendations',
                sheetName: sheetName
            });
            
            // 使用 fetch，並從 APP_URLS 取得網址
            const response = await fetch(`${APP_URLS.recommend}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`網路回應錯誤: ${response.status}`);
            }

            const result = await response.json();
            if (result.status === 'error') {
                throw new Error(result.data.message);
            }

            renderRecommendTable(result.data.data);

        } catch (error) {
            console.error('載入推薦資料時發生錯誤:', error);
            tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">資料載入失敗</td></tr>`;
        }
    }
    
    // 主初始化函數 (簡化並升級！)
    async function initializeRecommendPage() {
        if (isRecommendInitialized) return;
        isRecommendInitialized = true;

        const selectElement = document.getElementById('recommendSheet');
        if (!selectElement) {
            console.error("錯誤：找不到 recommendSheet 下拉選單。");
            return;
        }

        selectElement.disabled = true;
        selectElement.innerHTML = '<option>分類載入中...</option>';

        try {
            const params = new URLSearchParams({ action: 'getRecommendationCategories' });
            const response = await fetch(`${APP_URLS.recommend}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`網路回應錯誤: ${response.status}`);
            }

            const result = await response.json();
            if (result.status === 'error') {
                throw new Error(result.data.message);
            }

            const categories = result.data.categories;
            selectElement.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            
            selectElement.disabled = false;
            selectElement.addEventListener('change', function () {
                loadRecommendData(this.value);
            });

            if (categories.length > 0) {
                await loadRecommendData(categories[0]); // 載入第一個分類的資料
            }

        } catch (error) {
            console.error('載入分類時發生錯誤:', error);
            selectElement.innerHTML = `<option>分類載入失敗</option>`;
        }
    }

    // --- 啟動邏輯 ---
    // 使用 module 類型，可以直接呼叫，不需要 DOMContentLoaded 檢查
    initializeRecommendPage();
</script>
