<div class="souvenir-wrapper pt-2 pb-2 pt-md-0 pb-md-0">
  <!-- æ§åˆ¶åˆ—ï¼ˆæœå°‹ + ç­†æ•¸ï¼‰ -->
  <div class="d-block d-md-flex align-items-center gap-3 mb-2 mb-md-0 px-3" id="delegableControlsContainer">
    <div class="me-3">
      <h3 class="mt-1 mb-1 mb-md-0" style="white-space: nowrap;">ğŸ“¥ å¯å§”è¨—æ¸…å–®</h3>
    </div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="d-flex align-items-center">
        <label for="delegRowsPerPage" class="form-label mb-0 me-1">ç­†æ•¸:</label>
        <select id="delegRowsPerPage" class="form-select form-select-sm" style="width: 80px;">
          <option>10</option><option>25</option><option>50</option><option>100</option>
        </select>
      </div>
      <div class="d-flex align-items-center">
        <label for="delegSearchInput" class="form-label mb-0 me-1">æœå°‹:</label>
        <input type="text" id="delegSearchInput" class="form-control form-control-sm" style="width: 150px;" placeholder="é—œéµå­—...">
      </div>
    </div>
  </div>

  <!-- è¡¨æ ¼å®¹å™¨ -->
  <div class="table-scroll-container table-responsive">
    <table class="table table-bordered table-sm" id="delegableListTable">
      <thead class="table-warning"></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- åˆ†é  -->
  <div id="delegablePaginationWrapper" class="mt-2">
    <div id="delegablePagination" class="d-flex justify-content-center flex-wrap"></div>
  </div>
</div>

<script>
(function(){
  const email = window.currentUserEmail;
  if (!email) return;

  // ç‹€æ…‹
  let rawData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
  let sortKey = 'å§”è¨—æˆªæ­¢æ—¥', sortAsc = true;

  // æ¬„ä½
  const columns = ['è‚¡è™Ÿ','è‚¡å','é›»æŠ•é–‹å§‹æ—¥','å§”è¨—æˆªæ­¢æ—¥','å§”è¨—æ¢ä»¶','æŒæœ‰å¸³è™Ÿæ•¸','å·²å§”è¨—æ•¸'];

  // DOM
  const tblHead = document.querySelector('#delegableListTable thead');
  const tblBody = document.querySelector('#delegableListTable tbody');
  const ctrlRows = document.getElementById('delegRowsPerPage');
  const ctrlSearch = document.getElementById('delegSearchInput');
  const pagContainer = document.getElementById('delegablePagination');

  // åˆå§‹åŒ–æ§åˆ¶åˆ—äº‹ä»¶
  ctrlRows.addEventListener('change', ()=>{ rowsPerPage = +ctrlRows.value; currentPage=1; renderTable(); });
  ctrlSearch.addEventListener('input', ()=>{ currentPage=1; filterData(); renderTable(); });

  // å–å¾—è³‡æ–™
  google.script.run
    .withSuccessHandler(resp=>{
      rawData = resp.data||[];
      // å…ˆæ’åºã€å† filter
      sortData(); filterData();
      // ç¹ªè£½è¡¨é ­
      tblHead.innerHTML = '<tr>' + columns.map(h=>`<th class="sortable" data-key="${h}" style="cursor:pointer;white-space:nowrap">${h}<span></span></th>`).join('') + '</tr>';
      tblHead.querySelectorAll('th.sortable').forEach(th=>th.addEventListener('click', ()=>{ sortKey=th.dataset.key; sortAsc = (sortKey===th.dataset.key)?!sortAsc:true; sortData(); filterData(); renderTable(); }));
      renderTable();
    })
    .withFailureHandler(err=>{ tblBody.innerHTML='<tr><td colspan="7" class="text-center text-danger p-4">è¼‰å…¥å¤±æ•—</td></tr>'; })
    .getDelegableListData(email);

  function sortData(){
    rawData.sort((a,b)=>{
      let A=a[sortKey], B=b[sortKey];
      const numA=Number(A), numB=Number(B);
      if (!isNaN(numA) && !isNaN(numB)) return sortAsc?numA-numB:numB-numA;
      return sortAsc?String(A).localeCompare(B,'zh-Hant'):String(B).localeCompare(A,'zh-Hant');
    });
  }

  function filterData(){
    const kw = ctrlSearch.value.trim().toLowerCase();
    filteredData = kw? rawData.filter(r=>columns.some(h=>String(r[h]||'').toLowerCase().includes(kw))) : rawData.slice();
  }

  function renderTable(){
    // æ¨™ç¤ºæ’åºç®­é ­
    tblHead.querySelectorAll('th.sortable span').forEach(s=>s.textContent='');
    const sp = tblHead.querySelector(`th[data-key="${sortKey}"] span`);
    if (sp) sp.textContent = sortAsc?' â–²':' â–¼';

    // åˆ†é åˆ‡ç‰‡
    const start=(currentPage-1)*rowsPerPage, end=start+rowsPerPage;
    const pageData=filteredData.slice(start,end);

    // æ¸²æŸ“åˆ—
    tblBody.innerHTML = pageData.map(r=>{
      let tds = columns.map(key=>{
        let v=r[key]||'';
        if (key==='æŒæœ‰å¸³è™Ÿæ•¸' && v>0){
          return `<td class="text-center"><button class="btn btn-sm btn-outline-primary view-details-btn" data-details='${JSON.stringify(r.holdingsDetail)}' data-company="${r.è‚¡å} (${r.è‚¡è™Ÿ})" data-conditions="${r.å§”è¨—æ¢ä»¶}">${v}</button></td>`;
        }
        if (key==='æŒæœ‰å¸³è™Ÿæ•¸' || key==='å·²å§”è¨—æ•¸') return `<td class="text-center">${v}</td>`;
        return `<td>${v}</td>`;
      }).join('');
      return `<tr>${tds}</tr>`;
    }).join('')||'<tr><td colspan="7" class="text-center p-4">æ²’æœ‰è³‡æ–™</td></tr>';

    // ç¶æ˜ç´°æŒ‰éˆ•
    document.querySelectorAll('.view-details-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const det=JSON.parse(btn.dataset.details);
        const company=btn.dataset.company;
        const cond=btn.dataset.conditions;
        showModal(det,company,cond);
      });
    });

    renderPagination();
  }

  function renderPagination(){
    const totalPages=Math.ceil(filteredData.length/rowsPerPage)||1;
    let html='';
    html+=`<button class="btn btn-sm me-1"${currentPage===1?' disabled':''} onclick="changePage(-1)">ä¸Šé </button>`;
    for(let i=1;i<=totalPages;i++){
      html+=`<button class="btn btn-sm me-1 ${i===currentPage?'btn-primary':'btn-outline-primary'}" onclick="goPage(${i})">${i}</button>`;
    }
    html+=`<button class="btn btn-sm"${currentPage===totalPages?' disabled':''} onclick="changePage(1)">ä¸‹é </button>`;
    pagContainer.innerHTML=html;
  }

  window.changePage=off=>{ currentPage=Math.min(Math.max(1,currentPage+off),Math.ceil(filteredData.length/rowsPerPage)); renderTable(); };
  window.goPage=pg=>{ currentPage=pg; renderTable(); };

  function showModal(details,company,conditions){
    document.getElementById('modalCompanyName').textContent=company;
    const mb=document.getElementById('modalTableBody'); mb.innerHTML='';
    details.forEach(acc=>{
      let action='';
      if(acc.isDelegated) action=`<button class="btn btn-warning btn-sm" data-action="cancel">å–æ¶ˆå§”è¨—</button>`;
      else{
        let ok=true; const doc=acc.documentType||'';
        if(conditions.includes('èº«åˆ†è­‰æ­£æœ¬')&&doc!=='èº«åˆ†è­‰') ok=false;
        if(conditions.includes('è­‰ä»¶æ­£æœ¬')&&!['èº«åˆ†è­‰','å¥ä¿å¡'].includes(doc)) ok=false;
        if(ok) action=`<button class="btn btn-primary btn-sm me-1" data-action="delegate">å§”è¨—</button><button class="btn btn-info btn-sm" data-action="acquire">æ”¶è³¼</button>`;
        else action=`<span class="badge bg-danger">X</span>`;
      }
      mb.insertAdjacentHTML('beforeend',`<tr><td>${acc.accountName}</td><td>${acc.documentType||'æœªæä¾›'}</td><td class="text-center">${action}</td></tr>`);
    });
    new bootstrap.Modal('#detailsModal').show();
  }
})();
</script>
