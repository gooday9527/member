<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

<div class="container-fluid mt-4">
    <h2 class="mb-3">📥 可委託代領清單</h2>
    <p class="text-muted">這裡會列出所有您可以委託我們代領的股東會紀念品。您可以利用下方的搜尋功能快速找到目標公司。</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>股號</th>
                            <th>股名</th>
                            <th>電投開始日</th>
                            <th>委託截止日</th>
                            <th>委託條件</th>
                            <th class="text-center">持有帳號數</th>
                            <th class="text-center">已委託數</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">持有帳號明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>公司：</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>姓名</th>
                        <th>證件狀態</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    // IIFE (立即調用函式表達式) 來創建一個局部作用域，避免污染全局
    (function() {
        // --- 步驟 1: 設定您的後端網址 ---
        // ‼️ 請務必確認這裡的網址是您從「管理部署作業」複製出來的正確網址
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec";

        // --- 步驟 2: 建立與後端溝通的共用函式 ---
        async function fetchDataFromBackend(action, payload = {}) {
            const userEmail = window.currentUserEmail; // 從主 app.js 獲取
            if (!userEmail) {
                throw new Error("無法獲取登入狀態，請重新整理或登入。");
            }
            const fullPayload = { action, email: userEmail, ...payload };
            
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(fullPayload),
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error(`網路錯誤: ${response.statusText}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.data.message || "後端處理時發生未知錯誤");
            return result.data;
        }

        // --- 步驟 3: 初始化 DataTables ---
        const table = new DataTable('#delegableTable', {
            // ✅ 改用 fetch 來獲取資料
            ajax: async function (data, callback, settings) {
                try {
                    const responseData = await fetchDataFromBackend("getDelegableList");
                    callback({ data: responseData }); // DataTables 需要的格式是 { data: [...] }
                } catch (error) {
                    console.error("載入可委託清單失敗:", error);
                    $('#delegableTable tbody').html(`<tr><td colspan="7" class="text-center alert alert-danger">${error.message}</td></tr>`);
                }
            },
            columns: [
                { data: 'stockCode' },
                { data: 'stockName' },
                { data: 'eVotingStartDate', defaultContent: '-' },
                { data: 'delegationDeadline', defaultContent: '-' },
                { data: 'delegationConditions', defaultContent: '-' },
                {
                    data: 'totalHoldingAccounts',
                    className: 'text-center',
                    render: function (data, type, row) {
                        // 這段 render 邏輯不變，寫得很好
                        return `<button class="btn btn-sm btn-outline-primary view-details-btn"
                                        data-details='${JSON.stringify(row.holdingsDetail)}'
                                        data-company="${row.stockName} (${row.stockCode})"
                                        data-stock-code="${row.stockCode}"
                                        data-conditions="${row.delegationConditions}">
                                    ${data}
                                </button>`;
                    }
                },
                { data: 'delegatedAccounts', className: 'text-center' }
            ],
            language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/zh-HANT.json' },
            responsive: true,
            order: [[3, 'asc']]
        });

        // --- 步驟 4: 處理彈出視窗 (Modal) 的邏輯 ---
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        // 點擊「持有帳號數」按鈕，打開 Modal
        $('#delegableTable tbody').on('click', '.view-details-btn', function () {
            const button = $(this);
            const details = JSON.parse(button.attr('data-details'));
            const companyName = button.attr('data-company');
            const stockCode = button.attr('data-stock-code'); // 新增取得股號
            const delegationConditions = button.attr('data-conditions');

            $('#modalCompanyName').text(companyName);
            const modalTableBody = $('#modalTableBody');
            modalTableBody.empty();

            details.forEach(account => {
                let actionHtml = '';
                const docType = String(account.documentType || '').trim();
                const isDocMatch = delegationConditions.includes("身分證") ? docType === "身分證" : true;

                if (account.delegationStatus === '已委託') {
                    actionHtml = `<span class="badge bg-success">已委託</span>`;
                } else if (account.delegationStatus === '已收購') {
                    actionHtml = `<span class="badge bg-info">已收購</span>`;
                } else if (!isDocMatch) {
                    actionHtml = `<span class="badge bg-danger">證件不符</span>`;
                } else {
                    actionHtml = `
                        <button class="btn btn-primary btn-sm action-btn" data-action="delegate" data-status="已委託" data-account-name="${account.accountName}" data-stock-code="${stockCode}">我要委託</button>
                        <button class="btn btn-info btn-sm action-btn ms-1" data-action="acquire" data-status="已收購" data-account-name="${account.accountName}" data-stock-code="${stockCode}">我要收購</button>
                    `;
                }

                const rowHtml = `<tr>
                                    <td>${account.accountName}</td>
                                    <td>${docType || '未提供'}</td>
                                    <td class="text-center">${actionHtml}</td>
                                 </tr>`;
                modalTableBody.append(rowHtml);
            });

            detailsModal.show();
        });

        // ✅ 監聽 Modal 內部所有「操作按鈕」的點擊事件
        $('#modalTableBody').on('click', '.action-btn', async function () {
            const btn = $(this);
            const action = btn.data('action');
            const newStatus = btn.data('status');
            const accountName = btn.data('account-name');
            const stockCode = btn.data('stock-code');

            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            try {
                // 使用 fetch 呼叫後端 updateDelegationStatus
                const result = await fetchDataFromBackend("updateDelegationStatus", {
                    subAccountName: accountName,
                    stockCode: stockCode,
                    newStatus: newStatus
                });

                // 成功後關閉 Modal 並重載 DataTables 的資料
                detailsModal.hide();
                table.ajax.reload(); // 重載表格以顯示最新狀態
                alert(result.message); // 顯示成功訊息

            } catch (error) {
                alert("更新失敗：" + error.message);
                btn.prop('disabled', false).text(action === 'delegate' ? '我要委託' : '我要收購');
            }
        });

    })(); // 立即執行
</script>
