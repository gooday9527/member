<div class="recommend-wrapper">

    <h3 class="text-center">ğŸŒŸ æ¨è–¦æ¸…å–®</h3>

    <div class="d-flex align-items-center gap-2 recommend-controls">
        <label for="recommendSheet" class="form-label mb-0">é¸æ“‡åˆ†é¡ï¼š</label>
        <select id="recommendSheet" class="form-select form-select-sm" style="max-width: 200px;">
            <option>åˆ†é¡è¼‰å…¥ä¸­...</option>
        </select>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="recommendTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    // è«‹å°‡é€™è£¡æ›æˆæ‚¨è‡ªå·±çš„å¾Œç«¯ Apps Script ç¶²å€
    const MY_BACKEND_URL = "https://script.google.com/macros/s/AKfycbzdoezSaX2ujsE5ejjac3HbZWWHhDKQbX0nN1rVTIPSZm7opdCtslmwPAIq6zBNvcTp/exec";

    /**
     * å‡½æ•¸ï¼šæ ¹æ“šå‚³å…¥çš„å·¥ä½œè¡¨åç¨±ï¼Œè¼‰å…¥å°æ‡‰çš„è³‡æ–™ä¸¦å‘ˆç¾åœ¨è¡¨æ ¼ä¸­
     * @param {string} sheetName - è¦è¼‰å…¥çš„å·¥ä½œè¡¨åç¨±
     */
    async function loadRecommendData(sheetName) {
        const tableElement = document.getElementById('recommendTable');
        if (!tableElement || !sheetName) return;

        const thead = tableElement.querySelector('thead');
        const tbody = tableElement.querySelector('tbody');
        
        thead.innerHTML = '';
        tbody.innerHTML = `<tr><td colspan="100%">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;

        try {
            const response = await fetch(MY_BACKEND_URL, {
                method: 'POST',
                // body ä½¿ç”¨ text ä»¥å… CORS preflight å•é¡Œï¼Œå¾Œç«¯ç”¨ JSON.parse è§£æ
                body: JSON.stringify({ action: 'getRecommendations', sheetName: sheetName })
            });
            
            if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);

            const result = await response.json();
            
            if (result.status === 'error') throw new Error(result.data.message || 'å¾Œç«¯å›å ±éŒ¯èª¤');
            
            const data = result.data.data; // è³‡æ–™åœ¨ result.data.data ä¸­

            tbody.innerHTML = ''; 

            if (data && data.length > 0) {
                const headers = Object.keys(data[0]);
                thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                tbody.innerHTML = data.map(row => 
                    `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`
                ).join('');
            } else {
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td colspan="100%">é€™å€‹åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>';
            }
        } catch (error) {
            console.error('è¼‰å…¥æ¨è–¦è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            thead.innerHTML = '';
            tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
        }
    }

    /**
     * å‡½æ•¸ï¼šåˆå§‹åŒ–é é¢ï¼Œå…ˆå–å¾—åˆ†é¡é¸å–®ï¼Œå†è¼‰å…¥é è¨­è³‡æ–™
     */
    async function initializeRecommendPage() {
        const selectElement = document.getElementById('recommendSheet');
        if (!selectElement) return;
        
        selectElement.disabled = true;

        try {
            // 1. å¾å¾Œç«¯ç²å–åˆ†é¡æ¸…å–®
            const response = await fetch(MY_BACKEND_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getRecommendationCategories' })
            });
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.data.message);
            
            const categories = result.data.categories;
            
            // 2. å‹•æ…‹ç”¢ç”Ÿä¸‹æ‹‰é¸å–®é¸é …
            selectElement.innerHTML = ''; // æ¸…ç©ºã€Œè¼‰å…¥ä¸­ã€
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            
            selectElement.disabled = false;

            // 3. åŠ ä¸Šã€Œè®Šæ›´æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™ã€çš„äº‹ä»¶ç›£è½
            selectElement.addEventListener('change', function () {
                loadRecommendData(this.value);
            });

            // 4. è‡ªå‹•è¼‰å…¥ç¬¬ä¸€å€‹åˆ†é¡çš„è³‡æ–™
            if (categories.length > 0) {
                loadRecommendData(categories[0]);
            }

        } catch (error) {
            console.error('è¼‰å…¥åˆ†é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            selectElement.innerHTML = `<option>åˆ†é¡è¼‰å…¥å¤±æ•—</option>`;
            const tbody = document.querySelector('#recommendTable tbody');
            if(tbody) tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">ç„¡æ³•è¼‰å…¥åˆ†é¡é¸å–®: ${error.message}</td></tr>`;
        }
    }

    // ç¢ºä¿é é¢å…ƒç´ éƒ½è¼‰å…¥å¾Œå†åŸ·è¡Œåˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRecommendPage);
    } else {
        initializeRecommendPage();
    }
</script>
