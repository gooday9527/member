<div class="container-fluid mt-2">
    <h3 class="mb-2">📥 可委託代領清單</h3>
    <p class="text-muted">這裡會列出所有您可以委託我們代領的股東會紀念品。</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div id="table-controls" class="mb-2"></div>
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        </thead>
                    <tbody>
                        <tr><td colspan="7" class="text-center p-4">資料載入中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">持有帳號明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>公司：</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>姓名</th>
                        <th>證件狀態</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody"></tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
(function() {
    // --- 設定 ---
    // ‼️ 請務必確認這裡的網址是您自己的後端部署網址
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec";
    const userEmail = window.currentUserEmail;

    // --- DOM 元素 ---
    const tableElement = document.getElementById('delegableTable');
    const tableHead = tableElement.querySelector('thead');
    const tableBody = tableElement.querySelector('tbody');
    const modalElement = document.getElementById('detailsModal');
    const modalInstance = new bootstrap.Modal(modalElement);
    const modalCompanyName = document.getElementById('modalCompanyName');
    const modalTableBody = document.getElementById('modalTableBody');

    // --- 狀態變數 ---
    let originalData = []; // 存放從後端獲取的原始資料
    let displayData = [];  // 存放經過篩選和排序後要顯示的資料
    
    // --- 後端通訊 ---
    async function fetchDataFromBackend(action, payload = {}) {
        if (!userEmail) throw new Error("無法獲取登入狀態，請重新整理或登入。");
        const fullPayload = { action, email: userEmail, ...payload };
        const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
            method: 'POST', body: JSON.stringify(fullPayload), headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error(`網路錯誤: ${response.statusText}`);
        const result = await response.json();
        if (!result.success) throw new Error(result.data.message || "後端處理時發生未知錯誤");
        return result.data;
    }

    // --- 渲染表格 ---
    function renderTable() {
        tableBody.innerHTML = ""; // 清空舊資料
        if (displayData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">沒有找到符合條件的資料</td></tr>';
            return;
        }

        const fragment = document.createDocumentFragment();
        displayData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.stockCode || ''}</td>
                <td>${row.stockName || ''}</td>
                <td>${row.eVotingStartDate || '-'}</td>
                <td>${row.delegationDeadline || '-'}</td>
                <td>${row.delegationConditions || ''}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary view-details-btn"
                            data-stock-code="${row.stockCode}">
                        ${row.totalHoldingAccounts}
                    </button>
                </td>
                <td class="text-center">${row.delegatedAccounts}</td>
            `;
            fragment.appendChild(tr);
        });
        tableBody.appendChild(fragment);
    }

    // --- 初始化 ---
    async function initialize() {
        if (!userEmail) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center alert alert-danger">請先登入才能查看您的委託清單。</td></tr>';
            return;
        }
        
        try {
            originalData = await fetchDataFromBackend("getDelegableList");
            displayData = [...originalData]; // 初始顯示所有資料
            
            // 建立表頭
            tableHead.innerHTML = `
                <tr>
                    <th>股號</th>
                    <th>股名</th>
                    <th>電投開始日</th>
                    <th>委託截止日</th>
                    <th>委託條件</th>
                    <th class="text-center">持有帳號數</th>
                    <th class="text-center">已委託數</th>
                </tr>
            `;
            renderTable();

        } catch (error) {
            console.error("載入可委託清單失敗:", error);
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center alert alert-danger">${error.message}</td></tr>`;
        }
    }

    // --- 事件監聽 ---
    
    // 點擊「持有帳號數」按鈕，打開 Modal
    tableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('view-details-btn')) {
            const button = e.target;
            const stockCode = button.dataset.stockCode;
            const rowData = originalData.find(d => d.stockCode === stockCode);
            if (!rowData) return;

            modalCompanyName.textContent = `${rowData.stockName} (${rowData.stockCode})`;
            modalTableBody.innerHTML = ""; // 清空舊內容
            
            rowData.holdingsDetail.forEach(account => {
                let actionHtml = '';
                const docType = String(account.documentType || '').trim();
                const isDocMatch = rowData.delegationConditions.includes("身分證") ? docType === "身分證" : true;

                if (account.delegationStatus === '已委託') {
                    actionHtml = `<span class="badge bg-success">已委託</span>`;
                } else if (account.delegationStatus === '已收購') {
                    actionHtml = `<span class="badge bg-info">已收購</span>`;
                } else if (!isDocMatch) {
                    actionHtml = `<span class="badge bg-danger">證件不符</span>`;
                } else {
                    actionHtml = `
                        <button class="btn btn-primary btn-sm action-btn" data-status="已委託" data-account-name="${account.accountName}" data-stock-code="${stockCode}">我要委託</button>
                        <button class="btn btn-info btn-sm action-btn ms-1" data-status="已收購" data-account-name="${account.accountName}" data-stock-code="${stockCode}">我要收購</button>
                    `;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${account.accountName}</td>
                    <td>${docType || '未提供'}</td>
                    <td class="text-center">${actionHtml}</td>
                `;
                modalTableBody.appendChild(tr);
            });
            modalInstance.show();
        }
    });

    // 監聽 Modal 內部「操作按鈕」的點擊事件
    modalElement.addEventListener('click', async function(e) {
        if (e.target.classList.contains('action-btn')) {
            const btn = e.target;
            const newStatus = btn.dataset.status;
            const accountName = btn.dataset.accountName;
            const stockCode = btn.dataset.stockCode;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const result = await fetchDataFromBackend("updateDelegationStatus", { 
                    subAccountName: accountName, 
                    stockCode: stockCode, 
                    newStatus: newStatus 
                });
                modalInstance.hide();
                alert(result.message);
                initialize(); // 操作成功後，重新載入所有資料以更新主畫面
            } catch (error) {
                alert("更新失敗：" + error.message);
                btn.disabled = false;
                btn.textContent = newStatus === '已委託' ? '我要委託' : '我要收購';
            }
        }
    });

    // --- 啟動頁面 ---
    initialize();
})();
</script>
