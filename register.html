<!-- register.html -->

<!-- âœ… æ¡ç”¨èˆ‡ç™»å…¥é ä¸€è‡´çš„ placeholder é¢¨æ ¼ -->
<h3 class="text-center">ğŸ‘‹ è¨»å†Šæ–°å¸³è™Ÿ</h3>
<form id="registerForm" class="text-center mt-3" style="max-width: 400px; margin: auto;">
    <div class="mb-3">
        <input type="text" class="form-control" id="name" placeholder="å§“å" required />
    </div>
    <div class="mb-3">
        <input type="email" class="form-control" id="email" placeholder="Email (å°‡ä½œç‚ºæ‚¨çš„ç™»å…¥å¸³è™Ÿ)" required />
    </div>
    <div class="mb-3">
        <input type="password" class="form-control" id="password" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)" required minlength="6" />
    </div>
    <div class="mb-3">
        <input type="password" class="form-control" id="confirmPassword" placeholder="ç¢ºèªå¯†ç¢¼" required minlength="6" />
    </div>
    <button type="submit" class="btn btn-primary w-100 mb-3">ç¢ºèªè¨»å†Š</button>
    <div class="text-center">
        <a href="#" data-section="login">å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿè¿”å›ç™»å…¥</a>
    </div>
</form>

<!-- âœ… æ‚¨çš„æ ¸å¿ƒè¨»å†Šé‚è¼¯ï¼ŒåŒ…å«ã€å·²ä¿®æ­£ã€‘çš„å‡½æ•¸å‘¼å« -->
<script type="module">
    import { getApps, initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const firebaseConfig = { apiKey: "AIzaSyD9Bt0HwGGwlRT3_CWFBDhjGcnYf5lCuZU", authDomain: "goodaymember.firebaseapp.com", projectId: "goodaymember", storageBucket: "goodaymember.appspot.com", messagingSenderId: "730801053598", appId: "1:730801053598:web:a2ec0dc91c78fef6bfc08f" };
    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    const auth = getAuth(app);

    function initializeRegisterForm() {
        const registerForm = document.getElementById('registerForm');
        if (!registerForm) return;
        registerForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) { alert("éŒ¯èª¤ï¼šå…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ç›¸ç¬¦ï¼"); return; }
            if (!name) { alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥æ‚¨çš„å§“åï¼"); return; }

            const submitButton = registerForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = 'è™•ç†ä¸­...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const relayUrl = "https://script.google.com/macros/s/AKfycbzfj7nkQe1QnKiRedfYKeMBAAKVKAi17b0rEirrgzNd2AcTmgQcVvneIg5IlqQDtWaF/exec";
                const response = await fetch(relayUrl, { method: "POST", body: JSON.stringify({ action: "register", email, name }) });
                const result = await response.json();
                if (!result.success) { throw new Error(result.message || "å¯«å…¥æœƒå“¡è³‡æ–™å¤±æ•—"); }
                
                alert("âœ… è¨»å†ŠæˆåŠŸï¼å°‡ç‚ºæ‚¨è‡ªå‹•ç™»å…¥ã€‚");
                
                // âœ… ã€æœ€é‡è¦çš„ä¿®æ­£ã€‘ç¢ºä¿é€™è£¡çš„å‡½æ•¸åç¨±æ˜¯æ­£ç¢ºçš„
                if (window.updateMainAppLoginState) { 
                    window.updateMainAppLoginState(userCredential.user.email); 
                } else { 
                    window.location.reload(); 
                }
            } catch (error) {
                let message = "âŒ è¨»å†Šå¤±æ•—ï¼š";
                if (error.code) {
                     switch (error.code) {
                        case 'auth/email-already-in-use': message += "é€™å€‹ Email å·²ç¶“è¢«è¨»å†Šéäº†ã€‚"; break;
                        case 'auth/invalid-email': message += "Email æ ¼å¼ä¸æ­£ç¢ºã€‚"; break;
                        case 'auth/weak-password': message += "å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹è‡³å°‘è¨­å®š6ä½æ•¸ã€‚"; break;
                        default: message += "è«‹ç¨å¾Œå†è©¦ã€‚";
                    }
                } else { message += error.message; }
                alert(message);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
    }
    setTimeout(initializeRegisterForm, 0);
</script>
