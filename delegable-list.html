<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

<div class="container-fluid mt-2">
    <h2 class="mb-3">📥 可委託代領清單</h2>
    <p class="text-muted">這裡會列出所有您可以委託我們代領的股東會紀念品。您可以利用下方的搜尋功能快速找到目標公司。</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>股號</th>
                            <th>股名</th>
                            <th>電投開始日</th>
                            <th>委託截止日</th>
                            <th>委託條件</th>
                            <th class="text-center">持有帳號數</th>
                            <th class="text-center">已委託數</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">持有帳號明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>公司：</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>姓名</th>
                        <th>證件狀態</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const email = window.currentUserEmail; // 從主 app.js 獲取當前登入的用戶 Email
        if (!email) {
            $('#delegableTable').html('<tr><td colspan="7" class="text-center alert alert-danger">請先登入才能查看您的委託清單。</td></tr>');
            return;
        }

        const table = new DataTable('#delegableTable', {
            ajax: function (data, callback, settings) {
                $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center p-4">資料載入中...</td></tr>');
                
                google.script.run
                    .withSuccessHandler(function (response) {
                        if (response.status === "success") {
                            settings.ajax.appSettings = response.appSettings;
                            callback(response);
                        } else {
                            console.error("後端回傳錯誤:", response.message);
                            $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center alert alert-danger">' + (response.message || '資料載入失敗') + '</td></tr>');
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error("呼叫後端失敗:", error);
                        $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center alert alert-danger">無法載入資料，請檢查網路或聯繫管理員。</td></tr>');
                    })
                    .getDelegableListData(email);
            },
            columns: [
                { data: 'stockCode' },
                { data: 'stockName' },
                { data: 'eVotingStartDate' },
                { data: 'delegationDeadline' },
                { data: 'delegationConditions' },
                {
                    data: 'totalHoldingAccounts',
                    className: 'text-center',
                    render: function (data, type, row) {
                        if (data > 0) {
                            return `<button class="btn btn-sm btn-outline-primary view-details-btn"
                                            data-details='${JSON.stringify(row.holdingsDetail)}'
                                            data-company="${row.stockName} (${row.stockCode})"
                                            data-conditions="${row.delegationConditions}">
                                        ${data}
                                    </button>`;
                        }
                        return data;
                    }
                },
                { data: 'delegatedAccounts', className: 'text-center' }
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/zh-HANT.json'
            },
            responsive: true,
            order: [[3, 'asc']]
        });

        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        $('#delegableTable tbody').on('click', '.view-details-btn', function () {
            const details = JSON.parse($(this).attr('data-details'));
            const companyName = $(this).attr('data-company');
            const delegationConditions = $(this).attr('data-conditions');
            const appSettings = table.ajax.appSettings || { isDelegationAcquisitionEnabled: true };

            $('#modalCompanyName').text(companyName);
            const modalTableBody = $('#modalTableBody');
            modalTableBody.empty();

            details.forEach(account => {
                let actionHtml = '';
                
                if (account.isDelegated) {
                    actionHtml = `<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate" data-account-name="${account.accountName}">取消委託</button>`;
                } else {
                    let isDocumentMatch = true;
                    const docType = String(account.documentType || '').trim();
                    const requiresIDSpecific = delegationConditions.includes("身分證正本");
                    const requiresCertSpecific = delegationConditions.includes("證件正本");

                    if (requiresIDSpecific) {
                        if (docType !== "身分證") isDocumentMatch = false;
                    } else if (requiresCertSpecific) {
                        if (docType !== "身分證" && docType !== "健保卡") isDocumentMatch = false;
                    }

                    if (isDocumentMatch) {
                        if (appSettings.isDelegationAcquisitionEnabled) {
                            const requiresMailNotice = delegationConditions.includes("寄開會通知書給我");
                            let delegateButtonText = '委託';
                            if (requiresMailNotice) {
                                delegateButtonText = '委託 (需寄單)';
                            }
                            actionHtml = `
                                <button class="btn btn-primary btn-sm action-btn me-1" data-action="delegate" data-account-name="${account.accountName}" data-company-name="${companyName}" data-is-requires-mail="${requiresMailNotice}">
                                    ${delegateButtonText}
                                </button>
                                <button class="btn btn-info btn-sm action-btn" data-action="acquire" data-account-name="${account.accountName}" data-company-name="${companyName}">
                                    收購
                                </button>
                            `;
                        } else {
                            actionHtml = '<span class="badge bg-secondary">功能維護中</span>';
                        }
                    } else {
                        actionHtml = '<span class="badge bg-danger" title="證件不符合委託條件">X (不可操作)</span>';
                    }
                }

                const rowHtml = `<tr>
                                    <td>${account.accountName}</td>
                                    <td>${account.documentType || '未提供'}</td>
                                    <td class="text-center">${actionHtml}</td>
                                </tr>`;
                modalTableBody.append(rowHtml);
            });

            detailsModal.show();
        });

        $('#modalTableBody').on('click', '.action-btn', function () {
            const actionType = $(this).data('action');
            const accountName = $(this).data('account-name');
            const companyName = $(this).data('company-name');
            const requiresMailNotice = $(this).data('is-requires-mail');

            if (actionType === 'delegate') {
                if (requiresMailNotice) {
                    alert(`模擬：這是「需寄單」委託。\n帳號: ${accountName}\n公司: ${companyName}`);
                } else {
                    alert(`模擬：執行「委託」操作！\n帳號: ${accountName}\n公司: ${companyName}`);
                }
            } else if (actionType === 'acquire') {
                alert(`模擬：執行「收購」操作！\n帳號: ${accountName}\n公司: ${companyName}`);
            } else if (actionType === 'cancel-delegate') {
                alert(`模擬：執行「取消委託」操作！\n帳號: ${accountName}\n公司: ${companyName}`);
            }
            detailsModal.hide();
        });
    });
</script>
