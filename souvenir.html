<!-- souvenir.html -->
<section id="page-souvenir" class="page-container">
  <div class="souvenir-wrapper mt-2">
    <!-- æ§åˆ¶åˆ—ï¼šå·¦å´æ¨™é¡Œï¼Œå³å´æœå°‹ï¼‹ç­†æ•¸ -->
    <div
      class="align-items-center flex-wrap gap-2 table-controls-fixed d-flex justify-content-between "
      id="souvenirControlsContainer"
    >
      <h3 class="mb-0">ğŸ ç´€å¿µå“</h3>
      <!-- é€™è£¡æœƒç”± JS å‹•æ…‹æ’å…¥æœå°‹å’Œç­†æ•¸æ§åˆ¶ -->
    </div>

    <!-- è³‡æ–™è¡¨å€ -->
    <div class="table-scroll-container table-responsive">
      <table class="table table-bordered table-sm" id="souvenirTable">
        <thead class="table-warning"></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- åˆ†é æŒ‰éˆ• -->
    <div id="souvenirPaginationWrapper">
      <div id="souvenirPagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
  </div>
</section>

<script>
  function loadSouvenirDataWithoutDataTables() {
    const container = document.getElementById("souvenirControlsContainer");
    // ç§»é™¤èˆŠçš„ control-group
    container.querySelectorAll(".control-group").forEach(el => el.remove());

    fetch('https://opensheet.elk.sh/1z4SqcpGbhVtb5I6hQZ5aI9PQTNt2_64-ZFdc0_cV3kE/ç´€å¿µå“è³‡è¨Š')
      .then(res => res.json())
      .then(data => {
        // *** æ–°å¢æœå°‹ï¼‹ç­†æ•¸çš„å®¹å™¨ ***
        const controls = document.createElement('div');
        controls.className = 'd-flex justify-content-between align-items-center mb-1 flex-wrap control-group';  /* â† ä¿®æ”¹ï¼šæ–°å¢ class control-group */
        controls.innerHTML = `
          <div class="mb-0">
            <label for="rowsPerPageSelect" class="me-1">ç­†æ•¸ï¼š</label>
            <select id="rowsPerPageSelect" class="form-select form-select-sm d-inline-block me-3" style="width: 70px;">
              <option value="10">10</option><option value="25">25</option>
              <option value="50">50</option><option value="100">100</option>
            </select>
          </div>
          <div class="mb-0">
            <label for="searchInput" class="me-1">æœå°‹ï¼š</label>
            <input type="text" id="searchInput" class="form-control form-control-sm d-inline-block" style="width: 100px;" placeholder="è¼¸å…¥é—œéµå­—">
          </div>
        `;
        container.appendChild(controls);  /* â† ä¿®æ”¹ï¼šåœ¨æ§åˆ¶åˆ—æ’å…¥ */
                const controlsContainer = document.getElementById('souvenirControlsContainer');
                if (controlsContainer) controlsContainer.appendChild(controls);

                if (!data || data.length === 0) {
                    tableHead.innerHTML = ''; tableBody.innerHTML = '<tr><td colspan="100%">æ²’æœ‰å¯ç”¨çš„è³‡æ–™</td></tr>'; return;
                }

                const headers = Object.keys(data[0]);
                let currentPage = 1; let rowsPerPage = 10; let sortKey = "è‚¡è™Ÿ"; let sortAsc = true;
                let sortedData = [...data]; let filteredData = [...data];

                tableHead.innerHTML = `<tr>${headers.map(h => `<th class="sortable" data-key="${h}">${h} â–²</th>`).join('')}</tr>`;
                headers.forEach(h => {
                    const th = tableHead.querySelector(`th[data-key="${h}"]`);
                    if (th) { th.style.cursor = 'pointer'; th.addEventListener('click', () => sortTable(h)); }
                });

                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const keyword = e.target.value.trim().toLowerCase();
                    filteredData = sortedData.filter(row => headers.some(h => (row[h] || '').toLowerCase().includes(keyword)));
                    currentPage = 1; renderTable();
                });

                document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => {
                    rowsPerPage = parseInt(e.target.value); currentPage = 1; renderTable();
                });

                let firstLoad = true;
                function sortTable(key) {
                    if (firstLoad) { firstLoad = false; sortAsc = true; } else { sortAsc = (sortKey === key) ? !sortAsc : true; }
                    sortKey = key;
                    sortedData.sort((a, b) => {
                        const valA = a[key] || ''; const valB = b[key] || ''; const isNumber = !isNaN(valA) && !isNaN(valB);
                        return isNumber ? (sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA)) : (sortAsc ? valA.localeCompare(valB, 'zh-Hant') : valB.localeCompare(valA, 'zh-Hant'));
                    });
                    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
                    filteredData = keyword ? sortedData.filter(row => headers.some(h => (row[h] || '').toLowerCase().includes(keyword))) : [...sortedData];
                    currentPage = 1; renderTable();
                }

                function renderTable() {
                    const start = (currentPage - 1) * rowsPerPage; const end = start + rowsPerPage;
                    const pageData = filteredData.slice(start, end);
                    tableBody.innerHTML = pageData.map(row => `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('');
                    renderPagination();
                }

                function renderPagination() {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage); const maxVisible = 3; const pageButtons = [];
                    pageButtons.push(`<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">ä¸Šé </button>`);
                    let start = currentPage; let end = Math.min(totalPages, currentPage + 2);
                    if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
                    if (start > 1) { pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="goToPage(1)">1</button>`); if (start > 2) pageButtons.push(`<span class="me-1">...</span>`); }
                    for (let i = start; i <= end; i++) { pageButtons.push(`<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} me-1" onclick="goToPage(${i})">${i}</button>`); }
                    if (end < totalPages) { if (end < totalPages - 1) pageButtons.push(`<span class="me-1">...</span>`); pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="goToPage(${totalPages})">${totalPages}</button>`); }
                    pageButtons.push(`<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(1)">ä¸‹é </button>`);
                    document.getElementById('souvenirPagination').innerHTML = pageButtons.join('');
                }

                // å°‡é€™äº›å‡½æ•¸æ›è¼‰åˆ° windowï¼Œä»¥ä¾¿ onclick å±¬æ€§å¯ä»¥æ‰¾åˆ°å®ƒå€‘
                window.changePage = function(offset) { currentPage += offset; renderTable(); };
                window.goToPage = function(page) { currentPage = page; renderTable(); };

                sortAsc = true; sortTable(sortKey);
            })
            .catch(error => { console.error('è¼‰å…¥ç´€å¿µå“è³‡æ–™éŒ¯èª¤ï¼š', error); });
    }

// âœ… åŠ ä¸Šé€™å€‹ã€Œå®‰å…¨å•Ÿå‹•ã€é‚è¼¯
if (document.readyState === 'loading') {
    // å¦‚æœæ–‡ä»¶é‚„åœ¨è¼‰å…¥ä¸­ï¼ˆç†è«–ä¸Šä¸å¤ªæœƒç™¼ç”Ÿï¼Œä½†é€™æ˜¯æœ€ä¿éšªçš„å¯«æ³•ï¼‰ï¼Œ
    // å°±ç­‰å®ƒè¼‰å…¥å®Œç•¢å†åŸ·è¡Œã€‚
    document.addEventListener('DOMContentLoaded', loadSouvenirDataWithoutDataTables);
} else {
    // å¦‚æœæ–‡ä»¶å·²ç¶“è¼‰å…¥å®Œç•¢ï¼Œå°±ç›´æ¥åŸ·è¡Œã€‚
    // å°æ–¼å‹•æ…‹è¼‰å…¥çš„è…³æœ¬ï¼Œé€šå¸¸æœƒèµ°é€™ä¸€æ¢è·¯ã€‚
    loadSouvenirDataWithoutDataTables();
}
</script>
