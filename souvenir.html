<div class="souvenir-wrapper mt-2 mt-md-0">
    <div class="table-controls-fixed" id="souvenirControlsContainer"></div>
    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="souvenirTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="souvenirPaginationWrapper">
        <div id="souvenirPagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>

<script>
    function loadSouvenirDataWithoutDataTables() {
        fetch('https://opensheet.elk.sh/1z4SqcpGbhVtb5I6hQZ5aI9PQTNt2_64-ZFdc0_cV3kE/ç´€å¿µå“è³‡è¨Š')
            .then(res => res.json())
            .then(data => {
                const tableElement = document.getElementById('souvenirTable');
                const tableHead = tableElement.querySelector('thead');
                const tableBody = tableElement.querySelector('tbody');
                const controlsContainer = document.getElementById('souvenirControlsContainer');

if (controlsContainer) {
  controlsContainer.innerHTML = `
    <div class="d-block d-md-flex align-items-center w-100 mb-1 px-3 gap-3 justify-content-start flex-wrap">

      <!-- ğŸ æ¨™é¡Œ -->
      <div class="me-3">
        <h3 class="mt-1 mb-1 mb-md-0">ğŸ ç´€å¿µå“</h3>
      </div>

      <!-- ğŸ“Š ç­†æ•¸ + æœå°‹æ¬„ -->
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <div>
          <label for="rowsPerPageSelect" class="form-label mb-0 me-1">ç­†æ•¸:</label>
          <select id="rowsPerPageSelect" class="form-select form-select-sm d-inline-block" style="width: 80px;">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div>
          <label for="searchInput" class="form-label mb-0 me-1">æœå°‹:</label>
          <input type="text" id="searchInput" class="form-control form-control-sm d-inline-block" style="width: 150px;" placeholder="é—œéµå­—...">
        </div>
      </div>

    </div>
  `;
}


                if (!data || data.length === 0) {
                    tableHead.innerHTML = '';
                    tableBody.innerHTML = '<tr><td colspan="100%">æ²’æœ‰å¯ç”¨çš„è³‡æ–™</td></tr>';
                    return;
                }

                const headers = Object.keys(data[0]);
                let currentPage = 1;
                let rowsPerPage = 10;
                let sortKey = "è‚¡è™Ÿ";
                let sortAsc = true;
                let sortedData = [...data];
                let filteredData = [...data];
                let firstLoad = true; // âœ… ã€é‚„åŸã€‘ä½¿ç”¨æ‚¨åŸæœ¬çš„ firstLoad æ——æ¨™

                tableHead.innerHTML = `<tr>${headers.map(h => `<th class="sortable" data-key="${h}" style="cursor: pointer;">${h} <span></span></th>`).join('')}</tr>`;
                
                function updateSortIndicator() {
                    tableHead.querySelectorAll('th.sortable span').forEach(span => span.textContent = '');
                    const th = tableHead.querySelector(`th[data-key="${sortKey}"] span`);
                    if (th) th.textContent = sortAsc ? ' â–²' : ' â–¼';
                }

                // âœ… ã€é‚„åŸã€‘ä½¿ç”¨æ‚¨æœ€åˆçš„ forEach è¿´åœˆæ–¹å¼ä¾†ç‚ºæ¯å€‹æ¨™é¡Œç¶å®šæ’åºäº‹ä»¶
                headers.forEach(h => {
                    const th = tableHead.querySelector(`th[data-key="${h}"]`);
                    if (th) {
                        th.addEventListener('click', () => sortTable(h));
                    }
                });

                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const keyword = e.target.value.trim().toLowerCase();
                    filteredData = sortedData.filter(row => headers.some(h => String(row[h] || '').toLowerCase().includes(keyword)));
                    currentPage = 1;
                    renderTable();
                });

                document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => {
                    rowsPerPage = parseInt(e.target.value);
                    currentPage = 1;
                    renderTable();
                });

                // âœ… ã€é‚„åŸã€‘ä½¿ç”¨æ‚¨æœ€åˆçš„ sortTable å‡½å¼é‚è¼¯
                function sortTable(key) {
                    if (firstLoad) {
                        firstLoad = false;
                        sortAsc = true;
                    } else {
                        sortAsc = (sortKey === key) ? !sortAsc : true;
                    }
                    sortKey = key;
                    
                    sortedData.sort((a, b) => {
                        const valA = a[key] || '';
                        const valB = b[key] || '';
                        const isNumber = !isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB)) && isFinite(valA) && isFinite(valB);
                        if (isNumber) {
                           return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
                        } else {
                           return sortAsc ? String(valA).localeCompare(String(valB), 'zh-Hant') : String(valB).localeCompare(String(valA), 'zh-Hant');
                        }
                    });
                    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
                    filteredData = keyword ? sortedData.filter(row => headers.some(h => String(row[h] || '').toLowerCase().includes(keyword))) : [...sortedData];
                    currentPage = 1;
                    renderTable();
                }

                function renderTable() {
                    const start = (currentPage - 1) * rowsPerPage;
                    const end = start + rowsPerPage;
                    const pageData = filteredData.slice(start, end);
                    tableBody.innerHTML = pageData.map(row => `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('');
                    renderPagination();
                    updateSortIndicator();
                }

                function renderPagination() {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    const paginationContainer = document.getElementById('souvenirPagination');
                    paginationContainer.innerHTML = ''; 
                    if (totalPages <= 0) return;

                    const pageButtons = [];
                    pageButtons.push(`<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">ä¸Šé </button>`);
                    
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, currentPage + 2);

                    if (startPage > 1) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="goToPage(1)">1</button>`);
                    if (startPage > 2) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
                    for (let i = startPage; i <= endPage; i++) {
                        pageButtons.push(`<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} me-1" onclick="goToPage(${i})">${i}</button>`);
                    }
                    if (endPage < totalPages - 1) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
                    if (endPage < totalPages) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="goToPage(${totalPages})">${totalPages}</button>`);

                    pageButtons.push(`<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} onclick="changePage(1)">ä¸‹é </button>`);
                    paginationContainer.innerHTML = pageButtons.join('');
                }

                window.changePage = (offset) => { currentPage += offset; renderTable(); };
                window.goToPage = (page) => { currentPage = page; renderTable(); };

                sortTable(sortKey);
            })
            .catch(error => {
                console.error('è¼‰å…¥ç´€å¿µå“è³‡æ–™éŒ¯èª¤ï¼š', error);
                document.getElementById('souvenirTable').querySelector('tbody').innerHTML = '<tr><td colspan="100%" class="text-danger text-center">è³‡æ–™è¼‰å…¥å¤±æ•—</td></tr>';
            });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadSouvenirDataWithoutDataTables);
    } else {
        loadSouvenirDataWithoutDataTables();
    }
</script>
