<style>
    /* 這裡可以放這個頁面專屬的 CSS */
    .add-account-container {
        width: 100%;
        max-width: 500px;  /* 調整為更合理的寬度 */
        margin: 40px auto;
        padding: 20px;
        background-color: #6E97FF;
        border-radius: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: white; /* 確保內部文字顏色可見 */
    }
    .add-account-container h3 {
      color: white; /* 標題顏色 */
      text-align: center;
      margin-bottom: 20px;
    }
    .add-account-container label {
      color: white; /* 標籤顏色 */
      margin-top: 10px;
    }
    .add-account-container .btn-operate {
      width: 100%;
      background-color: #ffc107;
      border: none;
      border-radius: 8px;
      color: black;
      margin-top: 20px;
    }
    .add-account-container .message-box {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      display: none;
      font-weight: bold;
    }
    .add-account-container .message-box.alert-success {
      background-color: #d1e7dd; /* 淺綠色 */
      color: #0f5132; /* 深綠色文字 */
    }
    .add-account-container .message-box.alert-danger {
      background-color: #f8d7da; /* 淺紅色 */
      color: #842029; /* 深紅色文字 */
    }
    .add-account-container .form-control, .add-account-container .form-select {
      margin-bottom: 10px;
      background-color: rgba(255, 255, 255, 0.2); /* 輸入框半透明背景 */
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
    }
    .add-account-container .form-control::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    .add-account-container .form-select option {
        background-color: #6E97FF; /* 下拉選單選項背景 */
        color: white;
    }
    .add-account-container .form-check-label {
        color: white;
    }
</style>

<div class="add-account-container">
    <h3>📊 新增帳號／持股</h3>

    <div class="mb-3 text-white">登入者: <span id="currentUserName">載入中...</span></div>

    <div class="mb-3">
      <label for="subAccountSelect">選擇子帳號</label>
      <select class="form-select" id="subAccountSelect">
        <option value="">請選擇子帳號</option>
      </select>
    </div>

    <div id="addSubBtnWrapper" class="mb-3">
      <button type="button" class="btn btn-outline-light" onclick="toggleSubAccountInput(true)">➕ 新增子帳號</button>
    </div>
    <div id="addSubWrapper" class="mb-3" style="display:none;">
      <input type="text" class="form-control" id="newSubAccountInput" placeholder="請輸入子帳號名稱">
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-secondary" onclick="toggleSubAccountInput(false)">取消</button>
        <button class="btn btn-primary" onclick="saveNewSubAccount()">儲存</button>
      </div>
    </div>

    <label for="stockInput">輸入股號</label>
    <textarea id="stockInput" class="form-control" rows="4" placeholder="例：1101,1102"></textarea>

    <label class="mt-2">選擇操作類型：</label>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="operationType" id="opAdd" value="add" checked>
      <label class="form-check-label text-white" for="opAdd">新增上列持股 (追加)</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="operationType" id="opOverwrite" value="overwrite">
      <label class="form-check-label text-white" for="opOverwrite">上列持股覆蓋原本持股 (清空後寫入)</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="operationType" id="opDelete" value="delete">
      <label class="form-check-label text-white" for="opDelete">刪除上列持股 (從現有清單移除)</label>
    </div>

    <button class="btn btn-operate" onclick="executeOperation()">執行操作</button>

    <div id="messageBox" class="message-box"></div>
</div>

<script>
    // ✅ 請替換成您部署的 Apps Script Web 應用程式 URL
    // 這個 URL 是您在 Apps Script 專案中，點擊「部署」->「管理部署作業」後，複製「網路應用程式 URL」得到的
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzk_RKeBgLtWsVJe79WUIYklyOnLL94nVZ41rb_zG_bV-LOSsi9PtSHQX0H0a2hMId0/exec";

    let accountsData = [];

    // 從後端獲取數據的通用函數
    async function fetchDataFromBackend(action, payload = {}) {
        const fullPayload = { action, ...payload };
        try {
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(fullPayload),
            });

            if (!response.ok) {
                // 如果 HTTP 狀態碼不是 2xx，拋出錯誤
                const errorText = await response.text();
                throw new Error(`HTTP Error ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            if (result.status === "error") {
                throw new Error(result.data.message || "後端處理錯誤");
            }
            return result.data; // 返回後端回應的 data 部分
        } catch (error) {
            console.error("Fetch Data Error:", error);
            throw error; // 重新拋出錯誤，讓調用者處理
        }
    }

    // 頁面載入時初始化數據
    document.addEventListener("DOMContentLoaded", async function () {
        // 獲取當前登入用戶的 Email
        // 在前端，您需要有一種方式來獲取用戶 Email。
        // 如果您使用 Firebase Authentication，可以從 firebase.auth().currentUser.email 取得。
        // 這裡我們假設在 `window.currentUserEmail` 已經設定了登入者的 Email。
        // 🚨 這是關鍵！您必須確保 `window.currentUserEmail` 在這個頁面載入前已經被設定。
        // 例如，在 index.html 的主腳本中，當 Firebase 用戶狀態改變時，設定這個變數：
        // onAuthStateChanged(auth, (user) => {
        //     window.currentUserEmail = user ? user.email : null;
        //     // ... 載入 add-account-shares.html 時，這個值就會存在
        // });
        const userEmail = window.currentUserEmail || "測試帳號@example.com"; // 如果沒有實際的登入email，提供一個預設值用於測試

        try {
            const data = await fetchDataFromBackend("getAccountData", { userEmail: userEmail });
            document.getElementById("currentUserName").textContent = data.currentUserName;

            accountsData = data.accounts || [];
            const select = document.getElementById("subAccountSelect");
            select.innerHTML = '<option value="">請選擇子帳號</option>'; // 清空並添加預設選項
            accountsData.forEach(name => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = name;
                select.appendChild(opt);
            });
            // 如果後端有返回新建立的子帳號，選擇它
            const newSubAccountToSelect = localStorage.getItem('newSubAccountSelected');
            if (newSubAccountToSelect && accountsData.includes(newSubAccountToSelect)) {
                select.value = newSubAccountToSelect;
                localStorage.removeItem('newSubAccountSelected'); // 用過就清除
            }
        } catch (e) {
            displayMessage("載入帳號資料失敗：" + e.message, "danger");
            console.error("初始化失敗:", e);
        }
    });

    // 顯示訊息框
    function displayMessage(msg, type) {
      const box = document.getElementById("messageBox");
      box.className = `message-box alert-${type}`;
      box.textContent = msg;
      box.style.display = "block";
      // 5秒後自動隱藏訊息
      setTimeout(() => {
          box.style.display = "none";
      }, 5000);
    }

    // 切換新增子帳號的輸入框顯示
    function toggleSubAccountInput(show) {
      document.getElementById("addSubBtnWrapper").style.display = show ? "none" : "block";
      document.getElementById("addSubWrapper").style.display = show ? "block" : "none";
      if (!show) {
        document.getElementById("newSubAccountInput").value = "";
      }
    }

    // 儲存新子帳號
    async function saveNewSubAccount() {
      const name = document.getElementById("newSubAccountInput").value.trim();
      if (!name) {
        return displayMessage("請輸入子帳號名稱", "danger");
      }
      const userEmail = window.currentUserEmail || "測試帳號@example.com";

      try {
        // 呼叫後端 Apps Script 函數
        const result = await fetchDataFromBackend("addAndSelectSubAccount", { name: name, userEmail: userEmail });
        displayMessage(result.message, result.success ? "success" : "danger");

        if (result.success) {
          localStorage.setItem('newSubAccountSelected', name); // 儲存新建立的子帳號名稱，用於重新載入後選中
          // 重新載入頁面以更新子帳號下拉選單
          // 由於這是動態載入的頁面，直接 reload() 會重新載入整個 index.html
          // 更好的做法是重新呼叫初始化函數來更新下拉選單
          toggleSubAccountInput(false); // 隱藏輸入框
          await document.dispatchEvent(new Event('DOMContentLoaded
