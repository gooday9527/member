<div class="souvenir-wrapper pt-2 pb-2 pt-md-0 pb-md-0">
    <div class="table-controls-fixed" id="delegableControlsContainer"></div>
    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="delegableListTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="delegablePaginationWrapper">
        <div id="delegablePagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>å§“å</th>
                                <th>è­‰ä»¶ç‹€æ…‹</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadDelegableData() {
        const email = window.currentUserEmail;
        if (!email) {
            document.getElementById('delegableListTable').querySelector('tbody').innerHTML = '<tr><td colspan="100%" class="text-center text-danger">è«‹å…ˆç™»å…¥</td></tr>';
            return;
        }

        // âœ… ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°‡ fetch æ”¹ç‚º google.script.run
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status !== 'success' || !response.data) {
                    console.error("å¾Œç«¯å›å‚³éŒ¯èª¤:", response.message);
                    document.getElementById('delegableListTable').querySelector('tbody').innerHTML = '<tr><td colspan="100%" class="text-danger text-center">è³‡æ–™è¼‰å…¥å¤±æ•—: ' + (response.message || 'æœªçŸ¥éŒ¯èª¤') + '</td></tr>';
                    return;
                }

                // æˆåŠŸå–å¾—è³‡æ–™å¾Œï¼Œé–‹å§‹åŸ·è¡Œæ‚¨çš„å®¢è£½åŒ–è¡¨æ ¼é‚è¼¯
                const rawData = response.data;
                const appSettings = response.appSettings || { isDelegationAcquisitionEnabled: true }; // å¾å¾Œç«¯å–å¾—è¨­å®š
                const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

                const tableElement = document.getElementById('delegableListTable');
                const tableHead = tableElement.querySelector('thead');
                const tableBody = tableElement.querySelector('tbody');
                const controlsContainer = document.getElementById('delegableControlsContainer');

                // æ³¨å…¥æ§åˆ¶é … (æœå°‹ã€ç­†æ•¸)
                if (controlsContainer) {
                    controlsContainer.innerHTML = `
                    <div class="d-block d-md-flex align-items-center gap-3 mb-2 mb-md-0 px-3">
                        <div class="me-3">
                            <h3 class="mt-1 mb-1 mb-md-0" style="white-space: nowrap; min-width: 100px;">ğŸ“¥ å¯å§”è¨—æ¸…å–®</h3>
                        </div>
                        <div class="d-flex align-items-center gap-2 flex-nowrap w-100" style="overflow-x: auto;">
                            <div class="d-flex align-items-center">
                                <label for="rowsPerPageSelect" class="form-label mb-0 me-0 me-md-1">ç­†æ•¸:</label>
                                <select id="rowsPerPageSelect" class="form-select form-select-sm" style="width: 80px;">
                                    <option>10</option><option>25</option><option>50</option><option>100</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="searchInput" class="form-label mb-0 me-0 me-md-1">æœå°‹:</label>
                                <input type="text" id="searchInput" class="form-control form-control-sm" style="min-width: 100px; max-width: 150px;" placeholder="é—œéµå­—...">
                            </div>
                        </div>
                    </div>`;
                }

                if (!rawData || rawData.length === 0) {
                    tableHead.innerHTML = '';
                    tableBody.innerHTML = '<tr><td colspan="100%">æ²’æœ‰å¯ç”¨çš„è³‡æ–™</td></tr>';
                    return;
                }

                // âœ… å®šç¾©è¦é¡¯ç¤ºçš„æ¬„ä½é †åº + æ–°å¢ã€Œæ“ä½œã€æ¬„ä½
                const columnsToDisplay = ['è‚¡è™Ÿ', 'è‚¡å', 'é›»æŠ•é–‹å§‹æ—¥', 'å§”è¨—æˆªæ­¢æ—¥', 'å§”è¨—æ¢ä»¶', 'æŒæœ‰å¸³è™Ÿæ•¸', 'å·²å§”è¨—æ•¸'];
                
                let currentPage = 1;
                let rowsPerPage = 10;
                let sortKey = "å§”è¨—æˆªæ­¢æ—¥"; // é è¨­æ’åºæ¬„ä½
                let sortAsc = true;
                let sortedData = [...rawData];
                let filteredData = [...rawData];

                // ç”¢ç”Ÿè¡¨é ­
                tableHead.innerHTML = `<tr>${columnsToDisplay.map(h => `<th class="sortable" data-key="${h}" style="cursor: pointer;">${h} <span></span></th>`).join('')}</tr>`;
                
                function updateSortIndicator() {
                    tableHead.querySelectorAll('th.sortable span').forEach(span => span.textContent = '');
                    const th = tableHead.querySelector(`th[data-key="${sortKey}"] span`);
                    if (th) th.textContent = sortAsc ? ' â–²' : ' â–¼';
                }

                tableHead.querySelectorAll('th.sortable').forEach(th => {
                    th.addEventListener('click', (e) => sortTable(e.currentTarget.dataset.key));
                });
                
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const keyword = e.target.value.trim().toLowerCase();
                    filteredData = sortedData.filter(row => columnsToDisplay.some(h => String(row[h] || '').toLowerCase().includes(keyword)));
                    currentPage = 1;
                    renderTable();
                });

                document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => {
                    rowsPerPage = parseInt(e.target.value);
                    currentPage = 1;
                    renderTable();
                });

                function sortTable(key) {
                    sortAsc = (sortKey === key) ? !sortAsc : true;
                    sortKey = key;
                    
                    sortedData.sort((a, b) => {
                        const valA = a[key] || '';
                        const valB = b[key] || '';
                        const isNumber = !isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB)) && isFinite(valA) && isFinite(valB);
                        if (isNumber) {
                            return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
                        } else {
                            return sortAsc ? String(valA).localeCompare(String(valB), 'zh-Hant') : String(valB).localeCompare(String(valA), 'zh-Hant');
                        }
                    });
                    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
                    filteredData = keyword ? sortedData.filter(row => columnsToDisplay.some(h => String(row[h] || '').toLowerCase().includes(keyword))) : [...sortedData];
                    currentPage = 1;
                    renderTable();
                }

                function renderTable() {
                    const start = (currentPage - 1) * rowsPerPage;
                    const end = start + rowsPerPage;
                    const pageData = filteredData.slice(start, end);
                    
                    // âœ… ã€æ ¸å¿ƒä¿®æ”¹ã€‘é‡æ–°æ•´åˆã€Œæ“ä½œã€æŒ‰éˆ•çš„ç”¢ç”Ÿé‚è¼¯
                    tableBody.innerHTML = pageData.map(row => {
                        const cells = columnsToDisplay.map(key => {
                            let cellContent = row[key] || '';
                            // ç‰¹åˆ¥è™•ç†ã€ŒæŒæœ‰å¸³è™Ÿæ•¸ã€ï¼Œå¦‚æœå¤§æ–¼ 0ï¼Œå°±è®ŠæˆæŒ‰éˆ•
                            if (key === 'æŒæœ‰å¸³è™Ÿæ•¸' && cellContent > 0) {
                                return `<td class="text-center"><button class="btn btn-sm btn-outline-primary view-details-btn">${cellContent}</button></td>`;
                            }
                            if (key === 'å·²å§”è¨—æ•¸' || key === 'æŒæœ‰å¸³è™Ÿæ•¸') {
                                return `<td class="text-center">${cellContent}</td>`;
                            }
                            return `<td>${cellContent}</td>`;
                        }).join('');
                        return `<tr data-row-details='${JSON.stringify(row)}'>${cells}</tr>`;
                    }).join('');
                    
                    // ç‚ºæ–°ç”¢ç”Ÿçš„æŒ‰éˆ•ç¶å®šäº‹ä»¶
                    tableBody.querySelectorAll('.view-details-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const rowData = JSON.parse(e.currentTarget.closest('tr').dataset.rowDetails);
                            showDetailsModal(rowData);
                        });
                    });

                    renderPagination();
                    updateSortIndicator();
                }
                
                function showDetailsModal(rowData) {
                    const companyName = `${rowData.stockName} (${rowData.stockCode})`;
                    const delegationConditions = rowData.delegationConditions;
                    const details = rowData.holdingsDetail;

                    document.getElementById('modalCompanyName').innerText = companyName;
                    const modalTableBody = document.getElementById('modalTableBody');
                    modalTableBody.innerHTML = ''; // æ¸…ç©º

                    details.forEach(account => {
                        let actionHtml = '';
                        if (account.isDelegated) {
                            actionHtml = `<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate">å–æ¶ˆå§”è¨—</button>`;
                        } else {
                            let isDocumentMatch = true;
                            const docType = String(account.documentType || '').trim();
                            if (delegationConditions.includes("èº«åˆ†è­‰æ­£æœ¬") && docType !== "èº«åˆ†è­‰") isDocumentMatch = false;
                            if (delegationConditions.includes("è­‰ä»¶æ­£æœ¬") && !["èº«åˆ†è­‰", "å¥ä¿å¡"].includes(docType)) isDocumentMatch = false;

                            if (isDocumentMatch && appSettings.isDelegationAcquisitionEnabled) {
                                const btnText = delegationConditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘") ? 'å§”è¨— (éœ€å¯„å–®)' : 'å§”è¨—';
                                actionHtml = `
                                    <button class="btn btn-primary btn-sm action-btn me-1" data-action="delegate" data-requires-mail="${delegationConditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘")}">${btnText}</button>
                                    <button class="btn btn-info btn-sm action-btn" data-action="acquire">æ”¶è³¼</button>`;
                            } else if (!isDocumentMatch) {
                                actionHtml = `<span class="badge bg-danger" title="è­‰ä»¶ä¸ç¬¦åˆå§”è¨—æ¢ä»¶">X (ä¸å¯æ“ä½œ)</span>`;
                            } else {
                                actionHtml = `<span class="badge bg-secondary">åŠŸèƒ½ç¶­è­·ä¸­</span>`;
                            }
                        }
                        const rowHtml = `<tr>
                            <td>${account.accountName}</td>
                            <td>${account.documentType || 'æœªæä¾›'}</td>
                            <td class="text-center" data-account-name="${account.accountName}" data-company-name="${companyName}">${actionHtml}</td>
                        </tr>`;
                        modalTableBody.insertAdjacentHTML('beforeend', rowHtml);
                    });
                    detailsModal.show();
                }

                // Modal å…§éƒ¨æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ (äº‹ä»¶å§”æ´¾)
                document.getElementById('modalTableBody').addEventListener('click', function(e) {
                    if (e.target.classList.contains('action-btn')) {
                        const button = e.target;
                        const cell = button.closest('td');
                        const action = button.dataset.action;
                        const accountName = cell.dataset.accountName;
                        const companyName = cell.dataset.companyName;

                        alert(`æ¨¡æ“¬æ“ä½œï¼š\né¡å‹: ${action}\nå…¬å¸: ${companyName}\nå¸³è™Ÿ: ${accountName}`);
                        detailsModal.hide();
                    }
                });


                function renderPagination() {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    const paginationContainer = document.getElementById('delegablePagination');
                    paginationContainer.innerHTML = '';
                    if (totalPages <= 1) return;

                    let pageButtons = [];
                    pageButtons.push(`<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">ä¸Šé </button>`);
                    
                    let startPage = Math.max(1, currentPage - 2);
                    let endPage = Math.min(totalPages, currentPage + 2);

                    if (startPage > 1) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="goToPage(1)">1</button>`);
                    if (startPage > 2) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
                    
                    for (let i = startPage; i <= endPage; i++) {
                        pageButtons.push(`<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} me-1" onclick="goToPage(${i})">${i}</button>`);
                    }
                    
                    if (endPage < totalPages - 1) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
                    if (endPage < totalPages) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="goToPage(${totalPages})">${totalPages}</button>`);

                    pageButtons.push(`<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(1)">ä¸‹é </button>`);
                    paginationContainer.innerHTML = pageButtons.join('');
                }

                window.changePage = (offset) => { currentPage += offset; renderTable(); };
                window.goToPage = (page) => { currentPage = page; renderTable(); };
                
                // åˆå§‹è¼‰å…¥
                sortTable(sortKey);
            })
            .withFailureHandler(function(error) {
                console.error('å‘¼å«å¾Œç«¯å¤±æ•—:', error);
                document.getElementById('delegableListTable').querySelector('tbody').innerHTML = '<tr><td colspan="100%" class="text-danger text-center">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚</td></tr>';
            })
            .getDelegableListData(email);
    }

    // å•Ÿå‹•å‡½å¼
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDelegableData);
    } else {
        loadDelegableData();
    }
</script>
