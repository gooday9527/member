<h3 class="text-center">ğŸ” ç™»å…¥</h3>
<form id="loginForm" class="text-center mt-3" style="max-width: 400px; margin: auto;">
    <div class="mb-3">
        <input type="email" id="loginEmail" class="form-control" placeholder="Email" required />
    </div>
    <div class="mb-3">
        <input type="password" id="loginPassword" class="form-control" placeholder="å¯†ç¢¼" required />
    </div>
    <button type="submit" class="btn btn-warning w-100 mb-3">ç™»å…¥</button>

    <div class="d-flex justify-content-between gap-2">
        <a href="#" data-section="reset-password" class="btn btn-danger w-100">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
        <a href="#" data-section="register" class="btn btn-primary w-100">è¨»å†Šæ–°å¸³è™Ÿ</a>
    </div>
</form>

<script type="module">
    import { getApps, initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const firebaseConfig = {
        apiKey: "AIzaSyD9Bt0HwGGwlRT3_CWFBDhjGcnYf5lCuZU",
        authDomain: "goodaymember.firebaseapp.com",
        projectId: "goodaymember",
        storageBucket: "goodaymember.appspot.com",
        messagingSenderId: "730801053598",
        appId: "1:730801053598:web:a2ec0dc91c78fef6bfc08f",
        measurementId: "G-J3Z7YTHJ9P"
    };

    // âœ… 1. ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼åˆå§‹åŒ– Firebaseï¼Œé¿å…é‡è¤‡éŒ¯èª¤
    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    const auth = getAuth(app);

    // âœ… 2. å°‡äº‹ä»¶ç¶å®šé‚è¼¯æ”¾åˆ°ä¸€å€‹å•Ÿå‹•å‡½æ•¸ä¸­
    function initializeLoginForm() {
        const loginForm = document.getElementById("loginForm");
        
        if (loginForm) {
            loginForm.addEventListener("submit", function (e) {
                e.preventDefault(); // é˜²æ­¢è¡¨å–®å‚³çµ±æäº¤
                const email = document.getElementById("loginEmail").value.trim();
                const password = document.getElementById("loginPassword").value;

                // å¢åŠ ä¸€å€‹ç°¡å–®çš„è¼‰å…¥ä¸­æç¤º
                const submitButton = loginForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = 'ç™»å…¥ä¸­...';

                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        console.log("ç™»å…¥æˆåŠŸ", user.email);
                        
                        // å‘¼å« index.html ä¸­çš„å…¨å±€å‡½æ•¸ä¾†æ›´æ–°ä¸»é é¢ç‹€æ…‹
                        if (window.updateMainAppLoginState) {
                            window.updateMainAppLoginState(user.email);
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°å…¨å±€å‡½æ•¸ï¼Œä¹Ÿæä¾›å‚™ç”¨æ–¹æ¡ˆ
                            alert("âœ… ç™»å…¥æˆåŠŸï¼");
                            window.location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥æ›´æ–°ç‹€æ…‹
                        }
                    })
                    .catch((error) => {
                        console.error("ç™»å…¥å¤±æ•—", error);
                        let message = "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
                        // æ ¹æ“š Firebase éŒ¯èª¤ç¢¼é¡¯ç¤ºæ›´å‹å¥½çš„ä¸­æ–‡æç¤º
                        switch (error.code) {
                            case 'auth/invalid-email':
                                message = "Email æ ¼å¼ä¸æ­£ç¢ºã€‚";
                                break;
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                            case 'auth/invalid-credential':
                                message = "Email æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚";
                                break;
                            default:
                                message = "ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                        }
                        alert(message);
                    })
                    .finally(() => {
                        // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    });
            });
        } else {
            console.error("éŒ¯èª¤ï¼šåœ¨ login.html ä¸­æ‰¾ä¸åˆ° ID ç‚º loginForm çš„å…ƒç´ ï¼");
        }
    }

    // âœ… 3. ä½¿ç”¨ setTimeout å‘¼å«å•Ÿå‹•å‡½æ•¸ï¼Œç§»é™¤ DOMContentLoaded
    setTimeout(initializeLoginForm, 0);

</script>
