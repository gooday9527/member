<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

<div class="container-fluid mt-2">
    <h2 class="mb-3">ğŸ“¥ å¯å§”è¨—ä»£é ˜æ¸…å–®</h2>
    <p class="text-muted">é€™è£¡æœƒåˆ—å‡ºæ‰€æœ‰æ‚¨å¯ä»¥å§”è¨—æˆ‘å€‘ä»£é ˜çš„è‚¡æ±æœƒç´€å¿µå“ã€‚æ‚¨å¯ä»¥åˆ©ç”¨ä¸‹æ–¹çš„æœå°‹åŠŸèƒ½å¿«é€Ÿæ‰¾åˆ°ç›®æ¨™å…¬å¸ã€‚</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>è‚¡è™Ÿ</th>
                            <th>è‚¡å</th>
                            <th>é›»æŠ•é–‹å§‹æ—¥</th>
                            <th>å§”è¨—æˆªæ­¢æ—¥</th>
                            <th>å§”è¨—æ¢ä»¶</th>
                            <th class="text-center">æŒæœ‰å¸³è™Ÿæ•¸</th>
                            <th class="text-center">å·²å§”è¨—æ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>å§“å</th>
                        <th>è­‰ä»¶ç‹€æ…‹</th>
                        <th class="text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const email = window.currentUserEmail; // å¾ä¸» app.js ç²å–ç•¶å‰ç™»å…¥çš„ç”¨æˆ¶ Email
        if (!email) {
            $('#delegableTable').html('<tr><td colspan="7" class="text-center alert alert-danger">è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ‚¨çš„å§”è¨—æ¸…å–®ã€‚</td></tr>');
            return;
        }

        const table = new DataTable('#delegableTable', {
            ajax: function (data, callback, settings) {
                $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center p-4">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>');
                
                google.script.run
                    .withSuccessHandler(function (response) {
                        if (response.status === "success") {
                            settings.ajax.appSettings = response.appSettings;
                            callback(response);
                        } else {
                            console.error("å¾Œç«¯å›å‚³éŒ¯èª¤:", response.message);
                            $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center alert alert-danger">' + (response.message || 'è³‡æ–™è¼‰å…¥å¤±æ•—') + '</td></tr>');
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error("å‘¼å«å¾Œç«¯å¤±æ•—:", error);
                        $('#delegableTable tbody').html('<tr><td colspan="7" class="text-center alert alert-danger">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚</td></tr>');
                    })
                    .getDelegableListData(email);
            },
            columns: [
                { data: 'stockCode' },
                { data: 'stockName' },
                { data: 'eVotingStartDate' },
                { data: 'delegationDeadline' },
                { data: 'delegationConditions' },
                {
                    data: 'totalHoldingAccounts',
                    className: 'text-center',
                    render: function (data, type, row) {
                        if (data > 0) {
                            return `<button class="btn btn-sm btn-outline-primary view-details-btn"
                                            data-details='${JSON.stringify(row.holdingsDetail)}'
                                            data-company="${row.stockName} (${row.stockCode})"
                                            data-conditions="${row.delegationConditions}">
                                        ${data}
                                    </button>`;
                        }
                        return data;
                    }
                },
                { data: 'delegatedAccounts', className: 'text-center' }
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/zh-HANT.json'
            },
            responsive: true,
            order: [[3, 'asc']]
        });

        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        $('#delegableTable tbody').on('click', '.view-details-btn', function () {
            const details = JSON.parse($(this).attr('data-details'));
            const companyName = $(this).attr('data-company');
            const delegationConditions = $(this).attr('data-conditions');
            const appSettings = table.ajax.appSettings || { isDelegationAcquisitionEnabled: true };

            $('#modalCompanyName').text(companyName);
            const modalTableBody = $('#modalTableBody');
            modalTableBody.empty();

            details.forEach(account => {
                let actionHtml = '';
                
                if (account.isDelegated) {
                    actionHtml = `<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate" data-account-name="${account.accountName}">å–æ¶ˆå§”è¨—</button>`;
                } else {
                    let isDocumentMatch = true;
                    const docType = String(account.documentType || '').trim();
                    const requiresIDSpecific = delegationConditions.includes("èº«åˆ†è­‰æ­£æœ¬");
                    const requiresCertSpecific = delegationConditions.includes("è­‰ä»¶æ­£æœ¬");

                    if (requiresIDSpecific) {
                        if (docType !== "èº«åˆ†è­‰") isDocumentMatch = false;
                    } else if (requiresCertSpecific) {
                        if (docType !== "èº«åˆ†è­‰" && docType !== "å¥ä¿å¡") isDocumentMatch = false;
                    }

                    if (isDocumentMatch) {
                        if (appSettings.isDelegationAcquisitionEnabled) {
                            const requiresMailNotice = delegationConditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘");
                            let delegateButtonText = 'å§”è¨—';
                            if (requiresMailNotice) {
                                delegateButtonText = 'å§”è¨— (éœ€å¯„å–®)';
                            }
                            actionHtml = `
                                <button class="btn btn-primary btn-sm action-btn me-1" data-action="delegate" data-account-name="${account.accountName}" data-company-name="${companyName}" data-is-requires-mail="${requiresMailNotice}">
                                    ${delegateButtonText}
                                </button>
                                <button class="btn btn-info btn-sm action-btn" data-action="acquire" data-account-name="${account.accountName}" data-company-name="${companyName}">
                                    æ”¶è³¼
                                </button>
                            `;
                        } else {
                            actionHtml = '<span class="badge bg-secondary">åŠŸèƒ½ç¶­è­·ä¸­</span>';
                        }
                    } else {
                        actionHtml = '<span class="badge bg-danger" title="è­‰ä»¶ä¸ç¬¦åˆå§”è¨—æ¢ä»¶">X (ä¸å¯æ“ä½œ)</span>';
                    }
                }

                const rowHtml = `<tr>
                                    <td>${account.accountName}</td>
                                    <td>${account.documentType || 'æœªæä¾›'}</td>
                                    <td class="text-center">${actionHtml}</td>
                                </tr>`;
                modalTableBody.append(rowHtml);
            });

            detailsModal.show();
        });

        $('#modalTableBody').on('click', '.action-btn', function () {
            const actionType = $(this).data('action');
            const accountName = $(this).data('account-name');
            const companyName = $(this).data('company-name');
            const requiresMailNotice = $(this).data('is-requires-mail');

            if (actionType === 'delegate') {
                if (requiresMailNotice) {
                    alert(`æ¨¡æ“¬ï¼šé€™æ˜¯ã€Œéœ€å¯„å–®ã€å§”è¨—ã€‚\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
                } else {
                    alert(`æ¨¡æ“¬ï¼šåŸ·è¡Œã€Œå§”è¨—ã€æ“ä½œï¼\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
                }
            } else if (actionType === 'acquire') {
                alert(`æ¨¡æ“¬ï¼šåŸ·è¡Œã€Œæ”¶è³¼ã€æ“ä½œï¼\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
            } else if (actionType === 'cancel-delegate') {
                alert(`æ¨¡æ“¬ï¼šåŸ·è¡Œã€Œå–æ¶ˆå§”è¨—ã€æ“ä½œï¼\nå¸³è™Ÿ: ${accountName}\nå…¬å¸: ${companyName}`);
            }
            detailsModal.hide();
        });
    });
</script>
