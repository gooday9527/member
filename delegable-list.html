<div class="souvenir-wrapper pt-2 pb-2 pt-md-0 pb-md-0">
    <div class="d-block d-md-flex align-items-center gap-3 mb-2 mb-md-0 px-3" id="delegableControlsContainer">
        <div class="me-3">
            <h3 class="mt-1 mb-1 mb-md-0" style="white-space: nowrap;">ğŸ“¥ å¯å§”è¨—æ¸…å–®</h3>
        </div>
        <div class="d-flex align-items-center gap-2 flex-nowrap w-100 w-md-auto justify-content-start">
            <div class="d-flex align-items-center">
                <label for="delegRowsPerPage" class="form-label mb-0 me-1">ç­†æ•¸:</label>
                <select id="delegRowsPerPage" class="form-select form-select-sm" style="width: 80px;">
                    <option>10</option><option>25</option><option>50</option><option>100</option>
                </select>
            </div>
            <div class="d-flex align-items-center">
                <label for="delegSearchInput" class="form-label mb-0 me-1">æœå°‹:</label>
                <input type="text" id="delegSearchInput" class="form-control form-control-sm" style="width: 150px;" placeholder="é—œéµå­—...">
            </div>
        </div>
    </div>

    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="delegableListTable">
            <thead class="table-warning"></thead>
            <tbody>
                <tr><td colspan="7" class="text-center p-4">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="delegablePaginationWrapper" class="mt-2">
        <div id="delegablePagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>å§“å</th>
                                <th>è­‰ä»¶ç‹€æ…‹</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    // ç¢ºèªä½¿ç”¨è€…å·²ç™»å…¥
    const email = window.currentUserEmail;
    if (!email) {
        document.querySelector('#delegableListTable tbody').innerHTML = '<tr><td colspan="7" class="text-center text-danger p-4">è«‹å…ˆç™»å…¥</td></tr>';
        return;
    }

    // ç‹€æ…‹è®Šæ•¸
    let rawData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
    let sortKey = 'å§”è¨—æˆªæ­¢æ—¥', sortAsc = true;
    let appSettings = { isDelegationAcquisitionEnabled: true }; // é è¨­å€¼
    let detailsModal; // Modal å¯¦ä¾‹

    // é¡¯ç¤ºçš„æ¬„ä½
    const columns = ['è‚¡è™Ÿ','è‚¡å','é›»æŠ•é–‹å§‹æ—¥','å§”è¨—æˆªæ­¢æ—¥','å§”è¨—æ¢ä»¶','æŒæœ‰å¸³è™Ÿæ•¸','å·²å§”è¨—æ•¸'];

    // DOM å…ƒç´ å¿«å–
    const tblHead = document.querySelector('#delegableListTable thead');
    const tblBody = document.querySelector('#delegableListTable tbody');
    const ctrlRows = document.getElementById('delegRowsPerPage');
    const ctrlSearch = document.getElementById('delegSearchInput');
    const pagContainer = document.getElementById('delegablePagination');
    const modalTitle = document.getElementById('modalCompanyName');
    const modalBody = document.getElementById('modalTableBody');

    // åˆå§‹åŒ–äº‹ä»¶ç¶å®š
    ctrlRows.addEventListener('change', ()=>{ rowsPerPage = +ctrlRows.value; currentPage = 1; renderTable(); });
    ctrlSearch.addEventListener('input', ()=>{ currentPage = 1; filterData(); renderTable(); });
    
    // å¾å¾Œç«¯å–å¾—è³‡æ–™
    google.script.run
        .withSuccessHandler(response => {
            if (response.status !== 'success' || !response.data) {
                tblBody.innerHTML='<tr><td colspan="7" class="text-center text-danger p-4">è¼‰å…¥å¤±æ•—: ' + (response.message || 'æœªçŸ¥éŒ¯èª¤') + '</td></tr>';
                return;
            }
            rawData = response.data || [];
            appSettings = response.appSettings || appSettings; // æ›´æ–°å¾Œç«¯è¨­å®š
            
            // é¦–æ¬¡è³‡æ–™è™•ç†
            sortData(); 
            filterData();
            
            // é¦–æ¬¡æ¸²æŸ“
            renderHeader();
            renderTable();
        })
        .withFailureHandler(err => { 
            tblBody.innerHTML='<tr><td colspan="7" class="text-center text-danger p-4">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</td></tr>'; 
        })
        .getDelegableListData(email);

    function sortData() {
        rawData.sort((a,b) => {
            let valA = a[sortKey], valB = b[sortKey];
            if (sortKey === 'æŒæœ‰å¸³è™Ÿæ•¸' || sortKey === 'å·²å§”è¨—æ•¸') {
                return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
            }
            return sortAsc ? String(valA).localeCompare(valB, 'zh-Hant') : String(valB).localeCompare(valA, 'zh-Hant');
        });
    }

    function filterData() {
        const keyword = ctrlSearch.value.trim().toLowerCase();
        if (keyword) {
            filteredData = rawData.filter(row => columns.some(key => String(row[key] || '').toLowerCase().includes(keyword)));
        } else {
            filteredData = [...rawData]; // ä½¿ç”¨å±•é–‹é‹ç®—ç¬¦å‰µå»ºæ·ºæ‹·è²
        }
    }

    function renderHeader() {
        tblHead.innerHTML = '<tr>' + columns.map(h => `<th class="sortable" data-key="${h}" style="cursor:pointer;white-space:nowrap">${h}<span></span></th>`).join('') + '</tr>';
        tblHead.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
            const key = th.dataset.key;
            sortAsc = (sortKey === key) ? !sortAsc : true;
            sortKey = key;
            sortData(); 
            filterData(); 
            renderTable();
        }));
    }
    
    function renderTable() {
        // æ›´æ–°æ’åºæŒ‡ç¤ºç®­é ­
        tblHead.querySelectorAll('th.sortable span').forEach(s => s.textContent = '');
        const sortIndicator = tblHead.querySelector(`th[data-key="${sortKey}"] span`);
        if (sortIndicator) sortIndicator.textContent = sortAsc ? ' â–²' : ' â–¼';

        // æ ¹æ“šåˆ†é åˆ‡ç‰‡è³‡æ–™
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);

        // æ¸²æŸ“è¡¨æ ¼å…§å®¹
        if (pageData.length === 0) {
            tblBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
        } else {
            tblBody.innerHTML = pageData.map(row => {
                const cells = columns.map(key => {
                    let value = row[key] || '';
                    let className = (key === 'æŒæœ‰å¸³è™Ÿæ•¸' || key === 'å·²å§”è¨—æ•¸') ? 'text-center' : '';
                    
                    if (key === 'æŒæœ‰å¸³è™Ÿæ•¸' && value > 0) {
                        return `<td class="${className}"><button class="btn btn-sm btn-outline-primary view-details-btn">${value}</button></td>`;
                    }
                    return `<td class="${className}">${value}</td>`;
                }).join('');
                // å°‡æ•´åˆ—è³‡æ–™å­˜åœ¨ tr çš„ dataset ä¸­ï¼Œæ–¹ä¾¿å¾ŒçºŒå–ç”¨
                return `<tr data-row-details='${JSON.stringify(row)}'>${cells}</tr>`;
            }).join('');
        }

        // ç‚ºæ–°ç”¢ç”Ÿçš„ã€Œæ˜ç´°æŒ‰éˆ•ã€ç¶å®šäº‹ä»¶
        tblBody.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const rowData = JSON.parse(e.currentTarget.closest('tr').dataset.rowDetails);
                showDetailsModal(rowData);
            });
        });

        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
        let html = '';
        html += `<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="window.delegableTable.changePage(-1)">ä¸Šé </button>`;
        
        // ç°¡æ˜“åˆ†é é‚è¼¯ (å¯æ›¿æ›ç‚ºæ›´è¤‡é›œçš„ "..." ç‰ˆæœ¬)
        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="btn btn-sm me-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}" onclick="window.delegableTable.goToPage(${i})">${i}</button>`;
        }
        
        html += `<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="window.delegableTable.changePage(1)">ä¸‹é </button>`;
        pagContainer.innerHTML = html;
    }

    function showDetailsModal(rowData) {
        if (!detailsModal) {
            detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        }
        modalTitle.textContent = `${rowData.stockName} (${rowData.stockCode})`;
        modalBody.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

        rowData.holdingsDetail.forEach(account => {
            let actionHtml = '';
            // 1. æœ€é«˜å„ªå…ˆç´šï¼šå·²å§”è¨—
            if (account.isDelegated) {
                actionHtml = `<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate">å–æ¶ˆå§”è¨—</button>`;
            } else {
                // 2. åˆ¤æ–·è­‰ä»¶æ˜¯å¦ç¬¦åˆ
                let isDocumentMatch = true;
                const docType = String(account.documentType || '').trim();
                if (rowData.delegationConditions.includes("èº«åˆ†è­‰æ­£æœ¬") && docType !== "èº«åˆ†è­‰") isDocumentMatch = false;
                if (rowData.delegationConditions.includes("è­‰ä»¶æ­£æœ¬") && !["èº«åˆ†è­‰", "å¥ä¿å¡"].includes(docType)) isDocumentMatch = false;

                // 3. æ ¹æ“šè­‰ä»¶ç¬¦åˆåº¦èˆ‡å¾Œç«¯é–‹é—œï¼Œæ±ºå®šæŒ‰éˆ•å…§å®¹
                if (isDocumentMatch) {
                    if (appSettings.isDelegationAcquisitionEnabled) {
                        const btnText = rowData.delegationConditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘") ? 'å§”è¨— (éœ€å¯„å–®)' : 'å§”è¨—';
                        actionHtml = `
                            <button class="btn btn-primary btn-sm action-btn me-1" data-action="delegate">${btnText}</button>
                            <button class="btn btn-info btn-sm action-btn" data-action="acquire">æ”¶è³¼</button>`;
                    } else {
                        actionHtml = `<span class="badge bg-secondary">åŠŸèƒ½ç¶­è­·ä¸­</span>`;
                    }
                } else {
                    actionHtml = `<span class="badge bg-danger">X (è­‰ä»¶ä¸ç¬¦)</span>`;
                }
            }
            const rowHtml = `<tr>
                <td>${account.accountName}</td>
                <td>${account.documentType || 'æœªæä¾›'}</td>
                <td class="text-center" data-company-name="${modalTitle.textContent}" data-account-name="${account.accountName}">${actionHtml}</td>
            </tr>`;
            modalBody.insertAdjacentHTML('beforeend', rowHtml);
        });
        detailsModal.show();
    }
    
    // Modal å…§éƒ¨äº‹ä»¶å§”æ´¾
    document.getElementById('detailsModal').addEventListener('click', function(e){
        if(e.target.classList.contains('action-btn')){
            const target = e.target;
            const cell = target.closest('td');
            alert(`æ¨¡æ“¬æ“ä½œï¼š\né¡å‹: ${target.dataset.action}\nå…¬å¸: ${cell.dataset.companyName}\nå¸³è™Ÿ: ${cell.dataset.accountName}`);
            detailsModal.hide();
        }
    });

    // å°‡åˆ†é å‡½å¼æ›è¼‰åˆ° window ç‰©ä»¶ä¸‹ï¼Œä»¥ä¾¿ onclick èª¿ç”¨
    window.delegableTable = {
        changePage: offset => { currentPage = Math.min(Math.max(1, currentPage + offset), Math.ceil(filteredData.length / rowsPerPage)); renderTable(); },
        goToPage: page => { currentPage = page; renderTable(); }
    };

})();
</script>
