<!-- delegable-list.html (DataTables åŠŸèƒ½ç‰ˆ) -->

<!-- å¼•å…¥ DataTables å’Œ Bootstrap 5 çš„ CSS æ¨£å¼è¡¨ -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">

<div class="container-fluid mt-4">
    <h2 class="mb-3">ğŸ“¥ å¯å§”è¨—ä»£é ˜æ¸…å–®</h2>
    <p class="text-muted">é€™è£¡æœƒåˆ—å‡ºæ‰€æœ‰æ‚¨å¯ä»¥å§”è¨—æˆ‘å€‘ä»£é ˜çš„è‚¡æ±æœƒç´€å¿µå“ã€‚æ‚¨å¯ä»¥åˆ©ç”¨ä¸‹æ–¹çš„æœå°‹åŠŸèƒ½å¿«é€Ÿæ‰¾åˆ°ç›®æ¨™å…¬å¸ã€‚</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <!-- é€™æ˜¯ DataTables çš„ä¸»è¦ HTML çµæ§‹ -->
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>è‚¡è™Ÿ</th>
                            <th>è‚¡å</th>
                            <th>é›»æŠ•é–‹å§‹æ—¥</th>
                            <th>å§”è¨—æˆªæ­¢æ—¥</th>
                            <th>å§”è¨—æ¢ä»¶</th>
                            <th class="text-center">æŒæœ‰å¸³è™Ÿæ•¸</th>
                            <th class="text-center">å·²å§”è¨—æ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTables æœƒé€é JavaScript è‡ªå‹•å¡«å…¥è¡¨æ ¼å…§å®¹ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 Modal (å½ˆå‡ºå¼è¦–çª—)ï¼Œé è¨­ç‚ºéš±è— -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>å§“å</th>
                        <th>è­‰ä»¶ç‹€æ…‹</th>
                        <th class="text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody">
                    <!-- JavaScript æœƒå‹•æ…‹å¡«å…¥é€™è£¡çš„æ˜ç´° -->
                </tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- å¼•å…¥é é¢æ‰€éœ€çš„ JavaScript å‡½å¼åº« -->
<!-- 1. jQuery (DataTables çš„å¿…è¦ä¾è³´) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- 2. DataTables æ ¸å¿ƒå‡½å¼åº« -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<!-- 3. DataTables èˆ‡ Bootstrap 5 çš„æ•´åˆå‡½å¼åº« -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

<!-- æˆ‘å€‘è‡ªå·±çš„é é¢é‚è¼¯ -->
<script type="module">
    // ç•¶é é¢çš„ HTML çµæ§‹éƒ½è¼‰å…¥å®Œæˆå¾Œï¼Œå†åŸ·è¡Œæˆ‘å€‘çš„ JavaScript
    document.addEventListener('DOMContentLoaded', function () {
        
        // å¾å…¨åŸŸè®Šæ•¸å–å¾—ç›®å‰ç™»å…¥è€…çš„ Email
        const email = window.currentUserEmail;
        if (!email) {
            // å¦‚æœæœªç™»å…¥ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯ä¸¦åœæ­¢åŸ·è¡Œ
            $('#delegableTable').html('<tr><td colspan="7" class="text-center alert alert-danger">è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ‚¨çš„å§”è¨—æ¸…å–®ã€‚</td></tr>');
            return;
        }

        // åˆå§‹åŒ– DataTable
        const table = new DataTable('#delegableTable', {
            // é€é Ajax å¾æˆ‘å€‘çš„å¾Œç«¯ API è¼‰å…¥è³‡æ–™
            ajax: {
                // ä½¿ç”¨å¾ app.js åŒ¯å…¥çš„ç¶²å€ï¼Œä¸¦å¸¶ä¸Š action å’Œ email åƒæ•¸
                url: window.APP_URLS.main,
                type: 'POST', // ä½¿ç”¨ POST æ–¹æ³•
                contentType: 'application/json',
                data: function(d) {
                    // å°‡è«‹æ±‚åŒ…è£æˆå¾Œç«¯éœ€è¦çš„ JSON æ ¼å¼
                    return JSON.stringify({
                        action: 'getDelegableList',
                        email: email
                    });
                },
                // æŒ‡å®šè³‡æ–™åœ¨å¾Œç«¯å›å‚³çš„ JSON ä¸­çš„ 'data' å±¬æ€§
                // é€™æ˜¯ç‚ºäº†åŒ¹é…æˆ‘å€‘å¾Œç«¯ { success: true, data: [...] } çš„æ ¼å¼
                dataSrc: 'data' 
            },
            // å®šç¾©è¡¨æ ¼çš„æ¯ä¸€æ¬„ (column) å°æ‡‰åˆ°è³‡æ–™çš„å“ªå€‹å±¬æ€§
            columns: [
                { data: 'stockCode' },
                { data: 'stockName' },
                { data: 'eVotingStartDate' },
                { data: 'delegationDeadline' },
                { data: 'delegationConditions' },
                { 
                    data: 'totalHoldingAccounts',
                    className: 'text-center',
                    // è‡ªè¨‚é€™ä¸€æ¬„çš„é¡¯ç¤ºå…§å®¹
                    render: function (data, type, row) {
                        // å¦‚æœæŒæœ‰å¸³è™Ÿæ•¸ > 0ï¼Œå°±é¡¯ç¤ºä¸€å€‹å¯ä»¥é»æ“Šçš„æŒ‰éˆ•
                        if (data > 0) {
                            // å°‡è©²è¡Œçš„è©³ç´°è³‡æ–™ (holdingsDetail) è½‰æˆ JSON å­—ä¸²å¾Œï¼Œå­˜åœ¨æŒ‰éˆ•çš„ data-details å±¬æ€§ä¸­ï¼Œæ–¹ä¾¿å¾ŒçºŒè®€å–
                            return `<button class="btn btn-sm btn-outline-primary view-details-btn" 
                                            data-details='${JSON.stringify(row.holdingsDetail)}'
                                            data-company="${row.stockName} (${row.stockCode})"
                                            data-conditions="${row.delegationConditions}">
                                        ${data}
                                    </button>`;
                        }
                        return data; // å¦‚æœæ˜¯ 0ï¼Œå°±åªé¡¯ç¤ºæ•¸å­— 0
                    }
                },
                { data: 'delegatedAccounts', className: 'text-center' }
            ],
            // DataTables çš„å…¶ä»–å¯¦ç”¨è¨­å®š
            language: {
                // å¾ CDN è¼‰å…¥ DataTables çš„ç¹é«”ä¸­æ–‡ç¿»è­¯æª”
                url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/zh-HANT.json'
            },
            responsive: true, // å•Ÿç”¨éŸ¿æ‡‰å¼è¨­è¨ˆ
            order: [[ 3, 'asc' ]] // é è¨­ä½¿ç”¨ç¬¬ 4 æ¬„ (å§”è¨—æˆªæ­¢æ—¥) é€²è¡Œå‡å†ªæ’åº
        });

        // å»ºç«‹ Bootstrap Modal çš„ JavaScript ç‰©ä»¶ï¼Œæ–¹ä¾¿æˆ‘å€‘ç”¨ç¨‹å¼æ§åˆ¶å®ƒ
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        // ä½¿ç”¨äº‹ä»¶å§”æ´¾ (Event Delegation) çš„æ–¹å¼ä¾†ç›£è½æŒ‰éˆ•é»æ“Š
        $('#delegableTable tbody').on('click', '.view-details-btn', function () {
            // å¾è¢«é»æ“ŠæŒ‰éˆ•çš„ data-* å±¬æ€§ä¸­ï¼Œè®€å–æˆ‘å€‘é å…ˆå„²å­˜çš„è³‡æ–™
            const details = JSON.parse($(this).attr('data-details'));
            const companyName = $(this).attr('data-company');
            const conditions = $(this).attr('data-conditions');
            
            // å¡«å…¥ Modal å½ˆå‡ºè¦–çª—çš„æ¨™é¡Œå’Œå…§å®¹
            $('#modalCompanyName').text(companyName);
            const modalBody = $('#modalTableBody');
            modalBody.empty(); // å…ˆæ¸…ç©ºèˆŠçš„æ˜ç´°å…§å®¹

            details.forEach(account => {
                let actionHtml = '';
                // ç°¡åŒ–åˆ¤æ–·ï¼šå¦‚æœå§”è¨—æ¢ä»¶åŒ…å«"èº«åˆ†è­‰"ï¼Œä¸”è©²å¸³è™Ÿçš„è­‰ä»¶é¡å‹ä¹Ÿæ˜¯"èº«åˆ†è­‰"ï¼Œå‰‡è¦–ç‚ºç¬¦åˆæ¢ä»¶
                const meetsCondition = conditions.includes("èº«åˆ†è­‰") && account.documentType === "èº«åˆ†è­‰"; 
                const requiresMail = conditions.includes("å¯„é–‹æœƒé€šçŸ¥æ›¸çµ¦æˆ‘");

                if (account.isDelegated) {
                    actionHtml = '<span class="badge bg-success">å·²å§”è¨—</span>';
                } else if (conditions.includes("èº«åˆ†è­‰") && !meetsCondition) { 
                    actionHtml = '<span class="badge bg-danger" title="æ­¤å¸³è™Ÿçš„è­‰ä»¶ä¸ç¬¦åˆå§”è¨—æ¢ä»¶">X</span>';
                } else {
                    let buttonText = 'å§”è¨—';
                    if (requiresMail) {
                        buttonText = '<span class="text-warning me-1">âš ï¸</span>éœ€å¯„å–®';
                    }
                    actionHtml = `<button class="btn btn-primary btn-sm">${buttonText}</button>`;
                }
                
                const rowHtml = `<tr>
                                <td>${account.accountName}</td>
                                <td>${account.documentType || 'æœªæä¾›'}</td>
                                <td class="text-center">${actionHtml}</td>
                            </tr>`;
                modalBody.append(rowHtml);
            });

            // ç”¨ç¨‹å¼é¡¯ç¤º Modal å½ˆå‡ºè¦–çª—
            detailsModal.show();
        });
    });
</script>
