<div class="souvenir-wrapper mt-2">
    <div class="table-controls-fixed" id="souvenirControlsContainer"></div>
    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="souvenirTable">
            <thead class="table-warning"></thead>
            <tbody>
                <tr><td colspan="10" class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td></tr>
            </tbody>
        </table>
    </div>
    <div id="souvenirPaginationWrapper">
        <div id="souvenirPagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>

<script>
(function() {
    // ç‹€æ…‹è®Šæ•¸
    let rawData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
    let sortKey = "è‚¡è™Ÿ", sortAsc = true;
    let headers = [];

    // DOM å…ƒç´ 
    const tblHead = document.querySelector('#souvenirTable thead');
    const tblBody = document.querySelector('#souvenirTable tbody');
    const controlsContainer = document.getElementById('souvenirControlsContainer');
    const pagContainer = document.getElementById('souvenirPagination');

    // æ³¨å…¥æ§åˆ¶é … HTML
    if (controlsContainer) {
        controlsContainer.innerHTML = `
            <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center w-100 mb-2">
                <h3 class="mb-2 mb-md-0">ğŸ ç´€å¿µå“</h3>
                <div class="d-flex align-items-center gap-3">
                    <div>
                        <label for="rowsPerPageSelect" class="form-label mb-0 me-1">ç­†æ•¸:</label>
                        <select id="rowsPerPageSelect" class="form-select form-select-sm d-inline-block" style="width: 80px;">
                            <option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchInput" class="form-label mb-0 me-1">æœå°‹:</label>
                        <input type="text" id="searchInput" class="form-control form-control-sm d-inline-block" style="width: 150px;" placeholder="é—œéµå­—...">
                    </div>
                </div>
            </div>`;
        // ç«‹å³ç¶å®šäº‹ä»¶
        document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            filterData();
            renderTable();
        });
    }
    
    // ç²å–è³‡æ–™
    fetch('https://opensheet.elk.sh/1z4SqcpGbhVtb5I6hQZ5aI9PQTNt2_64-ZFdc0_cV3kE/ç´€å¿µå“è³‡è¨Š')
        .then(res => res.ok ? res.json() : Promise.reject('Network response was not ok.'))
        .then(data => {
            if (!data || data.length === 0) {
                tblBody.innerHTML = '<tr><td colspan="10">æ²’æœ‰å¯ç”¨çš„è³‡æ–™</td></tr>';
                return;
            }
            rawData = data;
            headers = Object.keys(rawData[0]);
            
            // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå…ˆæ¸²æŸ“è¡¨é ­ï¼Œå†é€²è¡Œæ’åºå’Œæ¸²æŸ“è¡¨æ ¼
            renderHeader();
            sortTable(sortKey); // åˆå§‹æ’åº
        })
        .catch(error => {
            console.error('è¼‰å…¥ç´€å¿µå“è³‡æ–™éŒ¯èª¤ï¼š', error);
            tblBody.innerHTML = '<tr><td colspan="10" class="text-danger text-center">è³‡æ–™è¼‰å…¥å¤±æ•—</td></tr>';
        });

    // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘æ’åºè§¸ç™¼å‡½å¼
    function sortTable(key) {
        sortAsc = (sortKey === key) ? !sortAsc : true;
        sortKey = key;
        
        sortData();    // æ’åº
        filterData();  // ç¯©é¸
        renderTable(); // æ¸²æŸ“
    }
    
    // å¯¦éš›é€²è¡Œæ’åºçš„å‡½å¼ (ä½¿ç”¨æˆ‘å€‘ä¿®æ­£éçš„ç²¾æº–ç‰ˆæœ¬)
    function sortData() {
        const isPureNumeric = (s) => /^-?\d+(\.\d+)?$/.test(String(s).trim());
        rawData.sort((a, b) => {
            const valA = a[sortKey] || '';
            const valB = b[sortKey] || '';
            if (isPureNumeric(valA) && isPureNumeric(valB)) {
                return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
            } else {
                return sortAsc ? String(valA).localeCompare(String(valB), 'zh-Hant') : String(valB).localeCompare(String(valA), 'zh-Hant');
            }
        });
    }

    function filterData() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        filteredData = keyword ? rawData.filter(row => headers.some(h => String(row[h] || '').toLowerCase().includes(keyword))) : [...rawData];
    }

    // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘æ¸²æŸ“è¡¨é ­èˆ‡ç¶å®šäº‹ä»¶çš„å‡½å¼
    function renderHeader() {
        tblHead.innerHTML = `<tr>${headers.map(h => `<th class="sortable" data-key="${h}" style="cursor: pointer; white-space: nowrap;">${h} <span></span></th>`).join('')}</tr>`;
        tblHead.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => sortTable(th.dataset.key));
        });
    }

    // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘æ¸²æŸ“è¡¨æ ¼ä¸»é«”ï¼ˆåŒ…å«æ›´æ–°æ’åºæŒ‡ç¤ºå™¨ï¼‰
    function renderTable() {
        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        tblHead.querySelectorAll('th.sortable span').forEach(span => span.textContent = '');
        const activeTh = tblHead.querySelector(`th[data-key="${sortKey}"] span`);
        if (activeTh) activeTh.textContent = sortAsc ? ' â–²' : ' â–¼';

        // åˆ†é è³‡æ–™
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);

        // æ¸²æŸ“è¡¨æ ¼å…§å®¹
        tblBody.innerHTML = pageData.length > 0 ? pageData.map(row => `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${headers.length}" class="text-center p-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
        
        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
        if (totalPages <= 1) {
            pagContainer.innerHTML = '';
            return;
        }
        
        let pageButtons = [];
        pageButtons.push(`<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="window.souvenirTable.changePage(-1)">ä¸Šé </button>`);
        
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="window.souvenirTable.goToPage(1)">1</button>`);
        if (startPage > 2) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
        
        for (let i = startPage; i <= endPage; i++) {
            pageButtons.push(`<button class="btn btn-sm me-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}" onclick="window.souvenirTable.goToPage(${i})">${i}</button>`);
        }
        
        if (endPage < totalPages - 1) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
        if (endPage < totalPages) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="window.souvenirTable.goToPage(${totalPages})">${totalPages}</button>`);
        
        pageButtons.push(`<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="window.souvenirTable.changePage(1)">ä¸‹é </button>`);
        
        pagContainer.innerHTML = pageButtons.join('');
    }
    
    // å°‡åˆ†é å‡½å¼æ›è¼‰åˆ° windowï¼Œä¸¦ä½¿ç”¨å‘½åç©ºé–“é¿å…è¡çª
    window.souvenirTable = {
        changePage: (offset) => { 
            const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
            currentPage = Math.min(Math.max(1, currentPage + offset), totalPages);
            renderTable(); 
        },
        goToPage: (page) => { 
            currentPage = page; 
            renderTable(); 
        }
    };

})();
</script>
