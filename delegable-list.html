<style>
  /* 強制設定表格內容文字為黑色 */
  #delegableListTable tbody td {
    color: black !important;
    font-weight: bold; /* 順便加粗，讓文字更明顯 */
  }
</style>

<div class="souvenir-wrapper pt-2 pb-2 pt-md-0 pb-md-0">
    <div class="d-block d-md-flex align-items-center gap-3 mb-2 mb-md-0 px-3" id="delegableControlsContainer">
        <div class="me-3"><h3 class="mt-1 mb-1 mb-md-0" style="white-space: nowrap;">📥 可委託清單</h3></div>
        <div class="d-flex align-items-center gap-2 flex-nowrap w-100 w-md-auto justify-content-start">
            <div class="d-flex align-items-center">
                <label for="delegRowsPerPage" class="form-label mb-0 me-1">筆數:</label>
                <select id="delegRowsPerPage" class="form-select form-select-sm" style="width: 80px;"><option>10</option><option>25</option><option>50</option><option>100</option></select>
            </div>
            <div class="d-flex align-items-center">
                <label for="delegSearchInput" class="form-label mb-0 me-1">搜尋:</label>
                <input type="text" id="delegSearchInput" class="form-control form-control-sm" style="width: 150px;" placeholder="關鍵字...">
            </div>
        </div>
    </div>
    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="delegableListTable">
            <thead class="table-warning"></thead>
            <tbody><tr><td colspan="7" class="text-center p-4">資料載入中...</td></tr></tbody>
        </table>
    </div>
    <div id="delegablePaginationWrapper" class="mt-2">
        <div id="delegablePagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="detailsModalLabel">持有帳號明細</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <p><strong>公司：</strong><span id="modalCompanyName" class="fw-bold"></span></p>
                <div class="table-responsive">
                    <table class="table table-bordered"><thead class="table-light"><tr><th>姓名</th><th>證件狀態</th><th class="text-center">操作</th></tr></thead><tbody id="modalTableBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    // ✅ 使用您已確認的 Web App 網址
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec';

    const email = window.currentUserEmail;
    if (!email) {
        document.querySelector('#delegableListTable tbody').innerHTML = '<tr><td colspan="7" class="text-center text-danger p-4">請先登入</td></tr>';
        return;
    }

    // 狀態變數
    let rawData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
    let sortKey = '委託截止日', sortAsc = true;
    let appSettings = { isDelegationAcquisitionEnabled: true };
    let detailsModal;

    // 顯示欄位
    const columns = ['股號','股名','電投開始日','委託截止日','委託條件','持有帳號數','已委託數'];

    // DOM 元素
    const tblHead = document.querySelector('#delegableListTable thead');
    const tblBody = document.querySelector('#delegableListTable tbody');
    const ctrlRows = document.getElementById('delegRowsPerPage');
    const ctrlSearch = document.getElementById('delegSearchInput');
    const pagContainer = document.getElementById('delegablePagination');
    const modalTitle = document.getElementById('modalCompanyName');
    const modalBody = document.getElementById('modalTableBody');

    // 事件綁定
    ctrlRows.addEventListener('change', ()=>{ rowsPerPage = +ctrlRows.value; currentPage = 1; renderTable(); });
    ctrlSearch.addEventListener('input', ()=>{ currentPage = 1; filterData(); renderTable(); });
    
    // 使用 fetch 呼叫您的 Web App API
    const apiUrl = `${WEB_APP_URL}?view=getDelegableList&email=${encodeURIComponent(email)}`;
    console.log("【偵錯】1. 準備呼叫 API:", apiUrl);

    fetch(apiUrl)
        .then(response => {
            console.log("【偵錯】2. 收到網路回應", response);
            if (!response.ok) {
                throw new Error('網路回應錯誤，狀態碼: ' + response.status);
            }
            return response.json();
        })
        .then(response => {
            console.log("【偵錯】3. 成功解析 JSON，收到的原始物件:", response);
            if (response.status !== 'success' || !response.data) {
                throw new Error(response.message || '後端回傳資料格式不符');
            }
            
            rawData = response.data || [];
            console.log("【偵錯】4. 從後端取得的 rawData 筆數:", rawData.length);
            
            appSettings = response.appSettings || appSettings;
            
            sortData(); 
            filterData();
            console.log("【偵錯】5. 經過篩選後的 filteredData 筆數:", filteredData.length);

            renderHeader();
            renderTable();
        })
        .catch(err => { 
            console.error('【偵錯】API 呼叫或資料處理過程中發生致命錯誤:', err);
            tblBody.innerHTML=`<tr><td colspan="7" class="text-center text-danger p-4">資料載入失敗，請按F12查看主控台錯誤</td></tr>`; 
        });

    function sortData() {
        rawData.sort((a,b) => {
            let valA = a[sortKey], valB = b[sortKey];
            const isNumeric = !isNaN(Number(valA)) && !isNaN(Number(valB));
            if (isNumeric) return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
            return sortAsc ? String(valA).localeCompare(valB, 'zh-Hant') : String(valB).localeCompare(valA, 'zh-Hant');
        });
    }

    function filterData() {
        const keyword = ctrlSearch.value.trim().toLowerCase();
        filteredData = keyword ? rawData.filter(r => columns.some(h => String(r[h]||'').toLowerCase().includes(keyword))) : [...rawData];
    }

    function renderHeader() {
        tblHead.innerHTML = '<tr>' + columns.map(h => `<th class="sortable" data-key="${h}" style="cursor:pointer;white-space:nowrap">${h}<span></span></th>`).join('') + '</tr>';
        tblHead.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
            const key = th.dataset.key;
            sortAsc = (sortKey === key) ? !sortAsc : true;
            sortKey = key;
            sortData(); filterData(); renderTable();
        }));
    }
    
    function renderTable() {
        const start = (currentPage - 1) * rowsPerPage;
        const pageData = filteredData.slice(start, start + rowsPerPage);
        console.log(`【偵錯】6. 準備渲染第 ${currentPage} 頁，資料筆數: ${pageData.length}`);

        tblBody.innerHTML = pageData.length ? pageData.map(row => {
            const cells = columns.map(key => {
                let value = row[key] ?? '';
                let className = ['持有帳號數', '已委託數'].includes(key) ? 'text-center' : '';
                if (key === '持有帳號數' && value > 0) {
                    return `<td class="${className}"><button class="btn btn-sm btn-outline-primary view-details-btn">${value}</button></td>`;
                }
                return `<td class="${className}">${value}</td>`;
            }).join('');
            return `<tr data-row-details='${JSON.stringify(row)}'>${cells}</tr>`;
        }).join('') : '<tr><td colspan="7" class="text-center p-4">沒有符合條件的資料</td></tr>';

        tblBody.querySelectorAll('.view-details-btn').forEach(btn => btn.addEventListener('click', e => showDetailsModal(JSON.parse(e.currentTarget.closest('tr').dataset.rowDetails))));
        renderPagination();
        console.log("【偵錯】7. 表格渲染完成。");
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
        const paginationContainer = document.getElementById('delegablePagination');
        paginationContainer.innerHTML = '';
        if (totalPages <= 1) return;
        let pageButtons = [];
        pageButtons.push(`<button class="btn btn-sm btn-outline-secondary me-1" ${currentPage === 1 ? 'disabled' : ''} onclick="window.delegableTable.changePage(-1)">上頁</button>`);
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        if (startPage > 1) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="window.delegableTable.goToPage(1)">1</button>`);
        if (startPage > 2) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
        for (let i = startPage; i <= endPage; i++) {
            pageButtons.push(`<button class="btn btn-sm me-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}" onclick="window.delegableTable.goToPage(${i})">${i}</button>`);
        }
        if (endPage < totalPages - 1) pageButtons.push(`<span class="align-self-center me-1">...</span>`);
        if (endPage < totalPages) pageButtons.push(`<button class="btn btn-sm btn-outline-primary me-1" onclick="window.delegableTable.goToPage(${totalPages})">${totalPages}</button>`);
        pageButtons.push(`<button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="window.delegableTable.changePage(1)">下頁</button>`);
        pagContainer.innerHTML = pageButtons.join('');
    }

    function showDetailsModal(rowData) {
        if (!detailsModal) detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modalTitle.textContent = `${rowData.stockName} (${rowData.stockCode})`;
        modalBody.innerHTML = rowData.holdingsDetail.map(account => {
            let actionHtml;
            if (account.isDelegated) {
                actionHtml = `<button class="btn btn-warning btn-sm action-btn" data-action="cancel-delegate">取消委託</button>`;
            } else {
                let isMatch = true;
                const docType = account.documentType || '';
                if (rowData.delegationConditions.includes("身分證正本") && docType !== "身分證") isMatch = false;
                if (rowData.delegationConditions.includes("證件正本") && !["身分證", "健保卡"].includes(docType)) isMatch = false;
                if (isMatch && appSettings.isDelegationAcquisitionEnabled) {
                    const btnText = rowData.delegationConditions.includes("寄開會通知書給我") ? '委託 (需寄單)' : '委託';
                    actionHtml = `<button class="btn btn-primary btn-sm me-1 action-btn" data-action="delegate">${btnText}</button><button class="btn btn-info btn-sm action-btn" data-action="acquire">收購</button>`;
                } else {
                    actionHtml = `<span class="badge bg-${isMatch ? 'secondary' : 'danger'}">${isMatch ? '功能維護中' : '證件不符'}</span>`;
                }
            }
            return `<tr><td>${account.accountName}</td><td>${account.documentType||'未提供'}</td><td class="text-center" data-company-name="${modalTitle.textContent}" data-account-name="${account.accountName}">${actionHtml}</td></tr>`;
        }).join('');
        detailsModal.show();
    }
    
    document.getElementById('detailsModal').addEventListener('click', e => {
        if(e.target.classList.contains('action-btn')){
            const target = e.target, cell = target.closest('td');
            alert(`模擬操作：\n類型: ${target.dataset.action}\n公司: ${cell.dataset.companyName}\n帳號: ${cell.dataset.accountName}`);
            detailsModal.hide();
        }
    });

    window.delegableTable = {
        changePage: offset => { currentPage = Math.min(Math.max(1, currentPage + offset), Math.ceil(filteredData.length / rowsPerPage)); renderTable(); },
        goToPage: page => { currentPage = page; renderTable(); }
    };

})();
</script>
