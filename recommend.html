<div class="recommend-wrapper">

    <div class="position-relative d-flex align-items-center mb-2" style="min-height: 38px;">

        <div class="d-flex align-items-center gap-2 recommend-controls">
            <label for="recommendSheet" class="form-label mb-0 text-nowrap">é¸æ“‡åˆ†é¡ï¼š</label>
            <select id="recommendSheet" class="form-select form-select-sm" style="max-width: 200px;">
                <option>åˆ†é¡è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <h3 class="mb-0 position-absolute top-50 start-50 translate-middle">ğŸŒŸ æ¨è–¦æ¸…å–®</h3>

    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="recommendTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    // âœ… è«‹å†æ¬¡ç¢ºèªé€™è£¡æ˜¯æ‚¨ã€Œæ¨è–¦æ¸…å–®å¾Œç«¯ã€çš„éƒ¨ç½²ç¶²å€
    const RECOMMEND_BACKEND_URL = "https://script.google.com/macros/s/AKfycbzdoezSaX2ujsE5ejjac3HbZWWHhDKQbX0nN1rVTIPSZm7opdCtslmwPAIq6zBNvcTp/exec";

// JSONP æ ¸å¿ƒå‡½æ•¸ (ç¶­æŒä¸è®Š)
    function jsonpRequest(url, callback) { /* ... ä¹‹å‰çš„å®Œæ•´ç¨‹å¼ç¢¼ ... */ }

    // å‡½æ•¸ï¼šè¼‰å…¥æ¨è–¦è³‡æ–™ (ç¶­æŒä¸è®Š)
    function loadRecommendData(sheetName) { /* ... ä¹‹å‰çš„å®Œæ•´ç¨‹å¼ç¢¼ ... */ }


    // âœ…ã€æ ¸å¿ƒå‡ç´šã€‘åˆå§‹åŒ–å‡½æ•¸ï¼ŒåŠ å…¥äº†å¿«å–é‚è¼¯
    function initializeRecommendPage() {
        const selectElement = document.getElementById('recommendSheet');
        const tableElement = document.getElementById('recommendTable');
        if (!selectElement || !tableElement) return;

        // 1. æª¢æŸ¥ã€Œå°æœ¬æœ¬ã€(å¿«å–) ä¸Šæ˜¯å¦å·²ç¶“æœ‰ç´€éŒ„
        if (window.appCache && window.appCache.recommendationHtml) {
            console.log("å¾å‰ç«¯å¿«å–è¼‰å…¥æ¨è–¦æ¸…å–®ï¼Œé€Ÿåº¦é£›å¿«ï¼");
            // å¦‚æœæœ‰ï¼Œç›´æ¥ç”¨å¿«å–ä¸­çš„ HTML æ¢å¾©é é¢ï¼Œç„¶å¾ŒçµæŸï¼
            selectElement.outerHTML = window.appCache.recommendationSelectHtml;
            tableElement.outerHTML = window.appCache.recommendationTableHtml;
            
            // é‡æ–°ç¶å®šäº‹ä»¶ï¼Œå› ç‚º outerHTML æ›¿æ›æ‰äº†èˆŠå…ƒç´ 
            const newSelect = document.getElementById('recommendSheet');
            if (newSelect) {
                newSelect.addEventListener('change', function () { loadRecommendData(this.value); });
            }
            return; 
        }

        // 2. å¦‚æœå¿«å–ä¸­æ²’æœ‰ï¼Œæ‰åŸ·è¡Œç¶²è·¯è«‹æ±‚
        console.log("é¦–æ¬¡è¼‰å…¥æ¨è–¦æ¸…å–®ï¼Œå¾å¾Œç«¯è®€å–è³‡æ–™...");
        selectElement.disabled = true;
        selectElement.innerHTML = '<option>åˆ†é¡è¼‰å…¥ä¸­...</option>';

        const url = `${RECOMMEND_BACKEND_URL}?action=getRecommendationCategories`;
        jsonpRequest(url, (error, result) => {
            if (error || result.status === 'error') {
                console.error('è¼‰å…¥åˆ†é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error || result.data.message);
                selectElement.innerHTML = `<option>åˆ†é¡è¼‰å…¥å¤±æ•—</option>`;
                return;
            }
            
            const categories = result.data.categories;
            selectElement.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            
            selectElement.disabled = false;
            selectElement.addEventListener('change', function () { loadRecommendData(this.value); });

            if (categories.length > 0) {
                // é¦–æ¬¡è¼‰å…¥è³‡æ–™å¾Œï¼Œå°‡ç•¶å‰é é¢ç‹€æ…‹å­˜å…¥å¿«å–
                loadRecommendData(categories[0]).then(() => {
                    setTimeout(() => { // ç­‰å¾… DOM æ›´æ–°å®Œæˆ
                        if(window.appCache) {
                           window.appCache.recommendationSelectHtml = document.getElementById('recommendSheet').outerHTML;
                           window.appCache.recommendationTableHtml = document.getElementById('recommendTable').outerHTML;
                           console.log("æ¨è–¦æ¸…å–®é é¢ç‹€æ…‹å·²å­˜å…¥å‰ç«¯å¿«å–ã€‚");
                        }
                    }, 500); // å»¶é² 500 æ¯«ç§’ç¢ºä¿è¡¨æ ¼å·²æ¸²æŸ“
                });
            }
        });
    }

    // é‡æ–°å¡«å……ä¸è®Šçš„å‡½æ•¸ï¼Œä»¥é˜²è¤‡è£½æ™‚éºæ¼
    function jsonpRequest(url, callback) {const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());window[callbackName] = function(data) {delete window[callbackName];document.body.removeChild(script);callback(null, data);};const script = document.createElement('script');script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;script.onerror = function() {delete window[callbackName];document.body.removeChild(script);callback(new Error('JSONP request failed.'));};document.body.appendChild(script);}
    async function loadRecommendData(sheetName) {const tableElement = document.getElementById('recommendTable');if (!tableElement || !sheetName) return;const thead = tableElement.querySelector('thead');const tbody = tableElement.querySelector('tbody');thead.innerHTML = '';tbody.innerHTML = `<tr><td colspan="100%">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;const url = `${RECOMMEND_BACKEND_URL}?action=getRecommendations&sheetName=${encodeURIComponent(sheetName)}`;await new Promise(resolve => jsonpRequest(url, (error, result) => {if (error || result.status === 'error'){console.error('è¼‰å…¥æ¨è–¦è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error || result.data.message);tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">è³‡æ–™è¼‰å…¥å¤±æ•—</td></tr>`;} else {const data = result.data.data;tbody.innerHTML = '';if (data && data.length > 0){const headers = Object.keys(data[0]);thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;tbody.innerHTML = data.map(row => `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('');} else {tbody.innerHTML = '<tr><td colspan="100%">æ²’æœ‰å¯ç”¨çš„è³‡æ–™</td></tr>';}} resolve(); }));}


    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRecommendPage);
    } else {
        initializeRecommendPage();
    }
</script>
