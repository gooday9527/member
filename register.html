<!-- register.html -->

<!-- âœ… çµæ§‹èª¿æ•´ï¼šç§»é™¤äº†<html>, <head>, <body>ï¼Œåªä¿ç•™å…§å®¹å€å¡Š -->
<!-- âœ… å¤–è§€èª¿æ•´ï¼šä½¿ç”¨ Bootstrap class è®“æ’ç‰ˆæ›´ä¸€è‡´ -->
<div class="register-wrapper" style="max-width: 420px; margin: auto;">
    <h3 class="text-center mb-4">ğŸ‘‹ è¨»å†Šæ–°å¸³è™Ÿ</h3>
    <form id="registerForm">
        <div class="mb-3">
            <label for="name" class="form-label">å§“å</label>
            <input type="text" class="form-control" id="name" required />
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email (å°‡ä½œç‚ºæ‚¨çš„ç™»å…¥å¸³è™Ÿ)</label>
            <input type="email" class="form-control" id="email" required />
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)</label>
            <input type="password" class="form-control" id="password" required minlength="6" />
        </div>
        <div class="mb-3">
            <label for="confirmPassword" class="form-label">ç¢ºèªå¯†ç¢¼</label>
            <input type="password" class="form-control" id="confirmPassword" required minlength="6" />
        </div>
        <button type="submit" class="btn btn-primary w-100 mb-3">ç¢ºèªè¨»å†Š</button>
        <div class="text-center">
            <!-- âœ… å°èˆªèª¿æ•´ï¼šä½¿ç”¨ data-section ä¾†è§¸ç™¼å‹•æ…‹é é¢åˆ‡æ› -->
            <a href="#" data-section="login">å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿè¿”å›ç™»å…¥</a>
        </div>
    </form>
</div>

<!-- âœ… è…³æœ¬èª¿æ•´ï¼šæ”¹ç”¨èˆ‡ index.html ä¸€è‡´çš„æ¨¡çµ„åŒ– SDK -->
<script type="module">
    import { getApps, initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const firebaseConfig = {
        apiKey: "AIzaSyD9Bt0HwGGwlRT3_CWFBDhjGcnYf5lCuZU",
        authDomain: "goodaymember.firebaseapp.com",
        projectId: "goodaymember",
        storageBucket: "goodaymember.appspot.com",
        messagingSenderId: "730801053598",
        appId: "1:730801053598:web:a2ec0dc91c78fef6bfc08f"
    };

    // âœ… å®‰å…¨åœ°åˆå§‹åŒ– Firebaseï¼Œé¿å…é‡è¤‡éŒ¯èª¤
    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    const auth = getAuth(app);

    function initializeRegisterForm() {
        const registerForm = document.getElementById('registerForm');
        if (!registerForm) return;

        registerForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                alert("éŒ¯èª¤ï¼šå…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ç›¸ç¬¦ï¼");
                return;
            }
            if (!name) {
                alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥æ‚¨çš„å§“åï¼");
                return;
            }

            const submitButton = registerForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = 'è™•ç†ä¸­...';

            try {
                // æ­¥é©Ÿ 1ï¸âƒ£: åœ¨ Firebase ä¸­å»ºç«‹ä½¿ç”¨è€…å¸³è™Ÿ
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("âœ… Firebase è¨»å†ŠæˆåŠŸ:", userCredential.user.email);

                // æ­¥é©Ÿ 2ï¸âƒ£: ã€ä¿ç•™æ‚¨çš„æ ¸å¿ƒé‚è¼¯ã€‘å‘¼å« Apps Script å°‡è³‡æ–™å¯«å…¥è©¦ç®—è¡¨
                const relayUrl = "https://script.google.com/macros/s/AKfycbzfj7nkQe1QnKiRedfYKeMBAAKVKAi17b0rEirrgzNd2AcTmgQcVvneIg5IlqQDtWaF/exec";
                const response = await fetch(relayUrl, {
                    method: "POST",
                    // æ‚¨çš„ Apps Script ä¼¼ä¹æ˜¯æ¥æ”¶ç´”æ–‡å­—ï¼Œæˆ‘å€‘ç™¼é€ç´”æ–‡å­—
                    // å¦‚æœå®ƒéœ€è¦ JSONï¼Œè«‹æ”¹å› JSON.stringify
                    body: JSON.stringify({ action: "register", email, name }) 
                });

                const result = await response.json();
                if (!result.success) {
                    // å³ä½¿å¯«å…¥è©¦ç®—è¡¨å¤±æ•—ï¼ŒFirebase å¸³è™Ÿä¹Ÿå·²å»ºç«‹
                    // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦åˆªé™¤ Firebase å¸³è™Ÿï¼Œæˆ–åªæ˜¯æé†’ä½¿ç”¨è€…
                    throw new Error(result.message || "å¯«å…¥æœƒå“¡è³‡æ–™å¤±æ•—ï¼Œä½†å¸³è™Ÿå·²å»ºç«‹ã€‚è«‹è¯ç¹«å®¢æœã€‚");
                }

                console.log("âœ… Apps Script å¯«å…¥æˆåŠŸ");
                alert("âœ… è¨»å†ŠæˆåŠŸï¼å°‡ç‚ºæ‚¨è‡ªå‹•ç™»å…¥ã€‚");

                // æ­¥é©Ÿ 3ï¸âƒ£: ã€ç„¡ç¸«æ¥è»Œã€‘å‘¼å«ä¸»ç¨‹å¼çš„å‡½æ•¸ä¾†æ›´æ–°ç™»å…¥ç‹€æ…‹
                if (window.updateMainAppLoginState) {
                    window.updateMainApplinState(userCredential.user.email);
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ‰¾ä¸åˆ°ä¸»ç¨‹å¼å‡½æ•¸ï¼Œå°±é‡æ•´é é¢
                    window.location.reload();
                }

            } catch (error) {
                console.error("è¨»å†Šæµç¨‹å¤±æ•—:", error);
                let message = "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
                // æ ¹æ“š Firebase æˆ–æˆ‘å€‘è‡ªè¨‚çš„éŒ¯èª¤ä¾†é¡¯ç¤ºæç¤º
                if (error.code) {
                     switch (error.code) {
                        case 'auth/email-already-in-use':
                            message = "é€™å€‹ Email å·²ç¶“è¢«è¨»å†Šéäº†ã€‚";
                            break;
                        case 'auth/invalid-email':
                            message = "Email æ ¼å¼ä¸æ­£ç¢ºã€‚";
                            break;
                        case 'auth/weak-password':
                            message = "å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹è‡³å°‘è¨­å®š6ä½æ•¸ã€‚";
                            break;
                        default:
                            message = `è¨»å†Šå¤±æ•— (${error.message})`
                    }
                } else {
                    message = error.message; // é¡¯ç¤ºä¾†è‡ª Apps Script çš„éŒ¯èª¤
                }
                alert(`âŒ ${message}`);
            } finally {
                // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
    }

    // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM æº–å‚™å°±ç·’
    setTimeout(initializeRegisterForm, 0);
</script>
