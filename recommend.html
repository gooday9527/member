<div class="recommend-wrapper">

    <h3 class="text-center">🌟 推薦清單</h3>

    <div class="d-flex align-items-center gap-2 recommend-controls">
        <label for="recommendSheet" class="form-label mb-0">選擇分類：</label>
        <select id="recommendSheet" class="form-select form-select-sm" style="max-width: 200px;">
            <option>分類載入中...</option>
        </select>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="recommendTable">
            <thead class="table-warning"></thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    // ✅ 請再次確認這裡是您「推薦清單後端」的部署網址
    const RECOMMEND_BACKEND_URL = "https://script.google.com/macros/s/AKfycbzdoezSaX2ujsE5ejjac3HbZWWHhDKQbX0nN1rVTIPSZm7opdCtslmwPAIq6zBNvcTp/exec";

    // 函數：根據傳入的工作表名稱，載入對應的資料
    async function loadRecommendData(sheetName) {
        const tableElement = document.getElementById('recommendTable');
        if (!tableElement || !sheetName) return;

        const thead = tableElement.querySelector('thead');
        const tbody = tableElement.querySelector('tbody');
        
        thead.innerHTML = '';
        tbody.innerHTML = `<tr><td colspan="100%">資料載入中...</td></tr>`;

        try {
            // ✅ 改成 GET 請求，並將參數放在網址上
            const url = `${RECOMMEND_BACKEND_URL}?action=getRecommendations&sheetName=${encodeURIComponent(sheetName)}`;
            const response = await fetch(url);

            if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.data.message);

            const data = result.data.data;
            tbody.innerHTML = ''; 

            if (data && data.length > 0) {
                const headers = Object.keys(data[0]);
                thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                tbody.innerHTML = data.map(row => `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="100%">沒有可用的資料</td></tr>';
            }
        } catch (error) {
            console.error('載入推薦資料時發生錯誤:', error);
            tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">資料載入失敗: ${error.message}</td></tr>`;
        }
    }

    // 函數：初始化頁面，先取得分類選單，再載入預設資料
    async function initializeRecommendPage() {
        const selectElement = document.getElementById('recommendSheet');
        if (!selectElement) return;
        
        selectElement.disabled = true;
        selectElement.innerHTML = '<option>分類載入中...</option>';

        try {
            // ✅ 改成 GET 請求
            const url = `${RECOMMEND_BACKEND_URL}?action=getRecommendationCategories`;
            const response = await fetch(url);
            
            if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.data.message);
            
            const categories = result.data.categories;
            selectElement.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            
            selectElement.disabled = false;
            selectElement.addEventListener('change', function () { loadRecommendData(this.value); });

            if (categories.length > 0) { loadRecommendData(categories[0]); }

        } catch (error) {
            console.error('載入分類時發生錯誤:', error);
            selectElement.innerHTML = `<option>分類載入失敗</option>`;
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRecommendPage);
    } else {
        initializeRecommendPage();
    }
</script>
