<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>好管家股東紀念品代領</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="colors.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.10/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.10/css/dataTables.bootstrap5.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-light">
        <a class="navbar-brand fw-bold" href="#">好管家代領</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="navMenu"></ul>

            <!-- 登入狀態區塊 -->
            <div class="d-flex align-items-center ms-auto">
                <div id="loginStatus" class="text-end me-3 small text-muted">載入會員資訊...</div>
            </div>
        </div>
    </nav>

<div class="container-fluid">
    <!-- ✅ 動態內容載入容器：所有外部 HTML 頁面將載入到這裡 -->
    <section id="dynamic-content-area" class="section active-section">
        <!-- 外部 HTML 內容將載入到這裡 -->
    </section>
</div> <!-- container-fluid 結束 -->

    <!-- jQuery & Bootstrap JS -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js" xintegrity="sha512-J/0uB3zIgK1t5OJAA7Js1qntoZ1aI7V3C2aygtlNt9rSAbRRxvKakIDhMKRcX7gs3PEz+XRTS1G0BqT/91Q56A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDK (模組版) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            signInWithEmailAndPassword // 雖然 login.html 處理登入，但這裡仍需要以防萬一或未來擴展
        } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD9Bt0HwGGwlRT3_CWFBDhjGcnYf5lCuZU",
            authDomain: "goodaymember.firebaseapp.com",
            projectId: "goodaymember",
            storageBucket: "goodaymember.appspot.com",
            messagingSenderId: "730801053598",
            appId: "1:730801053598:web:a2ec0dc91c78fef6bfc08f",
            measurementId: "G-J3Z7YTHJ9P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ✅ 全局變數，用於儲存當前登入用戶的 Email
        // 外部載入的頁面會依賴這個變數來獲取用戶 Email
        window.currentUserEmail = null;

        // ✅ 全局函數，供動態載入的 login.html 呼叫以更新主應用程式狀態
        window.updateMainAppLoginState = function(email) {
            loginEmail = email;
            window.currentUserEmail = email;
            localStorage.setItem("loginEmail", loginEmail); // 可選：將 Email 存入 localStorage
            loadMemberName(loginEmail); // 載入並顯示會員姓名
            renderNavTabs(); // 重新渲染導覽列以顯示登入後選項
            showSection("souvenir"); // 導向預設登入後頁面
            alert("✅ 登入成功！"); // 登入成功提示
        };

        let loginEmail = null;
        const navMenu = document.getElementById("navMenu");
        // allSections 現在只包含 dynamic-content-area，但我們仍用它來控制顯示/隱藏
        const allSections = document.querySelectorAll(".section");

        // 登入前導覽列項目 (現在這些也都是外部載入的頁面)
        const tabsBeforeLogin = [
            { id: "souvenir", label: "紀念品" },
            { id: "recommend", label: "推薦清單" },
            { id: "notice", label: "注意事項" },
            { id: "about", label: "關於我" },
            { id: "login", label: "登入" } // 登入頁面也獨立了
        ];

        // 登入後導覽列項目 (包含下拉選單)
        const tabsAfterLogin = [
            { id: "souvenir", label: "紀念品" },
            { id: "recommend", label: "推薦清單" },
            { id: "notice", label: "注意事項" },
            { id: "about", label: "關於我" },
            // ✅ 將公告欄、委託管理、紀念品管理移回頂層
            { id: "announcement", label: "公告欄" },
            { id: "delegation-manage", label: "委託管理" },
            { id: "souvenir-manage", label: "紀念品管理" },
            {
                id: "account-management-dropdown", // 父級 ID，用於下拉選單的控制
                label: "帳戶管理",
                isDropdown: true, // 標記為下拉選單
                children: [
                    { id: "add-account-shares", label: "新增帳號／持股" }, // 對應 add-account-shares.html
                    { id: "deposit-withdrawal", label: "儲值 / 提款" },    // 對應 deposit-withdrawal.html
                    { id: "account-query", label: "帳務查詢" }          // 對應 account-query.html
                ]
            },
            { id: "logout", label: "登出" }
        ];

        // 渲染導覽列選單
        function renderNavTabs() {
            navMenu.innerHTML = "";
            const tabs = loginEmail ? tabsAfterLogin : tabsBeforeLogin;

            // 只有登出按鈕可能需要特別高亮
            const highlightTabs = ["logout"];

            tabs.forEach(tab => {
                const li = document.createElement("li");
                li.className = "nav-item";

                if (tab.isDropdown) {
                    // 生成下拉選單結構
                    li.className = "nav-item dropdown";
                    li.innerHTML = `
                        <a class="nav-link dropdown-toggle" href="#" id="${tab.id}Link" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            ${tab.label}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="${tab.id}Link">
                            ${tab.children.map(child => `
                                <li><a class="dropdown-item" href="#" data-section="${child.id}">${child.label}</a></li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    // 生成普通導覽項目
                    const isHighlight = highlightTabs.includes(tab.id);
                    const classList = `nav-link${isHighlight ? " always-highlight" : ""}`;

                    if (tab.link) {
                        li.innerHTML = `<a class="${classList}" href="${tab.link}">${tab.label}</a>`;
                    } else {
                        li.innerHTML = `<a class="${classList}" href="#" data-section="${tab.id}">${tab.label}</a>`;
                    }
                }
                navMenu.appendChild(li);
            });
        }

        // 載入會員姓名 (從 Apps Script 獲取)
        function loadMemberName(email) {
            const loginStatus = document.getElementById("loginStatus");
            if (!email) {
                if (loginStatus) {
                    loginStatus.innerText = "訪客"; // 未登入狀態
                    loginStatus.classList.remove("text-dark", "fw-bold", "text-danger");
                    loginStatus.classList.add("text-muted");
                }
                return;
            }

            // 立即顯示載入中狀態
            if (loginStatus) {
                loginStatus.innerText = "載入中...";
                loginStatus.classList.remove("text-dark", "fw-bold", "text-danger");
                loginStatus.classList.add("text-muted");
            }

            // 這裡呼叫您的 Apps Script 後端來獲取會員名稱
            // 請替換成您實際的 Apps Script Web App URL (用於獲取會員資訊的那個)
            const APPS_SCRIPT_MEMBER_INFO_URL = "https://script.google.com/macros/s/AKfycbzfj7nkQe1QnKiRedfYKeMBAAKVKAi17b0rEirrgzNd2AcTmgQcVvneIg5IlqQDtWaF/exec"; // 替換為您的 relayUrl

            fetch(`${APPS_SCRIPT_MEMBER_INFO_URL}?view=getMemberInfo&email=${encodeURIComponent(email)}`)
                .then(res => {
                    if (!res.ok) throw new Error('網路回應不佳');
                    return res.json();
                })
                .then(info => {
                    const memberName = info.name || "未命名";
                    if (loginStatus) {
                        loginStatus.innerText = `會員：${memberName}`;
                        loginStatus.classList.remove("text-muted", "text-danger");
                        loginStatus.classList.add("text-dark", "fw-bold");
                    }
                })
                .catch(err => {
                    console.error("取得會員資料失敗", err);
                    if (loginStatus) {
                        loginStatus.innerText = "會員：載入失敗";
                        loginStatus.classList.remove("text-dark", "fw-bold", "text-muted");
                        loginStatus.classList.add("text-danger");
                    }
                });
        }

        // ✅ 新增載入外部 HTML 內容的函數
        async function loadExternalHtmlSection(sectionId) {
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error('找不到用於載入外部內容的容器 #dynamic-content-area');
                return;
            }

            // 顯示載入中的訊息
            dynamicContentArea.innerHTML = `<h3 class="text-center">載入中...</h3><p class="text-center">請稍候。</p>`;
            dynamicContentArea.classList.add('active-section'); // 確保容器顯示

            try {
                // ✅ 修正：使用 `/` 開頭，確保從網站根目錄載入檔案
                const response = await fetch(`/${sectionId}.html`); // 根據 ID 載入對應的 HTML 檔案
                if (!response.ok) {
                    throw new Error(`載入 ${sectionId}.html 失敗：${response.statusText}`);
                }
                const htmlContent = await response.text();

                dynamicContentArea.innerHTML = htmlContent;

                // 手動執行載入的 HTML 中的 <script> 標籤
                // 這是因為當您使用 innerHTML 設置內容時，<script> 標籤不會自動執行
                const scripts = dynamicContentArea.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    // 移除舊的 script 元素，然後創建一個新的並複製其內容和屬性
                    // 這是確保腳本在動態載入後能夠被正確執行的方法
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

            } catch (error) {
                console.error('載入外部內容錯誤:', error);
                dynamicContentArea.innerHTML = `<h3 class="text-center text-danger">載入失敗</h3><p class="text-center">無法載入 ${sectionId} 頁面，請稍後再試。</p>`;
            }
        }

        // 顯示指定 Section 的函數
        function showSection(id) {
            // 隱藏所有 section (現在只剩下 dynamic-content-area)
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            if (dynamicContentArea) {
                dynamicContentArea.classList.remove("active-section");
                dynamicContentArea.innerHTML = ''; // 清空內容
            }

            // 登出是特殊情況，不載入外部頁面
            if (id === "logout") {
                // 登出邏輯在 navMenu.addEventListener 中處理
                return;
            }

            // 載入外部 HTML 內容到 dynamic-content-area
            loadExternalHtmlSection(id);

            // 更新導覽列活躍狀態
            // ✅ 這裡修正了選擇器，使其也能匹配下拉選單中的項目
            document.querySelectorAll('.nav-link, .dropdown-item').forEach(link => {
                link.classList.remove('active');
            });

            const activeNavLink = document.querySelector(`.nav-link[data-section="${id}"], .dropdown-item[data-section="${id}"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
                // 如果點擊的是下拉選單內的項目，確保父級的下拉按鈕也顯示活躍狀態
                const parentDropdownToggle = activeNavLink.closest('.dropdown')?.querySelector('.dropdown-toggle');
                if (parentDropdownToggle) {
                    parentDropdownToggle.classList.add('active');
                }
            }

            // 隱藏導覽列 (針對手機版展開後點擊自動收起)
            const navbarCollapse = document.getElementById('navbarNav');
            const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
            if (bsCollapse && navbarCollapse.classList.contains('show')) {
                bsCollapse.hide();
            }
        }

        // 導覽列點擊事件處理
        navMenu.addEventListener("click", function (e) {
            // ✅ 這裡修正了選擇器，使其也能匹配下拉選單中的項目
            const clickedNavLink = e.target.closest(".nav-link[data-section], .dropdown-item[data-section]");
            if (clickedNavLink) {
                e.preventDefault();
                const id = clickedNavLink.getAttribute("data-section");
                if (id === "logout") {
                    signOut(auth).then(() => {
                        console.log("用戶已登出");
                        loginEmail = null;
                        window.currentUserEmail = null; // ✅ 清除全局變數
                        renderNavTabs();
                        showSection("souvenir"); // 登出後回到紀念品頁面
                        // 登出後，清空動態內容區塊
                        const dynamicContentArea = document.getElementById('dynamic-content-area');
                        if (dynamicContentArea) {
                            dynamicContentArea.innerHTML = '';
                            dynamicContentArea.classList.remove('active-section');
                        }
                    }).catch((error) => {
                        console.error("登出失敗:", error);
                    });
                } else {
                    showSection(id);
                }
            }
        });

        // 頁面首次載入及 Firebase 認證狀態監聽
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                loginEmail = user ? user.email : null;
                window.currentUserEmail = loginEmail; // 設定全局變數
                console.log(loginEmail ? "✅ 已登入：" + loginEmail : "⚠️ 尚未登入");

                loadMemberName(loginEmail); // 載入會員名稱
                renderNavTabs(); // 渲染導覽列

                // 處理 URL 參數，如果 URL 中有 ?view=xxx 則顯示對應頁面
                const urlParams = new URLSearchParams(window.location.search);
                const view = urlParams.get("view");
                if (view) { // 如果有 view 參數，就載入對應的頁面
                    showSection(view);
                } else { // 否則預設顯示紀念品頁面
                    showSection("souvenir");
                }
            });
        });

        // 監聽視窗大小變化，調整 DataTables 列寬 (如果未來使用 DataTables)
        // 注意：這裡的 DataTables 相關邏輯，如果 `souvenir.html` 和 `recommend.html` 內部有用到 jQuery DataTables，
        // 則需要確保 DataTables 庫在這些頁面載入時可用。
        // 由於您在 index.html 載入了 jQuery 和 DataTables CDN，它們是全局可用的。
        $(window).on('resize', function () {
            setTimeout(function() {
                if ($.fn.dataTable && $.fn.dataTable.tables(true).length) { // 檢查 $.fn.dataTable 是否存在
                    $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
                }
            }, 100);
        });
    </script>
</body>
</html>
