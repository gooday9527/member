<!-- add-account-shares.html -->

<!-- âœ… æ¡ç”¨èˆ‡ç™»å…¥é å®Œå…¨ä¸€è‡´çš„ç½®ä¸­ã€ç°¡æ½”é¢¨æ ¼ -->
<div style="max-width: 500px; margin: 2rem auto;">
    <h3 class="text-center">ğŸ“Š æ–°å¢å¸³è™Ÿï¼æŒè‚¡</h3>
    
    <div class="mb-3">
        <label for="subAccountSelect" class="form-label  fw-bold">é¸æ“‡æˆ–æ–°å¢å­å¸³è™Ÿ</label>
        <div class="input-group">
            <select class="form-select" id="subAccountSelect">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="window.addAccountShares.toggleSubAccountInput(true)">â• æ–°å¢</button>
        </div>
    </div>
    
    <div id="addSubWrapper" class="mb-3" style="display:none;">
        <!-- âœ…ã€ä¿®æ­£1ã€‘ç§»é™¤ labelï¼Œå°‡æ–‡å­—æç¤ºæ”¹ç‚º placeholder -->
        <input type="text" class="form-control" id="newSubAccountInput" placeholder="æ–°å­å¸³è™Ÿåç¨±">
        <div class="mt-2 d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-sm btn-secondary" onclick="window.addAccountShares.toggleSubAccountInput(false)">å–æ¶ˆ</button>
            <button type="button" class="btn btn-sm btn-primary" onclick="window.addAccountShares.saveNewSubAccount()">å„²å­˜</button>
        </div>
    </div>

    <div class="mb-3">
        <label for="stockInput" class="form-label  fw-bold">è¼¸å…¥è‚¡è™Ÿ (ç”¨é€—è™Ÿåˆ†éš”)</label>
        <textarea id="stockInput" class="form-control" rows="4" placeholder="ä¾‹å¦‚ï¼š1101, 1102, 2330"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label  fw-bold">é¸æ“‡æ“ä½œé¡å‹</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opAdd" value="add" checked>
            <label class="form-check-label" for="opAdd">æ–°å¢ä¸Šåˆ—æŒè‚¡ (è¿½åŠ )</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opOverwrite" value="overwrite">
            <label class="form-check-label" for="opOverwrite">ä¸Šåˆ—æŒè‚¡è¦†è“‹åŸæœ¬æŒè‚¡ (æ¸…ç©ºå¾Œå¯«å…¥)</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="operationType" id="opDelete" value="delete">
            <label class="form-check-label" for="opDelete">åˆªé™¤ä¸Šåˆ—æŒè‚¡ (å¾ç¾æœ‰æ¸…å–®ç§»é™¤)</label>
        </div>
    </div>

    <!-- âœ…ã€ä¿®æ­£2ã€‘å°‡æŒ‰éˆ• class å¾ btn-success æ”¹ç‚º btn-warning -->
    <button class="btn btn-warning w-100 mt-3" onclick="window.addAccountShares.executeOperation()">åŸ·è¡Œæ“ä½œ</button>

    <div id="messageBox" class="mt-3"></div>
</div>

<!-- æ‚¨çš„ JavaScript é‚è¼¯å®Œå…¨ä¸è®Š -->
<script>
    window.addAccountShares = (function() {
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec";
        
        async function fetchDataFromBackend(action, payload = {}) {
            const userEmail = window.currentUserEmail;
            if (!userEmail) {
                displayMessage("éŒ¯èª¤ï¼šç„¡æ³•ç²å–ç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚", "danger");
                throw new Error("User not logged in");
            }
            const fullPayload = { action, userEmail, ...payload };
            const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(fullPayload),
            });
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            const result = await response.json();
            if (result.status === "error") throw new Error(result.data.message || "å¾Œç«¯è™•ç†éŒ¯èª¤");
            return result.data;
        }

        function displayMessage(msg, type) {
            const box = document.getElementById("messageBox");
            if (!box) return;
            box.innerHTML = `<div class="alert alert-${type}" role="alert">${msg}</div>`;
            setTimeout(() => { box.innerHTML = ''; }, 5000);
        }

        async function loadInitialData(accountToSelect = null) {
            const select = document.getElementById("subAccountSelect");
            try {
                const data = await fetchDataFromBackend("getAccountData");
                const accounts = data.accounts || [];
                select.innerHTML = '<option value="">è«‹é¸æ“‡å­å¸³è™Ÿ</option>';
                if (accounts.length > 0) {
                    accounts.forEach(name => {
                        const opt = document.createElement("option");
                        opt.value = opt.textContent = name;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">å°šç„¡å­å¸³è™Ÿï¼Œè«‹å…ˆæ–°å¢</option>';
                }
                if (accountToSelect && accounts.includes(accountToSelect)) {
                    select.value = accountToSelect;
                }
            } catch (e) {
                select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                displayMessage("è¼‰å…¥å¸³è™Ÿè³‡æ–™å¤±æ•—ï¼š" + e.message, "danger");
            }
        }

        setTimeout(loadInitialData, 0);

        return {
            toggleSubAccountInput: function(show) {
                const wrapper = document.getElementById("addSubWrapper");
                if (wrapper) {
                    wrapper.style.display = show ? "block" : "none";
                    if (!show) document.getElementById("newSubAccountInput").value = "";
                }
            },
saveNewSubAccount: function() {
                const name = document.getElementById("newSubAccountInput").value.trim();
                if (!name) {
                    displayMessage("è«‹è¼¸å…¥å­å¸³è™Ÿåç¨±", "warning");
                    return;
                }

                // --- æ­¥é©Ÿ 1: ç«‹åˆ»æ›´æ–°å‰ç«¯ä»‹é¢ (UI) ---
                
                // éš±è—è¼¸å…¥æ¡†
                this.toggleSubAccountInput(false);

                // åœ¨ä¸‹æ‹‰é¸å–®ä¸­æ–°å¢ä¸¦é¸å–è©²å¸³è™Ÿ
                const select = document.getElementById("subAccountSelect");
                
                // å¦‚æœåŸæœ¬æ˜¯"å°šç„¡å­å¸³è™Ÿ"çš„æç¤ºï¼Œå°±å…ˆæ¸…æ‰
                if (select.options.length === 1 && select.options[0].textContent.includes("å°šç„¡å­å¸³è™Ÿ")) {
                    select.innerHTML = '<option value="">è«‹é¸æ“‡å­å¸³è™Ÿ</option>';
                }

                const newOption = document.createElement("option");
                newOption.value = name;
                newOption.textContent = name;
                select.appendChild(newOption);
                select.value = name; // ç›´æ¥é¸å–æ–°å¸³è™Ÿ

                // é¡¯ç¤ºè™•ç†ä¸­çš„æç¤º
                displayMessage("å¸³è™Ÿå»ºç«‹ä¸­ï¼Œè«‹ç¨å€™...", "info");
                
                // --- æ­¥é©Ÿ 2: åœ¨èƒŒæ™¯åŸ·è¡Œå¾Œç«¯è«‹æ±‚ ---

                const btn = document.querySelector('#addSubWrapper .btn-primary');
                // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘ä¸å†è®“å„²å­˜æŒ‰éˆ•å¤±æ•ˆï¼Œå› ç‚ºUIå·²ç¶“æ›´æ–°ï¼Œä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒæ“ä½œ
                
                fetchDataFromBackend("addAndSelectSubAccount", { name: name })
                    .then(result => {
                        // âœ… å¾Œç«¯æˆåŠŸå¾Œï¼Œé¡¯ç¤ºæ‚¨æŒ‡å®šçš„æˆåŠŸè¨Šæ¯
                        if (result.success) {
                            displayMessage(`å­å¸³è™Ÿã€Œ${name}ã€å·²å»ºç«‹`, "success");
                        } else {
                            // å¦‚æœå¾Œç«¯å› æ•…å¤±æ•— (ä¾‹å¦‚åç¨±é‡è¤‡)ï¼Œé¡¯ç¤ºå¾Œç«¯å‚³ä¾†çš„éŒ¯èª¤è¨Šæ¯
                            displayMessage(result.message, "danger");
                            // ç§»é™¤å‰›å‰›æ¨‚è§€æ–°å¢çš„é¸é …
                            const optionToRemove = select.querySelector(`option[value="${name}"]`);
                            if (optionToRemove) optionToRemove.remove();
                        }
                    })
                    .catch(e => {
                        // âœ… å¦‚æœæ˜¯ç¶²è·¯å•é¡Œç­‰åš´é‡éŒ¯èª¤ï¼Œä¹Ÿæç¤ºä¸¦ç§»é™¤é¸é …
                        displayMessage("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼š" + e.message, "danger");
                        const optionToRemove = select.querySelector(`option[value="${name}"]`);
                        if (optionToRemove) optionToRemove.remove();
                    });
            },
            executeOperation: async function() {
                const subAccount = document.getElementById("subAccountSelect").value;
                const stocks = document.getElementById("stockInput").value.trim();
                const operationType = document.querySelector('input[name="operationType"]:checked').value;
                if (!subAccount) return displayMessage("è«‹é¸æ“‡ä¸€å€‹å­å¸³è™Ÿ", "danger");
                if (!stocks && operationType !== 'overwrite') return displayMessage("è«‹è¼¸å…¥è‚¡è™Ÿ", "danger");
                const btn = document.querySelector('.btn-warning'); // <-- æ³¨æ„é€™è£¡è¦æ”¹æˆ .btn-warning
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'è™•ç†ä¸­...';
                try {
                    const result = await fetchDataFromBackend("executeStockOperation", { subAccountName: subAccount, stockInput: stocks, operationType });
                    displayMessage(result.message, "success");
                    document.getElementById("stockInput").value = "";
                } catch (e) {
                    displayMessage("æ“ä½œå¤±æ•—ï¼š" + e.message, "danger");
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        };
    })();
</script>
