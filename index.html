<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å¥½ç®¡å®¶è‚¡æ±ç´€å¿µå“ä»£é ˜</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="colors.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.10/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.10/css/dataTables.bootstrap5.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-light">
        <a class="navbar-brand fw-bold" href="#">å¥½ç®¡å®¶ä»£é ˜</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="navMenu"></ul>

            <!-- ç™»å…¥ç‹€æ…‹å€å¡Š -->
            <div class="d-flex align-items-center ms-auto">
                <div id="loginStatus" class="text-end me-3 small text-muted">è¼‰å…¥æœƒå“¡è³‡è¨Š...</div>
            </div>
        </div>
    </nav>

<div class="container-fluid">
    <!-- âœ… å‹•æ…‹å…§å®¹è¼‰å…¥å®¹å™¨ï¼šæ‰€æœ‰å¤–éƒ¨ HTML é é¢å°‡è¼‰å…¥åˆ°é€™è£¡ -->
    <section id="dynamic-content-area" class="section active-section">
        <!-- å¤–éƒ¨ HTML å…§å®¹å°‡è¼‰å…¥åˆ°é€™è£¡ -->
    </section>
</div> <!-- container-fluid çµæŸ -->

    <!-- jQuery & Bootstrap JS -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js" xintegrity="sha512-J/0uB3zIgK1t5OJAA7Js1qntoZ1aI7V3C2aygtlNt9rSAbRRxvKakIDhMKRcX7gs3PEz+XRTS1G0BqT/91Q56A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDK (æ¨¡çµ„ç‰ˆ) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            signInWithEmailAndPassword // é›–ç„¶ login.html è™•ç†ç™»å…¥ï¼Œä½†é€™è£¡ä»éœ€è¦ä»¥é˜²è¬ä¸€æˆ–æœªä¾†æ“´å±•
        } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD9Bt0HwGGwlRT3_CWFBDhjGcnYf5lCuZU",
            authDomain: "goodaymember.firebaseapp.com",
            projectId: "goodaymember",
            storageBucket: "goodaymember.appspot.com",
            messagingSenderId: "730801053598",
            appId: "1:730801053598:web:a2ec0dc91c78fef6bfc08f",
            measurementId: "G-J3Z7YTHJ9P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // âœ… å…¨å±€è®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜ç•¶å‰ç™»å…¥ç”¨æˆ¶çš„ Email
        // å¤–éƒ¨è¼‰å…¥çš„é é¢æœƒä¾è³´é€™å€‹è®Šæ•¸ä¾†ç²å–ç”¨æˆ¶ Email
        window.currentUserEmail = null;

        // âœ… å…¨å±€å‡½æ•¸ï¼Œä¾›å‹•æ…‹è¼‰å…¥çš„ login.html å‘¼å«ä»¥æ›´æ–°ä¸»æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        window.updateMainAppLoginState = function(email) {
            loginEmail = email;
            window.currentUserEmail = email;
            localStorage.setItem("loginEmail", loginEmail); // å¯é¸ï¼šå°‡ Email å­˜å…¥ localStorage
            loadMemberName(loginEmail); // è¼‰å…¥ä¸¦é¡¯ç¤ºæœƒå“¡å§“å
            renderNavTabs(); // é‡æ–°æ¸²æŸ“å°è¦½åˆ—ä»¥é¡¯ç¤ºç™»å…¥å¾Œé¸é …
            showSection("souvenir"); // å°å‘é è¨­ç™»å…¥å¾Œé é¢
            alert("âœ… ç™»å…¥æˆåŠŸï¼"); // ç™»å…¥æˆåŠŸæç¤º
        };

        let loginEmail = null;
        const navMenu = document.getElementById("navMenu");
        // allSections ç¾åœ¨åªåŒ…å« dynamic-content-areaï¼Œä½†æˆ‘å€‘ä»ç”¨å®ƒä¾†æ§åˆ¶é¡¯ç¤º/éš±è—
        const allSections = document.querySelectorAll(".section");

        // ç™»å…¥å‰å°è¦½åˆ—é …ç›® (ç¾åœ¨é€™äº›ä¹Ÿéƒ½æ˜¯å¤–éƒ¨è¼‰å…¥çš„é é¢)
        const tabsBeforeLogin = [
            { id: "souvenir", label: "ç´€å¿µå“" },
            { id: "recommend", label: "æ¨è–¦æ¸…å–®" },
            { id: "notice", label: "æ³¨æ„äº‹é …" },
            { id: "about", label: "é—œæ–¼æˆ‘" },
            { id: "login", label: "ç™»å…¥" } // ç™»å…¥é é¢ä¹Ÿç¨ç«‹äº†
        ];

        // ç™»å…¥å¾Œå°è¦½åˆ—é …ç›® (åŒ…å«ä¸‹æ‹‰é¸å–®)
        const tabsAfterLogin = [
            { id: "souvenir", label: "ç´€å¿µå“" },
            { id: "recommend", label: "æ¨è–¦æ¸…å–®" },
            { id: "notice", label: "æ³¨æ„äº‹é …" },
            { id: "about", label: "é—œæ–¼æˆ‘" },
            { id: "announcement", label: "ğŸ“£ å…¬å‘Šæ¬„" }, // å°æ‡‰ announcement.html
            { id: "delegation-manage", label: "ğŸ“¥ å§”è¨—ç®¡ç†" },     // å°æ‡‰ delegation-manage.html
            { id: "souvenir-manage", label: "ğŸ§¾ ç´€å¿µå“ç®¡ç†" },     // å°æ‡‰ souvenir-manage.html
            {
                id: "account-management-dropdown", // çˆ¶ç´š IDï¼Œç”¨æ–¼ä¸‹æ‹‰é¸å–®çš„æ§åˆ¶
                label: "å¸³æˆ¶ç®¡ç†",
                isDropdown: true, // æ¨™è¨˜ç‚ºä¸‹æ‹‰é¸å–®
                children: [
                    { id: "add-account-shares", label: "ğŸ“Š æ–°å¢å¸³è™Ÿï¼æŒè‚¡" }, // å°æ‡‰ add-account-shares.html
                    { id: "deposit-withdrawal", label: "ğŸ’µ å„²å€¼ / ææ¬¾" },    // å°æ‡‰ deposit-withdrawal.html
                    { id: "account-query", label: "ğŸ” å¸³å‹™æŸ¥è©¢" }         // å°æ‡‰ account-query.html
                ]    
            { id: "logout", label: "ç™»å‡º" }
        ];

        // æ¸²æŸ“å°è¦½åˆ—é¸å–®
        function renderNavTabs() {
            navMenu.innerHTML = "";
            const tabs = loginEmail ? tabsAfterLogin : tabsBeforeLogin;

            // åªæœ‰ç™»å‡ºæŒ‰éˆ•å¯èƒ½éœ€è¦ç‰¹åˆ¥é«˜äº®
            const highlightTabs = ["logout"];

            tabs.forEach(tab => {
                const li = document.createElement("li");
                li.className = "nav-item";

                if (tab.isDropdown) {
                    // ç”Ÿæˆä¸‹æ‹‰é¸å–®çµæ§‹
                    li.className = "nav-item dropdown";
                    li.innerHTML = `
                        <a class="nav-link dropdown-toggle" href="#" id="${tab.id}Link" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            ${tab.label}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="${tab.id}Link">
                            ${tab.children.map(child => `
                                <li><a class="dropdown-item" href="#" data-section="${child.id}">${child.label}</a></li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    // ç”Ÿæˆæ™®é€šå°è¦½é …ç›®
                    const isHighlight = highlightTabs.includes(tab.id);
                    const classList = `nav-link${isHighlight ? " always-highlight" : ""}`;

                    if (tab.link) {
                        li.innerHTML = `<a class="${classList}" href="${tab.link}">${tab.label}</a>`;
                    } else {
                        li.innerHTML = `<a class="${classList}" href="#" data-section="${tab.id}">${tab.label}</a>`;
                    }
                }
                navMenu.appendChild(li);
            });
        }

        // è¼‰å…¥æœƒå“¡å§“å (å¾ Apps Script ç²å–)
        function loadMemberName(email) {
            const loginStatus = document.getElementById("loginStatus");
            if (!email) {
                if (loginStatus) {
                    loginStatus.innerText = "è¨ªå®¢"; // æœªç™»å…¥ç‹€æ…‹
                    loginStatus.classList.remove("text-dark", "fw-bold", "text-danger");
                    loginStatus.classList.add("text-muted");
                }
                return;
            }

            // ç«‹å³é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            if (loginStatus) {
                loginStatus.innerText = "è¼‰å…¥ä¸­...";
                loginStatus.classList.remove("text-dark", "fw-bold", "text-danger");
                loginStatus.classList.add("text-muted");
            }

            // é€™è£¡å‘¼å«æ‚¨çš„ Apps Script å¾Œç«¯ä¾†ç²å–æœƒå“¡åç¨±
            // è«‹æ›¿æ›æˆæ‚¨å¯¦éš›çš„ Apps Script Web App URL (ç”¨æ–¼ç²å–æœƒå“¡è³‡è¨Šçš„é‚£å€‹)
            const APPS_SCRIPT_MEMBER_INFO_URL = "https://script.google.com/macros/s/AKfycbzfj7nkQe1QnKiRedfYKeMBAAKVKAi17b0rEirrgzNd2AcTmgQcVvneIg5IlqQDtWaF/exec"; // æ›¿æ›ç‚ºæ‚¨çš„ relayUrl

            fetch(`${APPS_SCRIPT_MEMBER_INFO_URL}?view=getMemberInfo&email=${encodeURIComponent(email)}`)
                .then(res => {
                    if (!res.ok) throw new Error('ç¶²è·¯å›æ‡‰ä¸ä½³');
                    return res.json();
                })
                .then(info => {
                    const memberName = info.name || "æœªå‘½å";
                    if (loginStatus) {
                        loginStatus.innerText = `æœƒå“¡ï¼š${memberName}`;
                        loginStatus.classList.remove("text-muted", "text-danger");
                        loginStatus.classList.add("text-dark", "fw-bold");
                    }
                })
                .catch(err => {
                    console.error("å–å¾—æœƒå“¡è³‡æ–™å¤±æ•—", err);
                    if (loginStatus) {
                        loginStatus.innerText = "æœƒå“¡ï¼šè¼‰å…¥å¤±æ•—";
                        loginStatus.classList.remove("text-dark", "fw-bold", "text-muted");
                        loginStatus.classList.add("text-danger");
                    }
                });
        }

        // âœ… æ–°å¢è¼‰å…¥å¤–éƒ¨ HTML å…§å®¹çš„å‡½æ•¸
        async function loadExternalHtmlSection(sectionId) {
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            if (!dynamicContentArea) {
                console.error('æ‰¾ä¸åˆ°ç”¨æ–¼è¼‰å…¥å¤–éƒ¨å…§å®¹çš„å®¹å™¨ #dynamic-content-area');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­çš„è¨Šæ¯
            dynamicContentArea.innerHTML = `<h3 class="text-center">è¼‰å…¥ä¸­...</h3><p class="text-center">è«‹ç¨å€™ã€‚</p>`;
            dynamicContentArea.classList.add('active-section'); // ç¢ºä¿å®¹å™¨é¡¯ç¤º

            try {
                // âœ… ä¿®æ­£ï¼šä½¿ç”¨ `/` é–‹é ­ï¼Œç¢ºä¿å¾ç¶²ç«™æ ¹ç›®éŒ„è¼‰å…¥æª”æ¡ˆ
                const response = await fetch(`/${sectionId}.html`); // æ ¹æ“š ID è¼‰å…¥å°æ‡‰çš„ HTML æª”æ¡ˆ
                if (!response.ok) {
                    throw new Error(`è¼‰å…¥ ${sectionId}.html å¤±æ•—ï¼š${response.statusText}`);
                }
                const htmlContent = await response.text();

                dynamicContentArea.innerHTML = htmlContent;

                // æ‰‹å‹•åŸ·è¡Œè¼‰å…¥çš„ HTML ä¸­çš„ <script> æ¨™ç±¤
                // é€™æ˜¯å› ç‚ºç•¶æ‚¨ä½¿ç”¨ innerHTML è¨­ç½®å…§å®¹æ™‚ï¼Œ<script> æ¨™ç±¤ä¸æœƒè‡ªå‹•åŸ·è¡Œ
                const scripts = dynamicContentArea.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    // ç§»é™¤èˆŠçš„ script å…ƒç´ ï¼Œç„¶å¾Œå‰µå»ºä¸€å€‹æ–°çš„ä¸¦è¤‡è£½å…¶å…§å®¹å’Œå±¬æ€§
                    // é€™æ˜¯ç¢ºä¿è…³æœ¬åœ¨å‹•æ…‹è¼‰å…¥å¾Œèƒ½å¤ è¢«æ­£ç¢ºåŸ·è¡Œçš„æ–¹æ³•
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

            } catch (error) {
                console.error('è¼‰å…¥å¤–éƒ¨å…§å®¹éŒ¯èª¤:', error);
                dynamicContentArea.innerHTML = `<h3 class="text-center text-danger">è¼‰å…¥å¤±æ•—</h3><p class="text-center">ç„¡æ³•è¼‰å…¥ ${sectionId} é é¢ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
            }
        }

        // é¡¯ç¤ºæŒ‡å®š Section çš„å‡½æ•¸
        function showSection(id) {
            // éš±è—æ‰€æœ‰ section (ç¾åœ¨åªå‰©ä¸‹ dynamic-content-area)
            const dynamicContentArea = document.getElementById('dynamic-content-area');
            if (dynamicContentArea) {
                dynamicContentArea.classList.remove("active-section");
                dynamicContentArea.innerHTML = ''; // æ¸…ç©ºå…§å®¹
            }

            // ç™»å‡ºæ˜¯ç‰¹æ®Šæƒ…æ³ï¼Œä¸è¼‰å…¥å¤–éƒ¨é é¢
            if (id === "logout") {
                // ç™»å‡ºé‚è¼¯åœ¨ navMenu.addEventListener ä¸­è™•ç†
                return;
            }

            // è¼‰å…¥å¤–éƒ¨ HTML å…§å®¹åˆ° dynamic-content-area
            loadExternalHtmlSection(id);

            // æ›´æ–°å°è¦½åˆ—æ´»èºç‹€æ…‹
            // âœ… é€™è£¡ä¿®æ­£äº†é¸æ“‡å™¨ï¼Œä½¿å…¶ä¹Ÿèƒ½åŒ¹é…ä¸‹æ‹‰é¸å–®ä¸­çš„é …ç›®
            document.querySelectorAll('.nav-link, .dropdown-item').forEach(link => {
                link.classList.remove('active');
            });

            const activeNavLink = document.querySelector(`.nav-link[data-section="${id}"], .dropdown-item[data-section="${id}"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
                // å¦‚æœé»æ“Šçš„æ˜¯ä¸‹æ‹‰é¸å–®å…§çš„é …ç›®ï¼Œç¢ºä¿çˆ¶ç´šçš„ä¸‹æ‹‰æŒ‰éˆ•ä¹Ÿé¡¯ç¤ºæ´»èºç‹€æ…‹
                const parentDropdownToggle = activeNavLink.closest('.dropdown')?.querySelector('.dropdown-toggle');
                if (parentDropdownToggle) {
                    parentDropdownToggle.classList.add('active');
                }
            }

            // éš±è—å°è¦½åˆ— (é‡å°æ‰‹æ©Ÿç‰ˆå±•é–‹å¾Œé»æ“Šè‡ªå‹•æ”¶èµ·)
            const navbarCollapse = document.getElementById('navbarNav');
            const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
            if (bsCollapse && navbarCollapse.classList.contains('show')) {
                bsCollapse.hide();
            }
        }

        // ç™»å…¥è¡¨å–®æäº¤äº‹ä»¶è™•ç† (å·²å¾é€™è£¡ç§»é™¤ï¼Œç¾åœ¨ç”± login.html è™•ç†)
        // document.getElementById("loginForm").addEventListener("submit", function (e) { ... });

        // å°è¦½åˆ—é»æ“Šäº‹ä»¶è™•ç†
        navMenu.addEventListener("click", function (e) {
            // âœ… é€™è£¡ä¿®æ­£äº†é¸æ“‡å™¨ï¼Œä½¿å…¶ä¹Ÿèƒ½åŒ¹é…ä¸‹æ‹‰é¸å–®ä¸­çš„é …ç›®
            const clickedNavLink = e.target.closest(".nav-link[data-section], .dropdown-item[data-section]");
            if (clickedNavLink) {
                e.preventDefault();
                const id = clickedNavLink.getAttribute("data-section");
                if (id === "logout") {
                    signOut(auth).then(() => {
                        console.log("ç”¨æˆ¶å·²ç™»å‡º");
                        loginEmail = null;
                        window.currentUserEmail = null; // âœ… æ¸…é™¤å…¨å±€è®Šæ•¸
                        renderNavTabs();
                        showSection("souvenir"); // ç™»å‡ºå¾Œå›åˆ°ç´€å¿µå“é é¢
                        // ç™»å‡ºå¾Œï¼Œæ¸…ç©ºå‹•æ…‹å…§å®¹å€å¡Š
                        const dynamicContentArea = document.getElementById('dynamic-content-area');
                        if (dynamicContentArea) {
                            dynamicContentArea.innerHTML = '';
                            dynamicContentArea.classList.remove('active-section');
                        }
                    }).catch((error) => {
                        console.error("ç™»å‡ºå¤±æ•—:", error);
                    });
                } else {
                    showSection(id);
                }
            }
        });

        // é é¢é¦–æ¬¡è¼‰å…¥åŠ Firebase èªè­‰ç‹€æ…‹ç›£è½
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                loginEmail = user ? user.email : null;
                window.currentUserEmail = loginEmail; // è¨­å®šå…¨å±€è®Šæ•¸
                console.log(loginEmail ? "âœ… å·²ç™»å…¥ï¼š" + loginEmail : "âš ï¸ å°šæœªç™»å…¥");

                loadMemberName(loginEmail); // è¼‰å…¥æœƒå“¡åç¨±
                renderNavTabs(); // æ¸²æŸ“å°è¦½åˆ—

                // è™•ç† URL åƒæ•¸ï¼Œå¦‚æœ URL ä¸­æœ‰ ?view=xxx å‰‡é¡¯ç¤ºå°æ‡‰é é¢
                const urlParams = new URLSearchParams(window.location.search);
                const view = urlParams.get("view");
                if (view) { // å¦‚æœæœ‰ view åƒæ•¸ï¼Œå°±è¼‰å…¥å°æ‡‰çš„é é¢
                    showSection(view);
                } else { // å¦å‰‡é è¨­é¡¯ç¤ºç´€å¿µå“é é¢
                    showSection("souvenir");
                }
            });
        });

        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œèª¿æ•´ DataTables åˆ—å¯¬ (å¦‚æœæœªä¾†ä½¿ç”¨ DataTables)
        // æ³¨æ„ï¼šé€™è£¡çš„ DataTables ç›¸é—œé‚è¼¯ï¼Œå¦‚æœ `souvenir.html` å’Œ `recommend.html` å…§éƒ¨æœ‰ç”¨åˆ° jQuery DataTablesï¼Œ
        // å‰‡éœ€è¦ç¢ºä¿ DataTables åº«åœ¨é€™äº›é é¢è¼‰å…¥æ™‚å¯ç”¨ã€‚
        // ç”±æ–¼æ‚¨åœ¨ index.html è¼‰å…¥äº† jQuery å’Œ DataTables CDNï¼Œå®ƒå€‘æ˜¯å…¨å±€å¯ç”¨çš„ã€‚
        $(window).on('resize', function () {
            setTimeout(function() {
                if ($.fn.dataTable && $.fn.dataTable.tables(true).length) { // æª¢æŸ¥ $.fn.dataTable æ˜¯å¦å­˜åœ¨
                    $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
                }
            }, 100);
        });
    </script>
</body>
</html>
