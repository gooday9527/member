<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ¨è–¦æ¸…å–®</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ç‚ºé é¢å¢åŠ ä¸€äº›é‚Šè· */
        body {
            padding: 1.5rem;
        }
    </style>
</head>
<body>

    <div class="recommend-wrapper">
        <h3 class="text-center mb-4">ğŸŒŸ æ¨è–¦æ¸…å–®</h3>
        <div class="d-flex align-items-center gap-2 recommend-controls mb-3">
            <label for="recommendSheet" class="form-label mb-0">é¸æ“‡åˆ†é¡ï¼š</label>
            <select id="recommendSheet" class="form-select form-select-sm" style="max-width: 200px;">
                <option>åˆ†é¡è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm" id="recommendTable">
                <thead class="table-warning"></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // âœ…ã€è«‹å¡«å¯«é€™è£¡ã€‘è«‹å°‡å¼•è™Ÿå…§çš„æ–‡å­—ï¼Œæ›æˆæ‚¨ã€Œæ¨è–¦æ¸…å–®å¾Œç«¯ã€çš„éƒ¨ç½²ç¶²å€
        const RECOMMEND_BACKEND_URL = "https://script.google.com/macros/s/AKfycbzdoezSaX2ujsE5ejjac3HbZWWHhDKQbX0nN1rVTIPSZm7opdCtslmwPAIq6zBNvcTp/exec";

        // JSONP æ ¸å¿ƒå‡½æ•¸ï¼šå‹•æ…‹å»ºç«‹ script æ¨™ç±¤ä¾†è«‹æ±‚è³‡æ–™
        function jsonpRequest(url, callback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(null, data);
            };

            const script = document.createElement('script');
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
            
            script.onerror = function() {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(new Error('JSONP request failed. Check browser console for more details.'));
            };

            document.body.appendChild(script);
        }

        // å‡½æ•¸ï¼šè¼‰å…¥æ¨è–¦è³‡æ–™
        function loadRecommendData(sheetName) {
            const tableElement = document.getElementById('recommendTable');
            if (!tableElement || !sheetName) return;
            const thead = tableElement.querySelector('thead');
            const tbody = tableElement.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = `<tr><td colspan="100%">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;

            const url = `${RECOMMEND_BACKEND_URL}?action=getRecommendations&sheetName=${encodeURIComponent(sheetName)}`;
            jsonpRequest(url, (error, result) => {
                if (error) {
                    console.error('è¼‰å…¥æ¨è–¦è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
                    return;
                }
                if (result.status === 'error') {
                    tbody.innerHTML = `<tr><td colspan="100%" class="text-danger">å¾Œç«¯éŒ¯èª¤: ${result.data.message}</td></tr>`;
                    return;
                }
                const data = result.data.data;
                tbody.innerHTML = ''; 
                if (data && data.length > 0) {
                    const headers = Object.keys(data[0]);
                    thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                    tbody.innerHTML = data.map(row => `<tr>${headers.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="100%">æ²’æœ‰å¯ç”¨çš„è³‡æ–™</td></tr>';
                }
            });
        }

        // å‡½æ•¸ï¼šåˆå§‹åŒ–é é¢
        function initializeRecommendPage() {
            const selectElement = document.getElementById('recommendSheet');
            if (!selectElement) return;
            selectElement.disabled = true;
            selectElement.innerHTML = '<option>åˆ†é¡è¼‰å…¥ä¸­...</option>';

            const url = `${RECOMMEND_BACKEND_URL}?action=getRecommendationCategories`;
            jsonpRequest(url, (error, result) => {
                if (error) {
                    console.error('è¼‰å…¥åˆ†é¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    selectElement.innerHTML = `<option>åˆ†é¡è¼‰å…¥å¤±æ•—</option>`;
                    return;
                }
                if (result.status === 'error') {
                    selectElement.innerHTML = `<option>å¾Œç«¯éŒ¯èª¤</option>`;
                    return;
                }
                const categories = result.data.categories;
                selectElement.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    selectElement.appendChild(option);
                });
                selectElement.disabled = false;
                selectElement.addEventListener('change', function () { loadRecommendData(this.value); });
                if (categories.length > 0) { loadRecommendData(categories[0]); }
            });
        }

        // ç•¶é é¢ DOM è¼‰å…¥å®Œæˆå¾Œï¼Œå°±åŸ·è¡Œåˆå§‹åŒ–å‡½æ•¸
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeRecommendPage);
        } else {
            initializeRecommendPage();
        }
    </script>

</body>
</html>
