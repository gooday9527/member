<div class="souvenir-wrapper pt-2 pb-2 pt-md-0 pb-md-0">
    <div class="d-block d-md-flex align-items-center gap-3 mb-2 mb-md-0 px-3" id="delegableControlsContainer">
        <div class="me-3"><h3 class="mt-1 mb-1 mb-md-0" style="white-space: nowrap;">ğŸ“¥ å¯å§”è¨—æ¸…å–®</h3></div>
        <div class="d-flex align-items-center gap-2 flex-nowrap w-100 w-md-auto justify-content-start">
            <div class="d-flex align-items-center">
                <label for="delegRowsPerPage" class="form-label mb-0 me-1">ç­†æ•¸:</label>
                <select id="delegRowsPerPage" class="form-select form-select-sm" style="width: 80px;"><option>10</option><option>25</option><option>50</option><option>100</option></select>
            </div>
            <div class="d-flex align-items-center">
                <label for="delegSearchInput" class="form-label mb-0 me-1">æœå°‹:</label>
                <input type="text" id="delegSearchInput" class="form-control form-control-sm" style="width: 150px;" placeholder="é—œéµå­—...">
            </div>
        </div>
    </div>
    <div class="table-scroll-container table-responsive">
        <table class="table table-bordered table-sm" id="delegableListTable">
            <thead class="table-warning"></thead>
            <tbody><tr><td colspan="7" class="text-center p-4">è³‡æ–™è¼‰å…¥ä¸­...</td></tr></tbody>
        </table>
    </div>
    <div id="delegablePaginationWrapper" class="mt-2">
        <div id="delegablePagination" class="d-flex justify-content-center flex-wrap"></div>
    </div>
</div>
<div class="modal fade" id="detailsModal"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec';
    const email = window.currentUserEmail;
    if (!email) { /* ... ç™»å…¥æª¢æŸ¥ ... */ return; }

    let rawData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
    let sortKey = 'delegationDeadline', sortAsc = true;
    let appSettings = { isDelegationAcquisitionEnabled: true };
    let detailsModal;

    const columnConfig = [
        { key: 'stockCode',            title: 'è‚¡è™Ÿ' },
        { key: 'stockName',            title: 'è‚¡å' },
        { key: 'eVotingStartDate',     title: 'é›»æŠ•é–‹å§‹æ—¥' },
        { key: 'delegationDeadline',   title: 'å§”è¨—æˆªæ­¢æ—¥' },
        { key: 'delegationConditions', title: 'å§”è¨—æ¢ä»¶' },
        { key: 'totalHoldingAccounts', title: 'æŒæœ‰å¸³è™Ÿæ•¸' },
        { key: 'delegatedAccounts',    title: 'å·²å§”è¨—æ•¸' }
    ];

    const tblHead = document.querySelector('#delegableListTable thead');
    const tblBody = document.querySelector('#delegableListTable tbody');
    const ctrlRows = document.getElementById('delegRowsPerPage');
    const ctrlSearch = document.getElementById('delegSearchInput');
    const pagContainer = document.getElementById('delegablePagination');
    const modalTitle = document.getElementById('modalCompanyName');
    const modalBody = document.getElementById('modalTableBody');

    ctrlRows.addEventListener('change', ()=>{ rowsPerPage = +ctrlRows.value; currentPage = 1; renderTable(); });
    ctrlSearch.addEventListener('input', ()=>{ currentPage = 1; filterData(); renderTable(); });
    
    const apiUrl = `${WEB_APP_URL}?view=getDelegableList&email=${encodeURIComponent(email)}`;

    fetch(apiUrl)
        .then(response => response.ok ? response.json() : Promise.reject('ç¶²è·¯å›æ‡‰éŒ¯èª¤'))
        .then(response => {
            if (!response.success || !response.data) throw new Error(response.message || 'å¾Œç«¯å›å‚³è³‡æ–™æ ¼å¼ä¸ç¬¦');
            
            rawData = response.data || [];
            appSettings = response.appSettings || appSettings;
            
            // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå…ˆæ¸²æŸ“è¡¨é ­ï¼Œå†é€²è¡Œæ’åºå’Œæ¸²æŸ“è¡¨æ ¼
            renderHeader(); 
            sortTable(sortKey); // åˆå§‹æ’åº
        })
        .catch(err => { 
            console.error('API å‘¼å«å¤±æ•—:', err);
            tblBody.innerHTML=`<tr><td colspan="7" class="text-center text-danger p-4">è³‡æ–™è¼‰å…¥å¤±æ•—</td></tr>`; 
        });

    // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘æ’åºå‡½å¼
    function sortTable(key) {
        sortAsc = (sortKey === key) ? !sortAsc : true;
        sortKey = key;
        
        rawData.sort((a,b) => {
            const valA = a[key] || '', valB = b[key] || '';
            const isNumeric = /^-?\d+(\.\d+)?$/.test(String(valA).trim()) && /^-?\d+(\.\d+)?$/.test(String(valB).trim());
            if (isNumeric) return sortAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
            return sortAsc ? String(valA).localeCompare(valB, 'zh-Hant') : String(valB).localeCompare(valA, 'zh-Hant');
        });
        
        filterData(); // æ’åºå¾Œé‡æ–°ç¯©é¸
        renderTable(); // ç¯©é¸å¾Œé‡æ–°æ¸²æŸ“
    }

    function filterData() {
        const keyword = ctrlSearch.value.trim().toLowerCase();
        filteredData = keyword ? rawData.filter(r => columnConfig.some(c => String(r[c.key]||'').toLowerCase().includes(keyword))) : [...rawData];
    }

    // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘æ¸²æŸ“è¡¨é ­èˆ‡ç¶å®šäº‹ä»¶çš„å‡½å¼
    function renderHeader() {
        tblHead.innerHTML = '<tr>' + columnConfig.map(c => `<th class="sortable" data-key="${c.key}" style="cursor:pointer;white-space:nowrap">${c.title}<span></span></th>`).join('') + '</tr>';
        tblHead.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => sortTable(th.dataset.key)));
    }
    
    // âœ… ã€æ¡ç”¨æ–°å¯«æ³•ã€‘æ¸²æŸ“è¡¨æ ¼ä¸»é«”ï¼ˆåŒ…å«æ›´æ–°æ’åºæŒ‡ç¤ºå™¨ï¼‰
    function renderTable() {
        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        tblHead.querySelectorAll('th.sortable span').forEach(s => s.textContent = '');
        const sortIndicator = tblHead.querySelector(`th[data-key="${sortKey}"] span`);
        if (sortIndicator) sortIndicator.textContent = sortAsc ? ' â–²' : ' â–¼';

        const start = (currentPage - 1) * rowsPerPage;
        const pageData = filteredData.slice(start, start + rowsPerPage);

        tblBody.innerHTML = pageData.length ? pageData.map(row => {
            const cells = columnConfig.map(c => {
                let value = row[c.key] ?? '';
                let className = ['totalHoldingAccounts', 'delegatedAccounts'].includes(c.key) ? 'text-center' : '';
                if (c.key === 'totalHoldingAccounts' && value > 0) {
                    return `<td class="${className}"><button class="btn btn-sm btn-outline-primary view-details-btn">${value}</button></td>`;
                }
                return `<td class="${className}">${value}</td>`;
            }).join('');
            return `<tr data-row-details='${JSON.stringify(row)}'>${cells}</tr>`;
        }).join('') : `<tr><td colspan="${columnConfig.length}" class="text-center p-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;

        tblBody.querySelectorAll('.view-details-btn').forEach(btn => btn.addEventListener('click', e => showDetailsModal(JSON.parse(e.currentTarget.closest('tr').dataset.rowDetails))));
        renderPagination();
    }

    // åˆ†é èˆ‡ Modal é‚è¼¯ (ç¶­æŒä¸è®Š)
    function renderPagination() { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
    function showDetailsModal(rowData) { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
    document.getElementById('detailsModal').addEventListener('click', e => { /* ... æ­¤äº‹ä»¶ç›£è½ä¸è®Š ... */ });
    window.delegableTable = { /* ... æ­¤æ›è¼‰ä¸è®Š ... */ };

})();
</script>
