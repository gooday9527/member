<div class="container-fluid mt-2">
    <h3 class="mb-2">ğŸ“¥ å¯å§”è¨—ä»£é ˜æ¸…å–®</h3>
    <p class="text-muted">é€™è£¡æœƒåˆ—å‡ºæ‰€æœ‰æ‚¨å¯ä»¥å§”è¨—æˆ‘å€‘ä»£é ˜çš„è‚¡æ±æœƒç´€å¿µå“ã€‚</p>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div id="table-controls" class="mb-2"></div>
            <div class="table-responsive">
                <table id="delegableTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        </thead>
                    <tbody>
                        <tr><td colspan="7" class="text-center p-4">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">æŒæœ‰å¸³è™Ÿæ˜ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>å…¬å¸ï¼š</strong><span id="modalCompanyName" class="fw-bold"></span></p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>å§“å</th>
                        <th>è­‰ä»¶ç‹€æ…‹</th>
                        <th class="text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="modalTableBody"></tbody>
            </table>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
(function() {
    // --- è¨­å®š ---
    // â€¼ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡çš„ç¶²å€æ˜¯æ‚¨è‡ªå·±çš„å¾Œç«¯éƒ¨ç½²ç¶²å€
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwFSVsZNUeuQXiJ9cU-KSBCg1ZZLVRs-urxiwdQVHt3n_9DJBBvWLZ1Mez0pExtM04Q/exec";
    const userEmail = window.currentUserEmail;

    // --- DOM å…ƒç´  ---
    const tableElement = document.getElementById('delegableTable');
    const tableHead = tableElement.querySelector('thead');
    const tableBody = tableElement.querySelector('tbody');
    const modalElement = document.getElementById('detailsModal');
    const modalInstance = new bootstrap.Modal(modalElement);
    const modalCompanyName = document.getElementById('modalCompanyName');
    const modalTableBody = document.getElementById('modalTableBody');

    // --- ç‹€æ…‹è®Šæ•¸ ---
    let originalData = []; // å­˜æ”¾å¾å¾Œç«¯ç²å–çš„åŸå§‹è³‡æ–™
    let displayData = [];  // å­˜æ”¾ç¶“éç¯©é¸å’Œæ’åºå¾Œè¦é¡¯ç¤ºçš„è³‡æ–™
    
    // --- å¾Œç«¯é€šè¨Š ---
    async function fetchDataFromBackend(action, payload = {}) {
        if (!userEmail) throw new Error("ç„¡æ³•ç²å–ç™»å…¥ç‹€æ…‹ï¼Œè«‹é‡æ–°æ•´ç†æˆ–ç™»å…¥ã€‚");
        const fullPayload = { action, email: userEmail, ...payload };
        const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
            method: 'POST', body: JSON.stringify(fullPayload), headers: { 'Content-Type': 'application/json' }
        });
        if (!response.ok) throw new Error(`ç¶²è·¯éŒ¯èª¤: ${response.statusText}`);
        const result = await response.json();
        if (!result.success) throw new Error(result.data.message || "å¾Œç«¯è™•ç†æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤");
        return result.data;
    }

    // --- æ¸²æŸ“è¡¨æ ¼ ---
    function renderTable() {
        tableBody.innerHTML = ""; // æ¸…ç©ºèˆŠè³‡æ–™
        if (displayData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
            return;
        }

        const fragment = document.createDocumentFragment();
        displayData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.stockCode || ''}</td>
                <td>${row.stockName || ''}</td>
                <td>${row.eVotingStartDate || '-'}</td>
                <td>${row.delegationDeadline || '-'}</td>
                <td>${row.delegationConditions || ''}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary view-details-btn"
                            data-stock-code="${row.stockCode}">
                        ${row.totalHoldingAccounts}
                    </button>
                </td>
                <td class="text-center">${row.delegatedAccounts}</td>
            `;
            fragment.appendChild(tr);
        });
        tableBody.appendChild(fragment);
    }

    // --- åˆå§‹åŒ– ---
    async function initialize() {
        if (!userEmail) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center alert alert-danger">è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ‚¨çš„å§”è¨—æ¸…å–®ã€‚</td></tr>';
            return;
        }
        
        try {
            originalData = await fetchDataFromBackend("getDelegableList");
            displayData = [...originalData]; // åˆå§‹é¡¯ç¤ºæ‰€æœ‰è³‡æ–™
            
            // å»ºç«‹è¡¨é ­
            tableHead.innerHTML = `
                <tr>
                    <th>è‚¡è™Ÿ</th>
                    <th>è‚¡å</th>
                    <th>é›»æŠ•é–‹å§‹æ—¥</th>
                    <th>å§”è¨—æˆªæ­¢æ—¥</th>
                    <th>å§”è¨—æ¢ä»¶</th>
                    <th class="text-center">æŒæœ‰å¸³è™Ÿæ•¸</th>
                    <th class="text-center">å·²å§”è¨—æ•¸</th>
                </tr>
            `;
            renderTable();

        } catch (error) {
            console.error("è¼‰å…¥å¯å§”è¨—æ¸…å–®å¤±æ•—:", error);
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center alert alert-danger">${error.message}</td></tr>`;
        }
    }

    // --- äº‹ä»¶ç›£è½ ---
    
    // é»æ“Šã€ŒæŒæœ‰å¸³è™Ÿæ•¸ã€æŒ‰éˆ•ï¼Œæ‰“é–‹ Modal
    tableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('view-details-btn')) {
            const button = e.target;
            const stockCode = button.dataset.stockCode;
            const rowData = originalData.find(d => d.stockCode === stockCode);
            if (!rowData) return;

            modalCompanyName.textContent = `${rowData.stockName} (${rowData.stockCode})`;
            modalTableBody.innerHTML = ""; // æ¸…ç©ºèˆŠå…§å®¹
            
            rowData.holdingsDetail.forEach(account => {
                let actionHtml = '';
                const docType = String(account.documentType || '').trim();
                const isDocMatch = rowData.delegationConditions.includes("èº«åˆ†è­‰") ? docType === "èº«åˆ†è­‰" : true;

                if (account.delegationStatus === 'å·²å§”è¨—') {
                    actionHtml = `<span class="badge bg-success">å·²å§”è¨—</span>`;
                } else if (account.delegationStatus === 'å·²æ”¶è³¼') {
                    actionHtml = `<span class="badge bg-info">å·²æ”¶è³¼</span>`;
                } else if (!isDocMatch) {
                    actionHtml = `<span class="badge bg-danger">è­‰ä»¶ä¸ç¬¦</span>`;
                } else {
                    actionHtml = `
                        <button class="btn btn-primary btn-sm action-btn" data-status="å·²å§”è¨—" data-account-name="${account.accountName}" data-stock-code="${stockCode}">æˆ‘è¦å§”è¨—</button>
                        <button class="btn btn-info btn-sm action-btn ms-1" data-status="å·²æ”¶è³¼" data-account-name="${account.accountName}" data-stock-code="${stockCode}">æˆ‘è¦æ”¶è³¼</button>
                    `;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${account.accountName}</td>
                    <td>${docType || 'æœªæä¾›'}</td>
                    <td class="text-center">${actionHtml}</td>
                `;
                modalTableBody.appendChild(tr);
            });
            modalInstance.show();
        }
    });

    // ç›£è½ Modal å…§éƒ¨ã€Œæ“ä½œæŒ‰éˆ•ã€çš„é»æ“Šäº‹ä»¶
    modalElement.addEventListener('click', async function(e) {
        if (e.target.classList.contains('action-btn')) {
            const btn = e.target;
            const newStatus = btn.dataset.status;
            const accountName = btn.dataset.accountName;
            const stockCode = btn.dataset.stockCode;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const result = await fetchDataFromBackend("updateDelegationStatus", { 
                    subAccountName: accountName, 
                    stockCode: stockCode, 
                    newStatus: newStatus 
                });
                modalInstance.hide();
                alert(result.message);
                initialize(); // æ“ä½œæˆåŠŸå¾Œï¼Œé‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™ä»¥æ›´æ–°ä¸»ç•«é¢
            } catch (error) {
                alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
                btn.disabled = false;
                btn.textContent = newStatus === 'å·²å§”è¨—' ? 'æˆ‘è¦å§”è¨—' : 'æˆ‘è¦æ”¶è³¼';
            }
        }
    });

    // --- å•Ÿå‹•é é¢ ---
    initialize();
})();
</script>
